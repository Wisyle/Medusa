{% extends "base.html" %}

{% block title %}Account Settings - TGL MEDUSA{% endblock %}

{% block content %}
<div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
    <h1 class="h2">
        <i class="fas fa-user-cog crypto-icon"></i>
        Account Settings
    </h1>
</div>

<div class="row">
    <!-- Profile Information -->
    <div class="col-md-6">
        <div class="card mb-4">
            <div class="card-header">
                <h5 class="mb-0">
                    <i class="fas fa-user"></i>
                    Profile Information
                </h5>
            </div>
            <div class="card-body">
                <form id="profileForm">
                    <div class="mb-3">
                        <label for="email" class="form-label">Email</label>
                        <input type="email" class="form-control" id="email" readonly>
                        <small class="text-white-50">Email cannot be changed</small>
                    </div>
                    <div class="mb-3">
                        <label for="full_name" class="form-label">Full Name</label>
                        <input type="text" class="form-control" id="full_name" placeholder="Enter your full name">
                    </div>
                    <button type="submit" class="btn btn-primary">
                        <i class="fas fa-save"></i>
                        Update Profile
                    </button>
                </form>
            </div>
        </div>
    </div>

    <!-- Change Password -->
    <div class="col-md-6">
        <div class="card mb-4">
            <div class="card-header">
                <h5 class="mb-0">
                    <i class="fas fa-lock"></i>
                    Change Password
                </h5>
            </div>
            <div class="card-body">
                <form id="passwordForm">
                    <div class="mb-3">
                        <label for="current_password" class="form-label">Current Password</label>
                        <input type="password" class="form-control" id="current_password" required>
                    </div>
                    <div class="mb-3">
                        <label for="new_password" class="form-label">New Password</label>
                        <input type="password" class="form-control" id="new_password" required minlength="8">
                        <small class="text-white-50">Minimum 8 characters</small>
                    </div>
                    <div class="mb-3">
                        <label for="confirm_password" class="form-label">Confirm New Password</label>
                        <input type="password" class="form-control" id="confirm_password" required>
                    </div>
                    <button type="submit" class="btn btn-primary">
                        <i class="fas fa-key"></i>
                        Change Password
                    </button>
                </form>
            </div>
        </div>
    </div>
</div>

<div class="row">
    <!-- Two-Factor Authentication -->
    <div class="col-md-12">
        <div class="card mb-4">
            <div class="card-header">
                <h5 class="mb-0">
                    <i class="fas fa-shield-alt"></i>
                    Two-Factor Authentication (2FA)
                </h5>
            </div>
            <div class="card-body">
                {% raw %}
                <div id="twofa-status-loading" class="text-center">
                    <i class="fas fa-spinner fa-spin"></i> Loading 2FA status...
                </div>
                <div id="twofa-enabled" style="display: none;">
                {% endraw %}
                <div class="row">
                    <div class="col-md-8">
                        <div class="alert alert-success" role="alert">
                            <i class="fas fa-check-circle"></i>
                            <strong>2FA is enabled</strong> - Your account is protected with two-factor authentication.
                        </div>
                        <p class="text-white-50 mb-3">
                            Two-factor authentication adds an extra layer of security to your account. 
                            Keep your authenticator app handy for login.
                        </p>
                        <button type="button" class="btn btn-outline-danger" id="disable2FABtn">
                            <i class="fas fa-times"></i>
                            Disable 2FA
                        </button>
                    </div>
                    <div class="col-md-4 text-center">
                        <i class="fas fa-shield-alt text-success" style="font-size: 4rem;"></i>
                        <p class="mt-2 text-success"><strong>Protected</strong></p>
                    </div>
                </div>
                {% raw %}
                </div>
                <div id="twofa-disabled" style="display: none;">
                {% endraw %}
                <div class="row">
                    <div class="col-md-8">
                        <div class="alert alert-warning" role="alert">
                            <i class="fas fa-exclamation-triangle"></i>
                            <strong>2FA is not enabled</strong> - Your account could be more secure.
                        </div>
                        <p class="text-white-50 mb-3">
                            Enable two-factor authentication to add an extra layer of security to your account.
                            You'll need an authenticator app like Google Authenticator or Authy.
                        </p>
                        <button type="button" class="btn btn-primary" id="enable2FABtn">
                            <i class="fas fa-shield-alt"></i>
                            Enable 2FA
                        </button>
                    </div>
                    <div class="col-md-4 text-center">
                        <i class="fas fa-shield-alt text-warning" style="font-size: 4rem;"></i>
                        <p class="mt-2 text-warning"><strong>Not Protected</strong></p>
                    </div>
                </div>
                {% raw %}
                </div>
                {% endraw %}
            </div>
        </div>
    </div>
</div>

<!-- 2FA Setup Modal -->
<div class="modal fade" id="setup2FAModal" tabindex="-1" aria-labelledby="setup2FAModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content bg-dark border-secondary">
            <div class="modal-header border-secondary">
                <h5 class="modal-title" id="setup2FAModalLabel">
                    <i class="fas fa-shield-alt"></i>
                    Set up Two-Factor Authentication
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div id="qr-step">
                    <h6>Step 1: Scan QR Code</h6>
                    <p class="text-white-50">Use your authenticator app to scan this QR code:</p>
                    <div class="text-center mb-3">
                        <div id="qrcode-container"></div>
                    </div>
                    <p class="text-white-50 small">
                        <strong>Manual Entry:</strong> If you can't scan the QR code, enter this secret key manually:
                        <br><code id="manual-secret" class="text-info"></code>
                    </p>
                </div>
                <div id="verify-step" style="display: none;">
                    <h6>Step 2: Verify Setup</h6>
                    <p class="text-white-50">Enter the 6-digit code from your authenticator app:</p>
                    <form id="verify2FAForm">
                        <div class="mb-3">
                            <label for="totp_code" class="form-label">Verification Code</label>
                            <input type="text" class="form-control text-center" id="totp_code" maxlength="6" pattern="[0-9]{6}" required>
                        </div>
                        <button type="submit" class="btn btn-primary">
                            <i class="fas fa-check"></i>
                            Verify and Enable 2FA
                        </button>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Disable 2FA Modal -->
<div class="modal fade" id="disable2FAModal" tabindex="-1" aria-labelledby="disable2FAModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content bg-dark border-secondary">
            <div class="modal-header border-secondary">
                <h5 class="modal-title" id="disable2FAModalLabel">
                    <i class="fas fa-exclamation-triangle text-warning"></i>
                    Disable Two-Factor Authentication
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="alert alert-warning" role="alert">
                    <strong>Warning:</strong> Disabling 2FA will reduce your account security.
                </div>
                <p>Enter your current password and a verification code from your authenticator app to disable 2FA:</p>
                <form id="disable2FAForm">
                    <div class="mb-3">
                        <label for="disable_password" class="form-label">Current Password</label>
                        <input type="password" class="form-control" id="disable_password" required>
                    </div>
                    <div class="mb-3">
                        <label for="disable_totp" class="form-label">Verification Code</label>
                        <input type="text" class="form-control text-center" id="disable_totp" maxlength="6" pattern="[0-9]{6}" required>
                    </div>
                    <div class="d-flex justify-content-end">
                        <button type="button" class="btn btn-secondary me-2" data-bs-dismiss="modal">Cancel</button>
                        <button type="submit" class="btn btn-danger">
                            <i class="fas fa-times"></i>
                            Disable 2FA
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script src="https://cdnjs.cloudflare.com/ajax/libs/qrcode-generator/1.4.4/qrcode.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/qrcode@1.5.3/build/qrcode.min.js"></script>
<script>
// Load user profile data
function loadUserProfile() {
    fetch('/api/user/profile', {
        method: 'GET',
        headers: {
            'Authorization': 'Bearer ' + localStorage.getItem('token')
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.error) {
            showAlert('danger', 'Failed to load profile: ' + data.error);
        } else {
            $('#email').val(data.email);
            $('#full_name').val(data.full_name || '');
        }
    })
    .catch(error => {
        console.error('Error loading profile:', error);
        showAlert('danger', 'Failed to load profile data');
    });
}

// Generate QR code with fallback
function generateQRCode(data) {
    const qrContainer = $('#qrcode-container');
    
    if (typeof QRCode !== 'undefined') {
        // Use QRCode library
        QRCode.toCanvas(document.createElement('canvas'), data.qr_url, function (error, canvas) {
            if (error) {
                console.error('QRCode library error:', error);
                generateQRCodeFallback(data);
                return;
            }
            
            qrContainer.empty().append(canvas);
            $('#manual-secret').text(data.secret);
            $('#setup2FAModal').modal('show');
        });
    } else {
        // Use fallback method
        generateQRCodeFallback(data);
    }
}

// Fallback QR code generation using online service
function generateQRCodeFallback(data) {
    const qrContainer = $('#qrcode-container');
    const qrUrl = `https://api.qrserver.com/v1/create-qr-code/?size=200x200&data=${encodeURIComponent(data.qr_url)}`;
    
    const img = $('<img>')
        .attr('src', qrUrl)
        .attr('alt', 'QR Code')
        .addClass('img-fluid')
        .on('error', function() {
            qrContainer.html('<div class="alert alert-warning">QR code could not be generated. Please use manual entry below.</div>');
        });
    
    qrContainer.empty().append(img);
    $('#manual-secret').text(data.secret);
    $('#setup2FAModal').modal('show');
}

// Load 2FA status
function load2FAStatus() {
    fetch('/api/user/2fa/status', {
        method: 'GET',
        headers: {
            'Authorization': 'Bearer ' + localStorage.getItem('token')
        }
    })
    .then(response => response.json())
    .then(data => {
        $('#twofa-status-loading').hide();
        if (data.totp_enabled) {
            $('#twofa-enabled').show();
        } else {
            $('#twofa-disabled').show();
        }
    })
    .catch(error => {
        console.error('Error loading 2FA status:', error);
        $('#twofa-status-loading').hide();
        showAlert('danger', 'Failed to load 2FA status');
    });
}

$(document).ready(function() {
    // Load user profile data
    loadUserProfile();
    
    // Load 2FA status
    load2FAStatus();
    
    // Profile form submission
    $('#profileForm').on('submit', function(e) {
        e.preventDefault();
        
        const formData = new FormData();
        formData.append('full_name', $('#full_name').val());
        
        fetch('/api/user/profile', {
            method: 'POST',
            headers: {
                'Authorization': 'Bearer ' + localStorage.getItem('token')
            },
            body: formData
        })
        .then(response => response.json())
        .then(data => {
            if (data.error) {
                showAlert('danger', data.error);
            } else {
                showAlert('success', 'Profile updated successfully!');
            }
        })
        .catch(error => {
            showAlert('danger', 'Failed to update profile: ' + error.message);
        });
    });
    
    // Password change form
    $('#passwordForm').on('submit', function(e) {
        e.preventDefault();
        
        const newPassword = $('#new_password').val();
        const confirmPassword = $('#confirm_password').val();
        
        if (newPassword !== confirmPassword) {
            showAlert('danger', 'New passwords do not match');
            return;
        }
        
        const formData = new FormData();
        formData.append('current_password', $('#current_password').val());
        formData.append('new_password', newPassword);
        
        fetch('/api/user/change-password', {
            method: 'POST',
            headers: {
                'Authorization': 'Bearer ' + localStorage.getItem('token')
            },
            body: formData
        })
        .then(response => response.json())
        .then(data => {
            if (data.error) {
                showAlert('danger', data.error);
            } else {
                showAlert('success', 'Password changed successfully!');
                $('#passwordForm')[0].reset();
            }
        })
        .catch(error => {
            showAlert('danger', 'Failed to change password: ' + error.message);
        });
    });
    
    // Enable 2FA
    $('#enable2FABtn').on('click', function() {
        fetch('/api/user/2fa/setup', { 
            method: 'POST',
            headers: {
                'Authorization': 'Bearer ' + localStorage.getItem('token')
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.error) {
                showAlert('danger', data.error);
            } else {
                // Generate QR code using the new function
                generateQRCode(data);
            }
        })
        .catch(error => {
            showAlert('danger', 'Failed to setup 2FA: ' + error.message);
        });
    });
    
    // Verify 2FA setup
    $('#verify2FAForm').on('submit', function(e) {
        e.preventDefault();
        
        const formData = new FormData();
        formData.append('totp_code', $('#totp_code').val());
        
        fetch('/api/user/2fa/verify', {
            method: 'POST',
            headers: {
                'Authorization': 'Bearer ' + localStorage.getItem('token')
            },
            body: formData
        })
        .then(response => response.json())
        .then(data => {
            if (data.error) {
                showAlert('danger', data.error);
            } else {
                showAlert('success', '2FA enabled successfully!');
                $('#setup2FAModal').modal('hide');
                location.reload(); // Refresh to show new 2FA status
            }
        })
        .catch(error => {
            showAlert('danger', 'Failed to verify 2FA: ' + error.message);
        });
    });
    
    // Disable 2FA
    $('#disable2FABtn').on('click', function() {
        $('#disable2FAModal').modal('show');
    });
    
    $('#disable2FAForm').on('submit', function(e) {
        e.preventDefault();
        
        const formData = new FormData();
        formData.append('password', $('#disable_password').val());
        formData.append('totp_code', $('#disable_totp').val());
        
        fetch('/api/user/2fa/disable', {
            method: 'POST',
            headers: {
                'Authorization': 'Bearer ' + localStorage.getItem('token')
            },
            body: formData
        })
        .then(response => response.json())
        .then(data => {
            if (data.error) {
                showAlert('danger', data.error);
            } else {
                showAlert('success', '2FA disabled successfully!');
                $('#disable2FAModal').modal('hide');
                location.reload(); // Refresh to show new 2FA status
            }
        })
        .catch(error => {
            showAlert('danger', 'Failed to disable 2FA: ' + error.message);
        });
    });
});
</script>
{% endblock %}
