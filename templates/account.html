{% extends "base.html" %}

{% block title %}Account Settings - TGL MEDUSA{% endblock %}

{% block content %}
<div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
    <h1 class="h2">
        <i class="fas fa-user-cog crypto-icon"></i>
        Account Settings
    </h1>
</div>

<div class="row">
    <!-- Profile Information -->
    <div class="col-md-6">
        <div class="card mb-4">
            <div class="card-header">
                <h5 class="mb-0">
                    <i class="fas fa-user"></i>
                    Profile Information
                </h5>
            </div>
            <div class="card-body">
                <form id="profileForm">
                    <div class="mb-3">
                        <label for="email" class="form-label">Email</label>
                        <input type="email" class="form-control" id="email" readonly>
                        <small class="text-white-50">Email cannot be changed</small>
                    </div>
                    <div class="mb-3">
                        <label for="full_name" class="form-label">Full Name</label>
                        <input type="text" class="form-control" id="full_name" placeholder="Enter your full name">
                    </div>
                    <button type="submit" class="btn btn-primary">
                        <i class="fas fa-save"></i>
                        Update Profile
                    </button>
                </form>
            </div>
        </div>
    </div>

    <!-- Change Password -->
    <div class="col-md-6">
        <div class="card mb-4">
            <div class="card-header">
                <h5 class="mb-0">
                    <i class="fas fa-lock"></i>
                    Change Password
                </h5>
            </div>
            <div class="card-body">
                <form id="passwordForm">
                    <div class="mb-3">
                        <label for="current_password" class="form-label">Current Password</label>
                        <input type="password" class="form-control" id="current_password" required>
                    </div>
                    <div class="mb-3">
                        <label for="new_password" class="form-label">New Password</label>
                        <input type="password" class="form-control" id="new_password" required minlength="8">
                        <small class="text-white-50">Minimum 8 characters</small>
                    </div>
                    <div class="mb-3">
                        <label for="confirm_password" class="form-label">Confirm New Password</label>
                        <input type="password" class="form-control" id="confirm_password" required>
                    </div>
                    <button type="submit" class="btn btn-primary">
                        <i class="fas fa-key"></i>
                        Change Password
                    </button>
                </form>
            </div>
        </div>
    </div>
</div>

<div class="row">
    <!-- Two-Factor Authentication -->
    <div class="col-md-12">
        <div class="card mb-4">
            <div class="card-header">
                <h5 class="mb-0">
                    <i class="fas fa-shield-alt"></i>
                    Two-Factor Authentication (2FA)
                </h5>
            </div>
            <div class="card-body">
                {% raw %}
                <div id="twofa-status-loading" class="text-center">
                    <i class="fas fa-spinner fa-spin"></i> Loading 2FA status...
                </div>
                <div id="twofa-enabled" style="display: none;">
                {% endraw %}
                <div class="row">
                    <div class="col-md-8">
                        <div class="alert alert-success" role="alert">
                            <i class="fas fa-check-circle"></i>
                            <strong>2FA is enabled</strong> - Your account is protected with two-factor authentication.
                        </div>
                        <p class="text-white-50 mb-3">
                            Two-factor authentication adds an extra layer of security to your account. 
                            Keep your authenticator app handy for login.
                        </p>
                        <button type="button" class="btn btn-outline-danger" id="disable2FABtn">
                            <i class="fas fa-times"></i>
                            Disable 2FA
                        </button>
                    </div>
                    <div class="col-md-4 text-center">
                        <i class="fas fa-shield-alt text-success" style="font-size: 4rem;"></i>
                        <p class="mt-2 text-success"><strong>Protected</strong></p>
                    </div>
                </div>
                {% raw %}
                </div>
                <div id="twofa-disabled" style="display: none;">
                {% endraw %}
                <div class="row">
                    <div class="col-md-8">
                        <div class="alert alert-warning" role="alert">
                            <i class="fas fa-exclamation-triangle"></i>
                            <strong>2FA is not enabled</strong> - Your account could be more secure.
                        </div>
                        <p class="text-white-50 mb-3">
                            Enable two-factor authentication to add an extra layer of security to your account.
                            You'll need an authenticator app like Google Authenticator or Authy.
                        </p>
                        <button type="button" class="btn btn-primary" id="enable2FABtn">
                            <i class="fas fa-shield-alt"></i>
                            Enable 2FA
                        </button>
                    </div>
                    <div class="col-md-4 text-center">
                        <i class="fas fa-shield-alt text-warning" style="font-size: 4rem;"></i>
                        <p class="mt-2 text-warning"><strong>Not Protected</strong></p>
                    </div>
                </div>
                {% raw %}
                </div>
                {% endraw %}
            </div>
        </div>
    </div>
</div>

<!-- 2FA Setup Modal -->
<div class="modal fade" id="setup2FAModal" tabindex="-1" aria-labelledby="setup2FAModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content bg-dark border-secondary">
            <div class="modal-header border-secondary">
                <h5 class="modal-title" id="setup2FAModalLabel">
                    <i class="fas fa-shield-alt"></i>
                    Set up Two-Factor Authentication
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div id="qr-step">
                    <h6>Step 1: Add to Authenticator App</h6>
                    <p class="text-white-50">Use your authenticator app (Google Authenticator, Authy, etc.) to scan this QR code or enter the manual key:</p>
                    <div class="text-center mb-3">
                        <div id="qrcode-container" style="min-height: 200px; display: flex; align-items: center; justify-content: center; border: 1px solid #444; border-radius: 8px; padding: 10px; background-color: #f8f9fa;"></div>
                    </div>
                    <div class="alert alert-info">
                        <strong>Manual Entry Key:</strong><br>
                        <code id="manual-secret" class="text-dark bg-light p-2 rounded d-block mt-2" style="font-size: 1.1em; letter-spacing: 1px;"></code>
                        <small class="text-muted mt-2 d-block">Copy this key and add it manually to your authenticator app if you can't scan the QR code.</small>
                    </div>
                </div>
                <div id="verify-step" style="display: none;">
                    <h6>Step 2: Verify Setup</h6>
                    <p class="text-white-50">Enter the 6-digit code from your authenticator app to complete the setup:</p>
                    <form id="verify2FAForm">
                        <div class="mb-3">
                            <label for="totp_code" class="form-label">Verification Code</label>
                            <input type="text" class="form-control text-center" id="totp_code" maxlength="6" pattern="[0-9]{6}" required placeholder="000000" style="font-size: 1.5em; letter-spacing: 3px;">
                            <small class="text-white-50">Enter the 6-digit code from your authenticator app</small>
                        </div>
                        <div class="d-grid">
                            <button type="submit" class="btn btn-primary btn-lg">
                                <i class="fas fa-check"></i>
                                Verify and Enable 2FA
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Disable 2FA Modal -->
<div class="modal fade" id="disable2FAModal" tabindex="-1" aria-labelledby="disable2FAModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content bg-dark border-secondary">
            <div class="modal-header border-secondary">
                <h5 class="modal-title" id="disable2FAModalLabel">
                    <i class="fas fa-exclamation-triangle text-warning"></i>
                    Disable Two-Factor Authentication
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="alert alert-warning" role="alert">
                    <strong>Warning:</strong> Disabling 2FA will reduce your account security.
                </div>
                <p>Enter your current password and a verification code from your authenticator app to disable 2FA:</p>
                <form id="disable2FAForm">
                    <div class="mb-3">
                        <label for="disable_password" class="form-label">Current Password</label>
                        <input type="password" class="form-control" id="disable_password" required>
                    </div>
                    <div class="mb-3">
                        <label for="disable_totp" class="form-label">Verification Code</label>
                        <input type="text" class="form-control text-center" id="disable_totp" maxlength="6" pattern="[0-9]{6}" required>
                    </div>
                    <div class="d-flex justify-content-end">
                        <button type="button" class="btn btn-secondary me-2" data-bs-dismiss="modal">Cancel</button>
                        <button type="submit" class="btn btn-danger">
                            <i class="fas fa-times"></i>
                            Disable 2FA
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script src="https://cdn.jsdelivr.net/npm/qrcode@1.5.3/build/qrcode.min.js"></script>
<script>
// Load user profile data
function loadUserProfile() {
    fetch('/api/user/profile', {
        method: 'GET',
        headers: {
            'Authorization': 'Bearer ' + localStorage.getItem('token')
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.error) {
            showAlert('danger', 'Failed to load profile: ' + data.error);
        } else {
            $('#email').val(data.email);
            $('#full_name').val(data.full_name || '');
        }
    })
    .catch(error => {
        console.error('Error loading profile:', error);
        showAlert('danger', 'Failed to load profile data');
    });
}

// Generate QR code with simple fallback
function generateQRCode(data) {
    const qrContainer = $('#qrcode-container');
    qrContainer.html('<div class="text-center"><i class="fas fa-spinner fa-spin"></i> Generating QR code...</div>');
    
    // Show the modal first with manual entry
    $('#manual-secret').text(data.secret);
    $('#setup2FAModal').modal('show');
    
    console.log('QR data:', data.qr_url);
    console.log('QRCode library available:', typeof QRCode !== 'undefined');
    
    // Use Google Charts API as primary method (most reliable)
    const qrUrl = `https://chart.googleapis.com/chart?chs=200x200&cht=qr&chl=${encodeURIComponent(data.qr_url)}`;
    
    const img = new Image();
    img.onload = function() {
        qrContainer.empty().append(img);
        showVerificationStep();
    };
    img.onerror = function() {
        console.error('Google Charts QR failed, trying QRCode.js');
        // Try QRCode.js as fallback
        if (typeof QRCode !== 'undefined') {
            try {
                const canvas = document.createElement('canvas');
                canvas.width = 200;
                canvas.height = 200;
                
                QRCode.toCanvas(canvas, data.qr_url, {
                    width: 200,
                    height: 200,
                    margin: 1
                }, function (error) {
                    if (error) {
                        console.error('QRCode.js failed:', error);
                        showManualEntryOnly();
                    } else {
                        qrContainer.empty().append(canvas);
                        showVerificationStep();
                    }
                });
            } catch (error) {
                console.error('QRCode.js error:', error);
                showManualEntryOnly();
            }
        } else {
            showManualEntryOnly();
        }
    };
    img.src = qrUrl;
    img.alt = 'QR Code';
    img.className = 'img-fluid';
    img.style.maxWidth = '200px';
}

function showManualEntryOnly() {
    const qrContainer = $('#qrcode-container');
    qrContainer.html('<div class="alert alert-info"><i class="fas fa-info-circle"></i> QR code generation failed. Please use the manual entry key below to set up 2FA in your authenticator app.</div>');
    showVerificationStep();
}

// Show the verification step
function showVerificationStep() {
    // Add a button to proceed to verification
    setTimeout(function() {
        if (!$('#proceed-to-verify').length) {
            const proceedBtn = $('<button>')
                .attr('id', 'proceed-to-verify')
                .addClass('btn btn-success mt-3')
                .html('<i class="fas fa-arrow-right"></i> I\'ve added this to my authenticator app')
                .on('click', function() {
                    $('#qr-step').hide();
                    $('#verify-step').show();
                });
            
            $('#qrcode-container').parent().append(proceedBtn);
        }
    }, 1000);
}

// Load 2FA status
function load2FAStatus() {
    console.log('Loading 2FA status...');
    fetch('/api/user/2fa/status', {
        method: 'GET',
        headers: {
            'Authorization': 'Bearer ' + localStorage.getItem('token')
        }
    })
    .then(response => {
        console.log('2FA status response:', response.status);
        return response.json();
    })
    .then(data => {
        console.log('2FA status data:', data);
        $('#twofa-status-loading').hide();
        if (data.totp_enabled) {
            $('#twofa-enabled').show();
            $('#twofa-disabled').hide();
        } else {
            $('#twofa-disabled').show();
            $('#twofa-enabled').hide();
        }
    })
    .catch(error => {
        console.error('2FA status error:', error);
        $('#twofa-status-loading').hide();
        $('#twofa-disabled').show();
        showAlert('danger', 'Failed to load 2FA status');
    });
}

$(document).ready(function() {
    // Load user profile data
    loadUserProfile();
    
    // Load 2FA status
    load2FAStatus();
    
    // Profile form submission
    $('#profileForm').on('submit', function(e) {
        e.preventDefault();
        
        const formData = new FormData();
        formData.append('full_name', $('#full_name').val());
        
        fetch('/api/user/profile', {
            method: 'POST',
            headers: {
                'Authorization': 'Bearer ' + localStorage.getItem('token')
            },
            body: formData
        })
        .then(response => response.json())
        .then(data => {
            if (data.error) {
                showAlert('danger', data.error);
            } else {
                showAlert('success', 'Profile updated successfully!');
            }
        })
        .catch(error => {
            showAlert('danger', 'Failed to update profile: ' + error.message);
        });
    });
    
    // Password change form
    $('#passwordForm').on('submit', function(e) {
        e.preventDefault();
        
        const newPassword = $('#new_password').val();
        const confirmPassword = $('#confirm_password').val();
        
        if (newPassword !== confirmPassword) {
            showAlert('danger', 'New passwords do not match');
            return;
        }
        
        const formData = new FormData();
        formData.append('current_password', $('#current_password').val());
        formData.append('new_password', newPassword);
        
        fetch('/api/user/change-password', {
            method: 'POST',
            headers: {
                'Authorization': 'Bearer ' + localStorage.getItem('token')
            },
            body: formData
        })
        .then(response => response.json())
        .then(data => {
            if (data.error) {
                showAlert('danger', data.error);
            } else {
                showAlert('success', 'Password changed successfully!');
                $('#passwordForm')[0].reset();
            }
        })
        .catch(error => {
            showAlert('danger', 'Failed to change password: ' + error.message);
        });
    });
    
    // Enable 2FA
    $('#enable2FABtn').on('click', function() {
        console.log('Starting 2FA setup...');
        // Reset modal state
        resetModal();
        
        fetch('/api/user/2fa/setup', { 
            method: 'POST',
            headers: {
                'Authorization': 'Bearer ' + localStorage.getItem('token')
            }
        })
        .then(response => {
            console.log('Setup response status:', response.status);
            return response.json();
        })
        .then(data => {
            console.log('Setup response data:', data);
            if (data.error) {
                showAlert('danger', data.error);
            } else {
                // Debug: Log the QR URL to console
                console.log('QR URL received:', data.qr_url);
                console.log('Secret received:', data.secret);
                console.log('QRCode library available:', typeof QRCode !== 'undefined');
                
                // Generate QR code using the new function
                generateQRCode(data);
            }
        })
        .catch(error => {
            console.error('Setup error:', error);
            showAlert('danger', 'Failed to setup 2FA: ' + error.message);
        });
    });
    
    // Reset modal function
    function resetModal() {
        $('#qr-step').show();
        $('#verify-step').hide();
        $('#qrcode-container').empty();
        $('#manual-secret').text('');
        $('#proceed-to-verify').remove();
        $('#verify2FAForm')[0].reset();
    }
    
    // Verify 2FA setup
    $('#verify2FAForm').on('submit', function(e) {
        e.preventDefault();
        
        const totpCode = $('#totp_code').val();
        console.log('Verifying 2FA with code:', totpCode);
        
        const formData = new FormData();
        formData.append('totp_code', totpCode);
        
        fetch('/api/user/2fa/verify', {
            method: 'POST',
            headers: {
                'Authorization': 'Bearer ' + localStorage.getItem('token')
            },
            body: formData
        })
        .then(response => {
            console.log('Verify response status:', response.status);
            return response.json();
        })
        .then(data => {
            console.log('Verify response data:', data);
            if (data.error) {
                showAlert('danger', data.error);
            } else {
                showAlert('success', '2FA enabled successfully!');
                $('#setup2FAModal').modal('hide');
                // Refresh the 2FA status
                load2FAStatus();
            }
        })
        .catch(error => {
            console.error('Verify error:', error);
            showAlert('danger', 'Failed to verify 2FA: ' + error.message);
        });
    });
    
    // Disable 2FA
    $('#disable2FABtn').on('click', function() {
        $('#disable2FAModal').modal('show');
    });
    
    $('#disable2FAForm').on('submit', function(e) {
        e.preventDefault();
        
        const formData = new FormData();
        formData.append('password', $('#disable_password').val());
        formData.append('totp_code', $('#disable_totp').val());
        
        fetch('/api/user/2fa/disable', {
            method: 'POST',
            headers: {
                'Authorization': 'Bearer ' + localStorage.getItem('token')
            },
            body: formData
        })
        .then(response => response.json())
        .then(data => {
            if (data.error) {
                showAlert('danger', data.error);
            } else {
                showAlert('success', '2FA disabled successfully!');
                $('#disable2FAModal').modal('hide');
                location.reload(); // Refresh to show new 2FA status
            }
        })
        .catch(error => {
            showAlert('danger', 'Failed to disable 2FA: ' + error.message);
        });
    });
});
</script>
{% endblock %}
