{% extends "base.html" %}

{% block title %}Setup 2FA - TGL Medusa Loggers{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="row justify-content-center">
        <div class="col-md-8 col-lg-6">
            <div class="card shadow">
                <div class="card-header text-center">
                    <h4 class="mb-0">
                        <i class="fas fa-shield-alt crypto-icon"></i>
                        Setup Google Authenticator
                    </h4>
                    <small class="text-muted">Enhance your account security</small>
                </div>
                <div class="card-body">
                    <div id="setup-step" class="text-center">
                        <p class="mb-4">Click the button below to generate your Google Authenticator QR code.</p>
                        <button id="generateQR" class="btn btn-primary">
                            <i class="fas fa-qrcode"></i>
                            Generate QR Code
                        </button>
                    </div>
                    
                    <div id="qr-step" class="text-center" style="display: none;">
                        <p class="mb-3">Scan this QR code with your Google Authenticator app:</p>
                        <div id="qr-code" class="mb-4"></div>
                        <p class="mb-3">Or manually enter this secret key:</p>
                        <div class="alert alert-info">
                            <code id="secret-key"></code>
                        </div>
                        
                        <form id="verify2FA">
                            <div class="mb-3">
                                <label for="totp_code" class="form-label">Enter 6-digit code from your app:</label>
                                <input type="text" class="form-control" id="totp_code" name="totp_code" 
                                       placeholder="123456" maxlength="6" required>
                            </div>
                            <button type="submit" class="btn btn-success">
                                <i class="fas fa-check"></i>
                                Enable 2FA
                            </button>
                        </form>
                    </div>
                    
                    <div id="success-step" class="text-center" style="display: none;">
                        <div class="alert alert-success">
                            <i class="fas fa-check-circle"></i>
                            2FA has been successfully enabled for your account!
                        </div>
                        <a href="/" class="btn btn-primary">
                            <i class="fas fa-home"></i>
                            Go to Dashboard
                        </a>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
const token = localStorage.getItem('access_token');

// Check if user is authenticated
if (!token) {
    window.location.href = '/login';
}

document.getElementById('generateQR').addEventListener('click', async function() {
    try {
        const response = await fetch('/auth/setup-2fa', {
            method: 'POST',
            headers: {
                'Authorization': 'Bearer ' + token,
            }
        });
        
        if (response.ok) {
            const data = await response.json();
            document.getElementById('qr-code').innerHTML = `<img src="${data.qr_code}" alt="QR Code" class="img-fluid">`;
            document.getElementById('secret-key').textContent = data.secret;
            document.getElementById('setup-step').style.display = 'none';
            document.getElementById('qr-step').style.display = 'block';
        } else {
            const error = await response.json();
            alert('Error generating QR code: ' + error.detail);
        }
    } catch (error) {
        alert('Error: ' + error.message);
    }
});

document.getElementById('verify2FA').addEventListener('submit', async function(e) {
    e.preventDefault();
    
    const formData = new FormData(this);
    const totpCode = formData.get('totp_code');
    
    try {
        const response = await fetch('/auth/enable-2fa', {
            method: 'POST',
            headers: {
                'Authorization': 'Bearer ' + token,
                'Content-Type': 'application/x-www-form-urlencoded',
            },
            body: 'totp_code=' + encodeURIComponent(totpCode)
        });
        
        if (response.ok) {
            document.getElementById('qr-step').style.display = 'none';
            document.getElementById('success-step').style.display = 'block';
        } else {
            const error = await response.json();
            alert('Verification failed: ' + error.detail);
        }
    } catch (error) {
        alert('Error: ' + error.message);
    }
});
</script>
{% endblock %}
