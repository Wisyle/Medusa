{% extends "base.html" %}

{% block title %}Login - Lighthouse{% endblock %}

{% block content %}
<div class="login-card-container">
    <div class="login-card lighthouse-card">
            <div class="login-card-header">
                <div class="logo-section">
                    <div class="lighthouse-logo-container">
                        <lottie-player 
                            src="/static/lighthouse.json" 
                            background="transparent" 
                            speed="1" 
                            style="width: 80px; height: 80px;" 
                            loop 
                            autoplay 
                            class="login-logo lottie-animation"
                            onerror="handleLottieError(this, 'https://tar-lighthouse-static.onrender.com/lighthouse-login.gif')"
                            onload="handleLottieLoad(this)">
                        </lottie-player>
                        <img 
                            src="https://tar-lighthouse-static.onrender.com/lighthouse-login.gif" 
                            alt="Lighthouse Logo" 
                            style="width: 80px; height: 80px; display: none;" 
                            class="login-logo gif-fallback">
                    </div>
                    <h2 class="brand-title" style="text-align: center; margin-bottom: 5px;">
                        LIGHTHOUSE
                    </h2>
                    <p class="brand-subtitle" style="display: flex; align-items: center; justify-content: center; gap: 6px; margin: 0; font-size: 0.9rem; opacity: 0.9;">
                        <img src="https://tar-lighthouse-static.onrender.com/tar-logo.jpg" alt="TAR Logo" class="tar-logo-inline" style="width: 20px; height: 20px; border-radius: 4px;">
                                                 TAR <span style="font-style: italic; color: var(--accent-gold); font-weight: 400;">for</span> GLOBAL STRATEGIES
                    </p>
                </div>
                
                <!-- Typewriter Effect -->
                <div class="typewriter-container">
                    <span class="typewriter-text" id="typewriter"></span>
                    <span class="cursor">|</span>
                </div>
            </div>
            
            <div class="login-card-body">
                <!-- Welcome Back Message -->
                <div class="welcome-back" id="welcome-back" style="display: none;">
                    <h4 class="welcome-message"></h4>
                    <p class="last-login"></p>
                </div>
                
                <form id="loginForm" class="login-form">
                    <div class="form-group">
                        <label for="email" class="form-label">Email Address</label>
                        <div class="input-container">
                            <i class="fas fa-envelope input-icon"></i>
                            <input type="email" class="form-control" id="email" name="email" required autocomplete="email">
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label for="password" class="form-label">Password</label>
                        <div class="input-container">
                            <i class="fas fa-lock input-icon"></i>
                            <input type="password" class="form-control" id="password" name="password" required autocomplete="current-password">
                            <i class="fas fa-eye password-toggle" id="password-toggle"></i>
                        </div>
                    </div>
                    
                    <!-- 2FA Field -->
                    <div class="form-group" id="totp_field" style="display: none;">
                        <label for="totp_code" class="form-label">Two-Factor Authentication</label>
                        <div class="input-container">
                            <i class="fas fa-shield-alt input-icon"></i>
                            <input type="text" class="form-control" id="totp_code" name="totp_code" 
                                   placeholder="000000" maxlength="6" autocomplete="one-time-code">
                        </div>
                    </div>
                    
                    <!-- Enhanced Security Fields -->
                    <div class="enhanced-security" id="admin_security_fields" style="display: none;">
                        <div class="security-notice">
                            <i class="fas fa-shield-alt"></i>
                            <div>
                                <h6>Enhanced Security Required</h6>
                                <p>Additional authentication factors are required for this account.</p>
                            </div>
                        </div>
                        
                        <div class="form-group">
                            <label for="private_key" class="form-label">Private Key</label>
                            <div class="input-container">
                                <i class="fas fa-key input-icon"></i>
                                <input type="password" class="form-control" id="private_key" name="private_key" 
                                       placeholder="Enter your private key" autocomplete="off">
                            </div>
                        </div>
                        
                        <div class="form-group">
                            <label for="passphrase" class="form-label">Passphrase</label>
                            <div class="input-container">
                                <i class="fas fa-fingerprint input-icon"></i>
                                <input type="password" class="form-control" id="passphrase" name="passphrase" 
                                       placeholder="Enter your passphrase" autocomplete="off">
                            </div>
                        </div>
                    </div>
                    
                    <!-- Error Alert -->
                    <div class="alert alert-danger" id="error-alert" style="display: none;">
                        <i class="fas fa-exclamation-triangle"></i>
                        <span id="error-message"></span>
                    </div>
                    
                    <!-- Login Button -->
                    <button type="submit" class="login-btn" id="login-btn">
                        <span class="btn-text">Access Lighthouse</span>
                        <i class="fas fa-arrow-right btn-icon"></i>
                        <div class="btn-background"></div>
                    </button>
                    
                    <!-- Loading State -->
                    <div class="login-loading" id="login-loading" style="display: none;">
                        <div class="loading-spinner"></div>
                        <span>Authenticating...</span>
                    </div>
                </form>
            </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<style>
/* Force hide all navigation elements on login page */
.top-navbar,
.lighthouse-sidebar,
.user-profile,
.system-status,
.dropdown-menu,
.user-avatar,
nav.top-navbar,
.dropdown,
.particles-bg {
    display: none !important;
    visibility: hidden !important;
    opacity: 0 !important;
    height: 0 !important;
    overflow: hidden !important;
    position: absolute !important;
    left: -9999px !important;
}

/* Ensure clean full-screen login */
html, body {
    margin: 0;
    padding: 0;
    height: 100%;
    overflow-x: hidden;
}

body {
    background: var(--primary-black) !important;
}

/* Login Card Container */
.login-card-container {
    width: 100%;
    max-width: 480px;
    margin: 0 auto;
    padding: 1rem;
}

/* Login Card Specific Styles */
.login-card {
    background: linear-gradient(145deg, var(--secondary-black), var(--dark-gray));
    border: 1px solid var(--border-gray);
    border-radius: 1.5rem;
    box-shadow: 
        0 20px 60px rgba(0, 0, 0, 0.4),
        0 0 0 1px rgba(255, 255, 255, 0.05),
        inset 0 1px 0 rgba(255, 255, 255, 0.1);
    backdrop-filter: blur(20px);
    overflow: hidden;
    position: relative;
    padding: 0;
    width: 100%;
}

.login-card::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    height: 1px;
    background: linear-gradient(90deg, transparent, var(--accent-blue), transparent);
    opacity: 0.8;
}

.login-card-header {
    text-align: center;
    padding: 2.5rem 2.5rem 1.5rem 2.5rem;
    border-bottom: 1px solid var(--border-gray);
}

.logo-section {
    margin-bottom: 2rem;
}

.login-logo {
    width: 80px;
    height: 80px;
    filter: drop-shadow(0 0 20px var(--glow-blue));
    animation: logo-pulse 3s ease-in-out infinite;
}

@keyframes logo-pulse {
    0%, 100% { transform: scale(1); }
    50% { transform: scale(1.05); }
}

.brand-title {
    font-family: 'Orbitron', monospace;
    font-weight: 900;
    font-size: 2rem;
    color: var(--white);
    margin: 15px 0 5px;
    text-transform: uppercase;
    letter-spacing: 2px;
    background: linear-gradient(135deg, var(--accent-blue), var(--accent-cyan));
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    background-clip: text;
}

.brand-subtitle {
    color: var(--off-white);
    font-size: 0.9rem;
    opacity: 0.8;
    font-weight: 500;
    margin: 0;
}

/* Typewriter Effect */
.typewriter-container {
    height: 30px;
    font-family: 'Inter', sans-serif;
    font-size: 1.1rem;
    color: var(--accent-blue);
    display: flex;
    align-items: center;
    justify-content: center;
}

.typewriter-text {
    min-height: 1.2em;
}

.cursor {
    animation: blink 1s infinite;
    margin-left: 2px;
    font-weight: bold;
}

@keyframes blink {
    0%, 50% { opacity: 1; }
    51%, 100% { opacity: 0; }
}

/* Form Styles */
.login-card-body {
    padding: 2.5rem;
}

.welcome-back {
    text-align: center;
    margin-bottom: 30px;
    padding: 20px;
    background: linear-gradient(135deg, var(--accent-blue), var(--accent-cyan));
    border-radius: 16px;
    opacity: 0.1;
}

.welcome-message {
    color: var(--white);
    font-weight: 600;
    margin-bottom: 5px;
}

.last-login {
    color: rgba(255, 255, 255, 0.8);
    font-size: 0.9rem;
    margin: 0;
}

.form-group {
    margin-bottom: 25px;
}

.form-label {
    color: var(--off-white);
    font-weight: 600;
    margin-bottom: 8px;
    display: block;
    font-size: 0.9rem;
}

.input-container {
    position: relative;
}

.input-icon {
    position: absolute;
    left: 15px;
    top: 50%;
    transform: translateY(-50%);
    color: var(--accent-blue);
    z-index: 2;
}

.form-control {
    background: rgba(255, 255, 255, 0.05);
    border: 2px solid var(--medium-gray);
    border-radius: 12px;
    padding: 15px 50px 15px 45px;
    color: var(--white);
    font-size: 1rem;
    transition: all 0.3s ease;
    width: 100%;
}

.form-control:focus {
    outline: none;
    border-color: var(--accent-blue);
    background: rgba(255, 255, 255, 0.08);
    box-shadow: 0 0 0 3px rgba(0, 102, 255, 0.1);
}

.form-control::placeholder {
    color: rgba(255, 255, 255, 0.4);
}

.password-toggle {
    position: absolute;
    right: 15px;
    top: 50%;
    transform: translateY(-50%);
    color: var(--accent-blue);
    cursor: pointer;
    transition: color 0.3s ease;
}

.password-toggle:hover {
    color: var(--accent-cyan);
}

/* Enhanced Security */
.enhanced-security {
    margin: 30px 0;
    padding: 25px;
    background: linear-gradient(135deg, rgba(255, 215, 0, 0.1), rgba(255, 215, 0, 0.05));
    border: 1px solid rgba(255, 215, 0, 0.3);
    border-radius: 16px;
}

.security-notice {
    display: flex;
    align-items: center;
    margin-bottom: 20px;
    color: var(--accent-gold);
}

.security-notice i {
    font-size: 1.5rem;
    margin-right: 15px;
}

.security-notice h6 {
    margin: 0 0 5px;
    font-weight: 600;
}

.security-notice p {
    margin: 0;
    font-size: 0.9rem;
    opacity: 0.8;
}

/* Login Button */
.login-btn {
    width: 100%;
    height: 56px;
    background: linear-gradient(135deg, var(--accent-blue), var(--accent-cyan));
    border: none;
    border-radius: 16px;
    color: var(--white);
    font-weight: 700;
    font-size: 1.1rem;
    position: relative;
    overflow: hidden;
    cursor: pointer;
    transition: all 0.3s ease;
    display: flex;
    align-items: center;
    justify-content: center;
    text-transform: uppercase;
    letter-spacing: 1px;
}

.login-btn:hover {
    transform: translateY(-2px);
    box-shadow: 0 10px 30px rgba(0, 102, 255, 0.4);
}

.login-btn:active {
    transform: translateY(0);
}

.btn-text {
    z-index: 2;
    position: relative;
}

.btn-icon {
    margin-left: 10px;
    transition: transform 0.3s ease;
    z-index: 2;
    position: relative;
}

.login-btn:hover .btn-icon {
    transform: translateX(5px);
}

.btn-background {
    position: absolute;
    top: 0;
    left: -100%;
    width: 100%;
    height: 100%;
    background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.2), transparent);
    transition: left 0.5s ease;
}

.login-btn:hover .btn-background {
    left: 100%;
}

/* Loading State */
.login-loading {
    text-align: center;
    margin-top: 20px;
    color: var(--accent-blue);
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 10px;
}

.loading-spinner {
    width: 20px;
    height: 20px;
    border: 2px solid rgba(0, 102, 255, 0.3);
    border-top: 2px solid var(--accent-blue);
    border-radius: 50%;
    animation: spin 1s linear infinite;
}

@keyframes spin {
    0% { transform: rotate(0deg); }
    100% { transform: rotate(360deg); }
}

/* Alert Styles */
.alert {
    border-radius: 12px;
    border: none;
    padding: 15px 20px;
    margin-bottom: 20px;
    display: flex;
    align-items: center;
    gap: 10px;
}

.alert-danger {
    background: linear-gradient(135deg, rgba(220, 53, 69, 0.2), rgba(220, 53, 69, 0.1));
    border: 1px solid rgba(220, 53, 69, 0.3);
    color: #ff6b6b;
}

/* Responsive Design */
@media (max-width: 768px) {
    .login-card-container {
        padding: 0.5rem;
        max-width: 100%;
    }
    
    .login-card-header,
    .login-card-body {
        padding: 2rem 1.5rem;
    }
    
    .brand-title {
        font-size: 1.8rem;
    }
}

@media (max-width: 480px) {
    .login-card-container {
        padding: 0.25rem;
    }
    
    .login-card-header,
    .login-card-body {
        padding: 1.5rem 1rem;
    }
    
    .brand-title {
        font-size: 1.6rem;
    }
}
</style>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const typewriterElement = document.getElementById('typewriter');
    const loginForm = document.getElementById('loginForm');
    const emailInput = document.getElementById('email');
    const passwordToggle = document.getElementById('password-toggle');
    const passwordInput = document.getElementById('password');
    
    // Typewriter messages
    const messages = [
        "Welcome to your command center",
        "Monitor your strategies in real-time",
        "Navigate the crypto markets with precision",
        "Your lighthouse in the digital ocean",
        "Advanced analytics at your fingertips",
        "Secure. Powerful. Intuitive."
    ];
    
    let messageIndex = 0;
    let charIndex = 0;
    let isDeleting = false;
    let isPaused = false;
    
    function typeWriter() {
        const currentMessage = messages[messageIndex];
        
        if (!isDeleting && !isPaused) {
            // Typing
            typewriterElement.textContent = currentMessage.substring(0, charIndex + 1);
            charIndex++;
            
            if (charIndex === currentMessage.length) {
                isPaused = true;
                setTimeout(() => {
                    isPaused = false;
                    isDeleting = true;
                }, 2000); // Pause at end
            }
        } else if (isDeleting && !isPaused) {
            // Deleting
            typewriterElement.textContent = currentMessage.substring(0, charIndex - 1);
            charIndex--;
            
            if (charIndex === 0) {
                isDeleting = false;
                messageIndex = (messageIndex + 1) % messages.length;
                setTimeout(typeWriter, 500); // Pause before next message
                return;
            }
        }
        
        const speed = isDeleting ? 50 : 100;
        setTimeout(typeWriter, speed);
    }
    
    // Start typewriter effect
    setTimeout(typeWriter, 1000);
    
    // Password toggle
    passwordToggle.addEventListener('click', function() {
        const type = passwordInput.getAttribute('type') === 'password' ? 'text' : 'password';
        passwordInput.setAttribute('type', type);
        this.classList.toggle('fa-eye');
        this.classList.toggle('fa-eye-slash');
    });
    
    // Check for returning user
    const lastEmail = localStorage.getItem('last_login_email');
    const lastLoginTime = localStorage.getItem('last_login_time');
    const userDisplayName = localStorage.getItem('user_display_name');
    
    if (lastEmail && userDisplayName) {
        emailInput.value = lastEmail;
        showWelcomeBack(userDisplayName, lastLoginTime);
    }
    
    function showWelcomeBack(name, lastLogin) {
        const welcomeSection = document.getElementById('welcome-back');
        const welcomeMessage = welcomeSection.querySelector('.welcome-message');
        const lastLoginElement = welcomeSection.querySelector('.last-login');
        
        welcomeMessage.textContent = `Welcome back, ${name}!`;
        if (lastLogin) {
            const loginDate = new Date(lastLogin);
            lastLoginElement.textContent = `Last login: ${loginDate.toLocaleDateString()} at ${loginDate.toLocaleTimeString()}`;
        }
        
        welcomeSection.style.display = 'block';
        setTimeout(() => {
            welcomeSection.style.opacity = '1';
        }, 100);
    }
    
    // Form submission
    loginForm.addEventListener('submit', async function(e) {
        e.preventDefault();
        
        const loginBtn = document.getElementById('login-btn');
        const loginLoading = document.getElementById('login-loading');
        const errorAlert = document.getElementById('error-alert');
        
        // Show loading state
        loginBtn.style.display = 'none';
        loginLoading.style.display = 'flex';
        errorAlert.style.display = 'none';
        
        const formData = new FormData(this);
        const loginData = {
            email: formData.get('email'),
            password: formData.get('password'),
            totp_code: formData.get('totp_code') || null,
            private_key: formData.get('private_key') || null,
            passphrase: formData.get('passphrase') || null
        };
        
        try {
            const response = await fetch('/auth/login', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(loginData)
            });
            
            if (response.ok) {
                const data = await response.json();
                
                // Store tokens and user info
                localStorage.setItem('access_token', data.access_token);
                localStorage.setItem('refresh_token', data.refresh_token);
                localStorage.setItem('last_login_email', loginData.email);
                localStorage.setItem('last_login_time', new Date().toISOString());
                
                // Success animation
                loginLoading.innerHTML = '<i class="fas fa-check-circle"></i> <span>Welcome aboard!</span>';
                
                setTimeout(() => {
                    if (data.needs_security_setup) {
                        window.location.href = '/security-setup';
                    } else {
                        window.location.href = '/';
                    }
                }, 1000);
            } else {
                const error = await response.json();
                const errorMessage = error.detail;
                
                // Reset UI
                loginBtn.style.display = 'flex';
                loginLoading.style.display = 'none';
                
                // Show specific security fields based on error
                if (errorMessage.includes('Private key required') || errorMessage.includes('Passphrase required')) {
                    document.getElementById('admin_security_fields').style.display = 'block';
                }
                
                if (errorMessage.includes('2FA code required')) {
                    document.getElementById('totp_field').style.display = 'block';
                }
                
                // Show error
                document.getElementById('error-message').textContent = errorMessage;
                errorAlert.style.display = 'flex';
                
                // Shake animation
                loginBtn.style.animation = 'shake 0.5s ease-in-out';
                setTimeout(() => {
                    loginBtn.style.animation = '';
                }, 500);
            }
        } catch (error) {
            console.error('Network error during login:', error);
            
            // Reset UI
            loginBtn.style.display = 'flex';
            loginLoading.style.display = 'none';
            
            document.getElementById('error-message').textContent = 'Network error. Please try again.';
            errorAlert.style.display = 'flex';
        }
    });
});

// Add shake animation
const style = document.createElement('style');
style.textContent = `
    @keyframes shake {
        0%, 100% { transform: translateX(0); }
        25% { transform: translateX(-10px); }
        75% { transform: translateX(10px); }
    }
`;
document.head.appendChild(style);

// Lottie error handling for login page
function handleLottieError(lottiePlayer, fallbackSrc) {
    const fallbackImage = lottiePlayer.nextElementSibling;
    if (fallbackImage && fallbackImage.tagName === 'IMG') {
        fallbackImage.style.display = 'block';
        lottiePlayer.style.display = 'none';
        console.warn('Lottie animation failed to load, showing GIF fallback.');
    } else {
        console.error('Lottie player or fallback image not found.');
    }
}

// Lottie load handling for login page
function handleLottieLoad(lottiePlayer) {
    const fallbackImage = lottiePlayer.nextElementSibling;
    if (fallbackImage && fallbackImage.tagName === 'IMG') {
        fallbackImage.style.display = 'none';
        lottiePlayer.style.display = 'block';
    }
}
</script>
{% endblock %}
