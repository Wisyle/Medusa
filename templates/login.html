{% extends "base.html" %}

{% block title %}Login - TGL MEDUSA{% endblock %}

{% block content %}
<div class="container-fluid h-100 position-relative overflow-hidden">
    <!-- Floating Geometric Shapes -->
    <div class="floating-shapes">
        <div class="shape shape-1"></div>
        <div class="shape shape-2"></div>
        <div class="shape shape-3"></div>
        <div class="shape shape-4"></div>
        <div class="shape shape-5"></div>
    </div>
    
    <div class="row h-100 justify-content-center align-items-center">
        <div class="col-md-6 col-lg-4">
            <div class="card shadow login-card">
                <div class="card-header text-center">
                    <div class="logo-container mb-3">
                        <img src="/static/tgl-logo.png" alt="TGL Logo" class="login-logo">
                    </div>
                    <h4 class="mb-0 text-white">TGL MEDUSA</h4>
                    <small class="text-white-50">Crypto Bot Monitor</small>
                </div>
                <div class="card-body">
                    <form id="loginForm">
                        <div class="mb-3">
                            <label for="email" class="form-label">Email</label>
                            <input type="email" class="form-control" id="email" name="email" required>
                        </div>
                        
                        <div class="mb-3">
                            <label for="password" class="form-label">Password</label>
                            <input type="password" class="form-control" id="password" name="password" required>
                        </div>
                        
                        <div class="mb-3" id="totp_field" style="display: none;">
                            <label for="totp_code" class="form-label">2FA Code</label>
                            <input type="text" class="form-control" id="totp_code" name="totp_code" 
                                   placeholder="6-digit code" maxlength="6">
                        </div>
                        
                        <div class="mb-3" id="admin_security_fields" style="display: none;">
                            <div class="alert alert-info">
                                <i class="fas fa-shield-alt"></i>
                                <strong>Additional Security Required</strong>
                                <p class="mb-0">Enter your private key and/or passphrase for enhanced security.</p>
                            </div>
                            
                            <div class="mb-3">
                                <label for="private_key" class="form-label">Private Key</label>
                                <input type="password" class="form-control" id="private_key" name="private_key" placeholder="Enter your private key">
                            </div>
                            
                            <div class="mb-3">
                                <label for="passphrase" class="form-label">Passphrase</label>
                                <input type="password" class="form-control" id="passphrase" name="passphrase" placeholder="Enter your passphrase">
                            </div>
                        </div>
                        
                        <div class="alert alert-danger" id="error-alert" style="display: none;">
                            <span id="error-message"></span>
                        </div>
                        
                        <div class="d-grid">
                            <button type="submit" class="btn btn-primary">
                                <i class="fas fa-sign-in-alt"></i>
                                Login
                            </button>
                        </div>
                    </form>
                    
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<style>
.floating-shapes {
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    pointer-events: none;
    z-index: 1;
}

.shape {
    position: absolute;
    background: linear-gradient(45deg, var(--accent-blue), rgba(0, 123, 255, 0.3));
    border-radius: 50%;
    animation: float 6s ease-in-out infinite;
}

.shape-1 {
    width: 80px;
    height: 80px;
    top: 10%;
    left: 10%;
    animation-delay: 0s;
}

.shape-2 {
    width: 60px;
    height: 60px;
    top: 20%;
    right: 15%;
    animation-delay: 2s;
    border-radius: 20%;
}

.shape-3 {
    width: 100px;
    height: 100px;
    bottom: 20%;
    left: 20%;
    animation-delay: 4s;
    transform: rotate(45deg);
    border-radius: 20%;
}

.shape-4 {
    width: 40px;
    height: 40px;
    bottom: 30%;
    right: 25%;
    animation-delay: 1s;
}

.shape-5 {
    width: 70px;
    height: 70px;
    top: 50%;
    left: 5%;
    animation-delay: 3s;
    border-radius: 30%;
}

@keyframes float {
    0%, 100% {
        transform: translateY(0px) rotate(0deg);
        opacity: 0.7;
    }
    50% {
        transform: translateY(-20px) rotate(180deg);
        opacity: 1;
    }
}

.login-card {
    position: relative;
    z-index: 10;
    backdrop-filter: blur(10px);
    background-color: rgba(26, 26, 26, 0.9) !important;
}

.login-logo {
    width: 80px;
    height: 80px;
    object-fit: cover;
    border-radius: 50%;
    filter: drop-shadow(0 0 10px rgba(0, 123, 255, 0.3));
}

.logo-container {
    animation: pulse 2s ease-in-out infinite;
}

@keyframes pulse {
    0%, 100% {
        transform: scale(1);
    }
    50% {
        transform: scale(1.05);
    }
}
</style>
<script>
document.addEventListener('DOMContentLoaded', function() {
    const loginForm = document.getElementById('loginForm');
    if (!loginForm) {
        console.error('Login form not found!');
        return;
    }
    
    loginForm.addEventListener('submit', async function(e) {
        e.preventDefault();
        
        const formData = new FormData(this);
        const loginData = {
            email: formData.get('email'),
            password: formData.get('password'),
            totp_code: formData.get('totp_code') || null,
            private_key: formData.get('private_key') || null,
            passphrase: formData.get('passphrase') || null
        };
        
        console.log('Attempting login with email/password...');
        
        try {
            const response = await fetch('/auth/login', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(loginData)
            });
            
            console.log('Response status:', response.status);
            
            if (response.ok) {
                const data = await response.json();
                console.log('Login successful!');
                
                // Store tokens
                localStorage.setItem('access_token', data.access_token);
                localStorage.setItem('refresh_token', data.refresh_token);
                
                // Check if user needs security setup (first-time login)
                if (data.needs_security_setup) {
                    console.log('First-time login detected, redirecting to security setup...');
                    window.location.href = '/security-setup';
                } else {
                    console.log('Redirecting to dashboard...');
                    window.location.href = '/';
                }
            } else {
                const error = await response.json();
                const errorMessage = error.detail;
                console.log('Login failed:', errorMessage);
                
                // Show specific security fields based on error
                if (errorMessage.includes('Private key required') || errorMessage.includes('Passphrase required')) {
                    document.getElementById('admin_security_fields').style.display = 'block';
                }
                
                if (errorMessage.includes('2FA code required')) {
                    document.getElementById('totp_field').style.display = 'block';
                }
                
                document.getElementById('error-message').textContent = errorMessage;
                document.getElementById('error-alert').style.display = 'block';
            }
        } catch (error) {
            console.error('Network error during login:', error);
            document.getElementById('error-message').textContent = 'Network error. Please try again.';
            document.getElementById('error-alert').style.display = 'block';
        }
    });
});
</script>
{% endblock %}
