{% extends "base.html" %}

{% block title %}Edit Instance - TGL MEDUSA{% endblock %}

{% block content %}
<div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pb-2 mb-3 border-bottom">
    <h1 class="h2">
        <i class="fas fa-edit crypto-icon"></i>
        Edit Bot Instance
    </h1>
    <div class="btn-toolbar mb-2 mb-md-0">
        <div class="btn-group me-2">
            <a href="/instances" class="btn btn-sm btn-outline-secondary">
                <i class="fas fa-arrow-left"></i>
                Back to Instances
            </a>
        </div>
    </div>
</div>

<div class="row">
    <div class="col-lg-8">
        <div class="card shadow">
            <div class="card-header py-3">
                <h6 class="m-0 font-weight-bold text-primary">
                    <i class="fas fa-cog"></i>
                    Instance Configuration
                </h6>
            </div>
            <div class="card-body">
                <form id="instance-form" method="post">
                    <!-- Basic Information -->
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <label for="name" class="form-label">Instance Name *</label>
                            <input type="text" class="form-control" id="name" name="name" required 
                                   placeholder="e.g., BTC-USDT-Grid-Bot">
                        </div>
                        <div class="col-md-6">
                            <label for="exchange" class="form-label">Exchange *</label>
                            <select class="form-select" id="exchange" name="exchange" required>
                                <option value="">Select Exchange</option>
                                <option value="binance">Binance</option>
                                <option value="bitget">Bitget</option>
                                <option value="bybit">Bybit</option>
                                <option value="okx">OKX</option>
                                <option value="kucoin">KuCoin</option>
                                <option value="mexc">MEXC</option>
                                <option value="gateio">Gate.io</option>
                                <option value="coinbasepro">Coinbase Pro</option>
                                <option value="bitfinex">Bitfinex</option>
                            </select>
                        </div>
                        <div class="col-md-6">
                            <label for="market_type" class="form-label">Market Type</label>
                            <select class="form-select" id="market_type" name="market_type">
                                <option value="unified">Unified (Spot + Futures)</option>
                                <option value="spot">Spot Trading</option>
                                <option value="futures">Futures Trading</option>
                            </select>
                            <small class="form-text text-muted">Bybit unified allows both spot and futures trading</small>
                        </div>
                    </div>
                    
                    <!-- Trading Pair Configuration -->
                    <div class="row mb-3">
                        <div class="col-md-12">
                            <label for="trading_pair" class="form-label">Trading Pair *</label>
                            <input type="text" class="form-control" id="trading_pair" name="trading_pair" required 
                                   placeholder="e.g., BTC/USDT, ETH/USDT">
                            <small class="form-text text-muted">The specific trading pair to monitor (e.g., BTC/USDT)</small>
                        </div>
                    </div>

                    <!-- Polling Configuration -->
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <label for="polling_interval" class="form-label">Polling Interval (seconds)</label>
                            <input type="number" class="form-control" id="polling_interval" name="polling_interval" 
                                   value="60" min="30" max="300">
                            <small class="form-text text-muted">How often to check for changes (30-300 seconds)</small>
                        </div>
                    </div>

                    <!-- API Configuration -->
                    <h5 class="mb-3">
                        <i class="fas fa-key"></i>
                        API Configuration
                    </h5>
                    <!-- API Source Selection -->
                    <div class="row mb-3">
                        <div class="col-md-12">
                            <div class="form-check">
                                <input class="form-check-input" type="radio" id="use_library" name="api_source" value="library">
                                <label class="form-check-label" for="use_library">
                                    <strong>Use API from Library</strong> (Recommended)
                                </label>
                            </div>
                            <div class="form-check">
                                <input class="form-check-input" type="radio" id="use_direct" name="api_source" value="direct">
                                <label class="form-check-label" for="use_direct">
                                    <strong>Enter API Credentials Directly</strong>
                                </label>
                            </div>
                        </div>
                    </div>
                    
                    <!-- API Library Selection -->
                    <div id="api_library_section" class="mb-3">
                        <div class="row">
                            <div class="col-md-8">
                                <label for="api_credential_id" class="form-label">Select API Credential</label>
                                <select class="form-control" id="api_credential_id" name="api_credential_id">
                                    <option value="">Loading available APIs...</option>
                                </select>
                                <small class="form-text text-muted">Only showing available API credentials for the selected exchange</small>
                            </div>
                            <div class="col-md-4">
                                <label class="form-label">&nbsp;</label>
                                <div>
                                    <a href="/api-library" target="_blank" class="btn btn-outline-info btn-sm">
                                        <i class="fas fa-plus"></i> Manage API Library
                                    </a>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Direct API Input -->
                    <div id="direct_api_section">
                        <div class="row mb-3">
                            <div class="col-md-6">
                                <label for="api_key" class="form-label">API Key *</label>
                                <input type="text" class="form-control" id="api_key" name="api_key" 
                                       placeholder="Your exchange API key">
                            </div>
                            <div class="col-md-6">
                                <label for="api_secret" class="form-label">API Secret *</label>
                                <input type="password" class="form-control" id="api_secret" name="api_secret" 
                                       placeholder="Your exchange API secret">
                            </div>
                        </div>
                        <div class="row mb-3">
                            <div class="col-md-6">
                                <label for="api_passphrase" class="form-label">API Passphrase</label>
                                <input type="password" class="form-control" id="api_passphrase" name="api_passphrase" 
                                       placeholder="Required for some exchanges (OKX, KuCoin)">
                                <small class="form-text text-muted">Only required for OKX and KuCoin</small>
                            </div>
                        </div>
                    </div>

                    <!-- Strategy Selection -->
                    <h5 class="mb-3">
                        <i class="fas fa-brain"></i>
                        Strategy Selection
                    </h5>
                    <div class="mb-3">
                        <label class="form-label">Select Strategies to Monitor</label>
                        <div class="row">
                            <div class="col-md-4">
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" value="DCA" id="strategy-dca">
                                    <label class="form-check-label" for="strategy-dca">
                                        DCA (Dollar Cost Average)
                                    </label>
                                </div>
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" value="Grid" id="strategy-grid">
                                    <label class="form-check-label" for="strategy-grid">
                                        Grid Trading
                                    </label>
                                </div>
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" value="Combo" id="strategy-combo">
                                    <label class="form-check-label" for="strategy-combo">
                                        Combo Strategy
                                    </label>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" value="Loop" id="strategy-loop">
                                    <label class="form-check-label" for="strategy-loop">
                                        Loop Strategy
                                    </label>
                                </div>
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" value="BTD" id="strategy-btd">
                                    <label class="form-check-label" for="strategy-btd">
                                        BTD (Buy The Dip)
                                    </label>
                                </div>
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" value="DCA Futures" id="strategy-dca-futures">
                                    <label class="form-check-label" for="strategy-dca-futures">
                                        DCA Futures
                                    </label>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" value="AIS Assisted" id="strategy-ais">
                                    <label class="form-check-label" for="strategy-ais">
                                        AIS Assisted
                                    </label>
                                </div>
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" value="TGLX" id="strategy-tglx">
                                    <label class="form-check-label" for="strategy-tglx">
                                        TGLX Strategy
                                    </label>
                                </div>
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" value="Cerberus" id="strategy-cerberus">
                                    <label class="form-check-label" for="strategy-cerberus">
                                        Cerberus Strategy
                                    </label>
                                </div>
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" value="Predators" id="strategy-predators">
                                    <label class="form-check-label" for="strategy-predators">
                                        Predators Strategy
                                    </label>
                                </div>
                            </div>
                        </div>
                        <small class="form-text text-muted">Leave all unchecked to monitor all strategies</small>
                    </div>

                    <!-- Notification Configuration -->
                    <h5 class="mb-3">
                        <i class="fas fa-bell"></i>
                        Notification Configuration
                    </h5>
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <label for="webhook_url" class="form-label">Webhook URL</label>
                            <input type="url" class="form-control" id="webhook_url" name="webhook_url" 
                                   placeholder="https://your-webhook-endpoint.com/webhook">
                        </div>
                        <div class="col-md-6">
                            <label for="telegram_bot_token" class="form-label">Telegram Bot Token</label>
                            <input type="text" class="form-control" id="telegram_bot_token" name="telegram_bot_token" 
                                   placeholder="123456789:ABCdefGHIjklMNOpqrsTUVwxyz">
                        </div>
                    </div>
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <label for="telegram_chat_id" class="form-label">Telegram Chat ID</label>
                            <input type="text" class="form-control" id="telegram_chat_id" name="telegram_chat_id" 
                                   placeholder="-1001234567890">
                        </div>
                        <div class="col-md-6">
                            <label for="telegram_topic_id" class="form-label">Telegram Topic ID (Optional)</label>
                            <input type="text" class="form-control" id="telegram_topic_id" name="telegram_topic_id" 
                                   placeholder="123">
                            <small class="form-text text-muted">Topic ID for threaded notifications in groups</small>
                        </div>
                    </div>

                    <div class="d-grid gap-2 d-md-flex justify-content-md-end">
                        <button type="button" class="btn btn-secondary me-md-2" onclick="window.location.href='/instances'">
                            Cancel
                        </button>
                        <button type="submit" class="btn btn-primary">
                            <i class="fas fa-save"></i>
                            Update Instance
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <div class="col-lg-4">
        <div class="card shadow">
            <div class="card-header py-3">
                <h6 class="m-0 font-weight-bold text-info">
                    <i class="fas fa-info-circle"></i>
                    Configuration Help
                </h6>
            </div>
            <div class="card-body">
                <h6>API Configuration</h6>
                <p class="small">
                    Create read-only API keys from your exchange. Never use keys with trading permissions.
                </p>

                <h6>Strategy Detection</h6>
                <p class="small">
                    The system will automatically detect strategy types based on symbol patterns and trading behavior.
                </p>

                <h6>Polling Interval</h6>
                <p class="small">
                    Lower intervals provide faster notifications but may hit rate limits. 60 seconds is recommended.
                </p>

                <h6>Telegram Setup</h6>
                <p class="small">
                    1. Create a bot with @BotFather<br>
                    2. Get your chat ID from @userinfobot<br>
                    3. Add the bot to your group/channel<br>
                    4. (Optional) Get topic ID for threaded notifications
                </p>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
let instanceId = null;

// Get instance ID from URL
function getInstanceId() {
    const pathParts = window.location.pathname.split('/');
    return pathParts[pathParts.length - 2]; // /instances/{id}/edit
}

// Toggle API source sections
function toggleApiSource() {
    const useLibrary = document.getElementById('use_library').checked;
    const librarySection = document.getElementById('api_library_section');
    const directSection = document.getElementById('direct_api_section');
    
    if (useLibrary) {
        librarySection.style.display = 'block';
        directSection.style.display = 'none';
        // Remove required attribute from direct fields
        document.getElementById('api_key').removeAttribute('required');
        document.getElementById('api_secret').removeAttribute('required');
    } else {
        librarySection.style.display = 'none';
        directSection.style.display = 'block';
        // Add required attribute to direct fields
        document.getElementById('api_key').setAttribute('required', '');
        document.getElementById('api_secret').setAttribute('required', '');
    }
    
    // Load available API credentials when library is selected
    if (useLibrary) {
        loadAvailableCredentials();
    }
}

// Load available API credentials for the selected exchange
function loadAvailableCredentials() {
    const exchange = document.getElementById('exchange').value;
    const credentialSelect = document.getElementById('api_credential_id');
    
    if (!exchange) {
        credentialSelect.innerHTML = '<option value="">Please select an exchange first</option>';
        return;
    }
    
    credentialSelect.innerHTML = '<option value="">Loading...</option>';
    
    const token = localStorage.getItem('access_token');
    fetch('/api/api-credentials', {
        headers: {
            'Authorization': 'Bearer ' + token
        }
    })
    .then(response => response.json())
    .then(credentials => {
        credentialSelect.innerHTML = '<option value="">Select API Credential</option>';
        
        // Filter credentials for the selected exchange
        const filteredCredentials = credentials.filter(cred => 
            cred.exchange.toLowerCase() === exchange.toLowerCase() && 
            cred.is_active && 
            !cred.is_in_use
        );
        
        // Add the currently used credential if editing an instance that uses library
        const currentCredentialId = credentialSelect.dataset.currentId;
        if (currentCredentialId) {
            const currentCred = credentials.find(cred => cred.id == currentCredentialId);
            if (currentCred) {
                filteredCredentials.unshift(currentCred);
            }
        }
        
        filteredCredentials.forEach(credential => {
            const option = document.createElement('option');
            option.value = credential.id;
            option.textContent = `${credential.name} (${credential.exchange})`;
            credentialSelect.appendChild(option);
        });
        
        // Select current credential if editing
        if (currentCredentialId) {
            credentialSelect.value = currentCredentialId;
        }
        
        if (filteredCredentials.length === 0) {
            const option = document.createElement('option');
            option.value = '';
            option.textContent = `No available ${exchange} credentials - create one in API Library`;
            credentialSelect.appendChild(option);
        }
    })
    .catch(error => {
        console.error('Error loading API credentials:', error);
        credentialSelect.innerHTML = '<option value="">Error loading credentials</option>';
    });
}

// Load instance data
function loadInstanceData() {
    instanceId = getInstanceId();
    const token = localStorage.getItem('access_token');
    
    fetch(`/api/instances`, {
        headers: {
            'Authorization': 'Bearer ' + token
        }
    })
    .then(response => response.json())
    .then(instances => {
        const instance = instances.find(i => i.id == instanceId);
        if (!instance) {
            alert('Instance not found!');
            window.location.href = '/instances';
            return;
        }
        
        // Populate basic form fields
        document.getElementById('name').value = instance.name || '';
        document.getElementById('exchange').value = instance.exchange || '';
        document.getElementById('polling_interval').value = instance.polling_interval || 60;
        document.getElementById('webhook_url').value = instance.webhook_url || '';
        document.getElementById('telegram_bot_token').value = instance.telegram_bot_token || '';
        document.getElementById('telegram_chat_id').value = instance.telegram_chat_id || '';
        document.getElementById('telegram_topic_id').value = instance.telegram_topic_id || '';
        document.getElementById('trading_pair').value = instance.trading_pair || '';
        document.getElementById('market_type').value = instance.market_type || 'unified';
        
        // Determine API source based on instance data
        const usesLibrary = instance.api_credential_id && !instance.api_key;
        
        if (usesLibrary) {
            // Instance uses API library
            document.getElementById('use_library').checked = true;
            document.getElementById('use_direct').checked = false;
            
            // Store current credential ID for later use
            document.getElementById('api_credential_id').dataset.currentId = instance.api_credential_id;
            
            // Show library section, hide direct section
            document.getElementById('api_library_section').style.display = 'block';
            document.getElementById('direct_api_section').style.display = 'none';
            
            // Load available credentials and select current one
            loadAvailableCredentials();
        } else {
            // Instance uses direct API credentials
            document.getElementById('use_library').checked = false;
            document.getElementById('use_direct').checked = true;
            
            // Populate direct API fields
            document.getElementById('api_key').value = instance.api_key || '';
            document.getElementById('api_secret').value = instance.api_secret || '';
            document.getElementById('api_passphrase').value = instance.api_passphrase || '';
            
            // Show direct section, hide library section
            document.getElementById('api_library_section').style.display = 'none';
            document.getElementById('direct_api_section').style.display = 'block';
            
            // Add required attributes to direct fields
            document.getElementById('api_key').setAttribute('required', '');
            document.getElementById('api_secret').setAttribute('required', '');
        }
        
        // Set strategies checkboxes
        const strategies = instance.strategies || [];
        document.querySelectorAll('input[type="checkbox"][id^="strategy-"]').forEach(checkbox => {
            checkbox.checked = strategies.includes(checkbox.value);
        });
    })
    .catch(error => {
        alert('Error loading instance data: ' + error);
    });
}

// Add event listeners
document.addEventListener('DOMContentLoaded', function() {
    // Load instance data
    loadInstanceData();
    
    // Add event listeners for API source radio buttons
    document.getElementById('use_library').addEventListener('change', toggleApiSource);
    document.getElementById('use_direct').addEventListener('change', toggleApiSource);
    
    // Add event listener for exchange selection to reload credentials
    document.getElementById('exchange').addEventListener('change', function() {
        if (document.getElementById('use_library').checked) {
            loadAvailableCredentials();
        }
    });
});

document.getElementById('instance-form').addEventListener('submit', function(e) {
    e.preventDefault();
    
    // Validate required fields based on API source
    const apiSource = document.querySelector('input[name="api_source"]:checked');
    if (!apiSource) {
        alert('Please select an API source (Library or Direct)');
        return;
    }
    
    if (apiSource.value === 'direct') {
        const apiKey = document.getElementById('api_key').value.trim();
        const apiSecret = document.getElementById('api_secret').value.trim();
        if (!apiKey || !apiSecret) {
            alert('API key and secret are required for direct mode');
            return;
        }
    } else if (apiSource.value === 'library') {
        const credentialId = document.getElementById('api_credential_id').value;
        if (!credentialId) {
            alert('Please select an API credential from the library');
            return;
        }
    }
    
    // Collect selected strategies (only from strategy checkboxes)
    const strategies = [];
    document.querySelectorAll('input[type="checkbox"][id^="strategy-"]:checked').forEach(checkbox => {
        strategies.push(checkbox.value);
    });
    
    // Create form data
    const formData = new FormData(this);
    formData.set('strategies', strategies.join(','));
    
    // Ensure api_source is included
    formData.set('api_source', apiSource.value);
    
    // Debug: Log form data
    console.log('Form data being submitted:');
    for (let [key, value] of formData.entries()) {
        console.log(key + ': ' + value);
    }
    
    // Submit form
    const token = localStorage.getItem('access_token');
    fetch(`/api/instances/${instanceId}`, {
        method: 'PUT',
        headers: {
            'Authorization': 'Bearer ' + token
        },
        body: formData
    })
    .then(response => {
        console.log('Response status:', response.status);
        return response.json();
    })
    .then(data => {
        console.log('Response data:', data);
        if (data.instance_id || data.message) {
            alert('Instance updated successfully!');
            window.location.href = '/instances';
        } else if (data.detail) {
            alert('Error: ' + data.detail);
        } else {
            alert('Instance updated successfully!');
            window.location.href = '/instances';
        }
    })
    .catch(error => {
        console.error('Fetch error:', error);
        alert('Error updating instance: ' + error);
    });
});
</script>
{% endblock %}
