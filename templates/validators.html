{% extends "base.html" %}

{% block title %}Validator Nodes - Tar Global Strategies{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="row">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <h2><i class="fas fa-server text-success"></i> Validator Node Monitor</h2>
                <button class="btn btn-success" data-bs-toggle="modal" data-bs-target="#createValidatorModal">
                    <i class="fas fa-plus"></i> New Validator Node
                </button>
            </div>
        </div>
    </div>

    <!-- Stats Cards -->
    <div class="row mb-4">
        <div class="col-md-3">
            <div class="card bg-success text-white">
                <div class="card-body">
                    <div class="d-flex justify-content-between">
                        <div>
                            <h6 class="card-title">Total Nodes</h6>
                            <h3 id="totalNodes">0</h3>
                        </div>
                        <div class="align-self-center">
                            <i class="fas fa-server fa-2x"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card bg-primary text-white">
                <div class="card-body">
                    <div class="d-flex justify-content-between">
                        <div>
                            <h6 class="card-title">Active Nodes</h6>
                            <h3 id="activeNodes">0</h3>
                        </div>
                        <div class="align-self-center">
                            <i class="fas fa-check-circle fa-2x"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card bg-warning text-white">
                <div class="card-body">
                    <div class="d-flex justify-content-between">
                        <div>
                            <h6 class="card-title">Total Staked</h6>
                            <h3 id="totalStaked">$0</h3>
                        </div>
                        <div class="align-self-center">
                            <i class="fas fa-coins fa-2x"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card bg-info text-white">
                <div class="card-body">
                    <div class="d-flex justify-content-between">
                        <div>
                            <h6 class="card-title">Total Rewards</h6>
                            <h3 id="totalRewards">$0</h3>
                        </div>
                        <div class="align-self-center">
                            <i class="fas fa-trophy fa-2x"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Blockchain Tabs -->
    <div class="row">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <ul class="nav nav-tabs card-header-tabs" id="blockchainTabs">
                        <li class="nav-item">
                            <a class="nav-link active" data-bs-toggle="tab" href="#allNodes">All Nodes</a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" data-bs-toggle="tab" href="#tonNodes">TON Blockchain</a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" data-bs-toggle="tab" href="#solanaNodes">Solana (Alpha)</a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" data-bs-toggle="tab" href="#ethereumNodes">Ethereum (Epsilon)</a>
                        </li>
                    </ul>
                </div>
                <div class="card-body">
                    <div class="tab-content">
                        <!-- All Nodes Tab -->
                        <div class="tab-pane fade show active" id="allNodes">
                            <div class="table-responsive">
                                <table class="table table-striped" id="validatorsTable">
                                    <thead>
                                        <tr>
                                            <th>Name</th>
                                            <th>Blockchain</th>
                                            <th>Strategy</th>
                                            <th>Staked Amount</th>
                                            <th>Current APY</th>
                                            <th>Uptime</th>
                                            <th>Status</th>
                                            <th>Last Check</th>
                                            <th>Actions</th>
                                        </tr>
                                    </thead>
                                    <tbody id="validatorsTableBody">
                                        <!-- Dynamic content -->
                                    </tbody>
                                </table>
                            </div>
                        </div>
                        
                        <!-- TON Nodes Tab -->
                        <div class="tab-pane fade" id="tonNodes">
                            <div id="tonNodesContent">
                                <!-- TON-specific content -->
                            </div>
                        </div>
                        
                        <!-- Solana Nodes Tab -->
                        <div class="tab-pane fade" id="solanaNodes">
                            <div id="solanaNodesContent">
                                <!-- Solana-specific content -->
                            </div>
                        </div>
                        
                        <!-- Ethereum Nodes Tab -->
                        <div class="tab-pane fade" id="ethereumNodes">
                            <div id="ethereumNodesContent">
                                <!-- Ethereum-specific content -->
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Performance Charts -->
    <div class="row mt-4">
        <div class="col-md-6">
            <div class="card">
                <div class="card-header">
                    <h5><i class="fas fa-chart-line"></i> APY Performance</h5>
                </div>
                <div class="card-body">
                    <canvas id="apyChart" height="200"></canvas>
                </div>
            </div>
        </div>
        <div class="col-md-6">
            <div class="card">
                <div class="card-header">
                    <h5><i class="fas fa-chart-bar"></i> Rewards Distribution</h5>
                </div>
                <div class="card-body">
                    <canvas id="rewardsChart" height="200"></canvas>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Create Validator Node Modal -->
<div class="modal fade" id="createValidatorModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Create Validator Node</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="createValidatorForm">
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label class="form-label">Node Name</label>
                                <input type="text" class="form-control" name="name" required>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label class="form-label">Blockchain</label>
                                <select class="form-select" name="blockchain" required>
                                    <option value="">Select Blockchain</option>
                                    <option value="ton">TON Blockchain</option>
                                    <option value="solana">Solana</option>
                                    <option value="ethereum">Ethereum</option>
                                </select>
                            </div>
                        </div>
                    </div>
                    
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label class="form-label">Strategy Name</label>
                                <input type="text" class="form-control" name="strategy_name" placeholder="Alpha, Epsilon, etc." required>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label class="form-label">Node Address</label>
                                <input type="text" class="form-control" name="node_address" required>
                            </div>
                        </div>
                    </div>
                    
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label class="form-label">Staking Amount</label>
                                <input type="number" class="form-control" name="staking_amount" step="0.01" min="0" required>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label class="form-label">Delegated Amount</label>
                                <input type="number" class="form-control" name="delegated_amount" step="0.01" min="0" value="0">
                            </div>
                        </div>
                    </div>
                    
                    <div class="row">
                        <div class="col-md-4">
                            <div class="mb-3">
                                <label class="form-label">Min Uptime Alert (%)</label>
                                <input type="number" class="form-control" name="min_uptime_alert" value="95" min="0" max="100">
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="mb-3">
                                <label class="form-label">Max Missed Blocks</label>
                                <input type="number" class="form-control" name="max_missed_blocks_alert" value="10" min="0">
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="mb-3">
                                <label class="form-label">Min APY Alert (%)</label>
                                <input type="number" class="form-control" name="min_apy_alert" value="5" step="0.1" min="0">
                            </div>
                        </div>
                    </div>
                    
                    <div class="mb-3">
                        <label class="form-label">Description</label>
                        <textarea class="form-control" name="description" rows="2"></textarea>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-success" onclick="createValidatorNode()">Create Node</button>
            </div>
        </div>
    </div>
</div>

<script>
let validatorNodes = [];
let overview = {};

// Load data on page load
document.addEventListener('DOMContentLoaded', function() {
    loadValidatorData();
    loadOverview();
    
    // Auto-refresh every 60 seconds
    setInterval(() => {
        loadValidatorData();
        loadOverview();
    }, 60000);
});

async function loadValidatorData() {
    try {
        const response = await fetch('/api/validators/nodes');
        if (response.ok) {
            validatorNodes = await response.json();
            updateValidatorsTable();
            updateBlockchainTabs();
        }
    } catch (error) {
        console.error('Error loading validator data:', error);
    }
}

async function loadOverview() {
    try {
        const response = await fetch('/api/validators/overview');
        if (response.ok) {
            overview = await response.json();
            updateOverviewStats();
        }
    } catch (error) {
        console.error('Error loading overview:', error);
    }
}

function updateOverviewStats() {
    document.getElementById('totalNodes').textContent = overview.total_nodes || 0;
    document.getElementById('activeNodes').textContent = overview.active_nodes || 0;
    document.getElementById('totalStaked').textContent = `$${(overview.total_staked || 0).toFixed(0)}`;
    document.getElementById('totalRewards').textContent = `$${(overview.total_rewards || 0).toFixed(2)}`;
}

function updateValidatorsTable() {
    const tbody = document.getElementById('validatorsTableBody');
    tbody.innerHTML = '';
    
    validatorNodes.forEach(node => {
        const row = document.createElement('tr');
        const statusClass = getStatusClass(node.node_status);
        const uptimeClass = node.uptime_percentage >= 95 ? 'text-success' : 'text-warning';
        
        row.innerHTML = `
            <td><strong>${node.name}</strong></td>
            <td><span class="badge bg-secondary">${node.blockchain.toUpperCase()}</span></td>
            <td>${node.strategy_name}</td>
            <td>$${parseFloat(node.total_stake).toFixed(2)}</td>
            <td><span class="text-success">${node.current_apy.toFixed(2)}%</span></td>
            <td><span class="${uptimeClass}">${node.uptime_percentage.toFixed(1)}%</span></td>
            <td>
                <span class="badge ${statusClass}">
                    ${node.node_status.charAt(0).toUpperCase() + node.node_status.slice(1)}
                </span>
            </td>
            <td>${node.last_check ? new Date(node.last_check).toLocaleString() : 'Never'}</td>
            <td>
                <div class="btn-group btn-group-sm">
                    <button class="btn btn-outline-info" onclick="viewNodeDetails(${node.id})">
                        <i class="fas fa-eye"></i>
                    </button>
                    <button class="btn btn-outline-primary" onclick="viewRewards(${node.id})">
                        <i class="fas fa-coins"></i>
                    </button>
                    <button class="btn btn-outline-danger" onclick="deleteNode(${node.id})">
                        <i class="fas fa-trash"></i>
                    </button>
                </div>
            </td>
        `;
        tbody.appendChild(row);
    });
}

function updateBlockchainTabs() {
    // Update TON nodes
    const tonNodes = validatorNodes.filter(n => n.blockchain === 'ton');
    updateBlockchainTab('tonNodesContent', tonNodes, 'TON');
    
    // Update Solana nodes
    const solanaNodes = validatorNodes.filter(n => n.blockchain === 'solana');
    updateBlockchainTab('solanaNodesContent', solanaNodes, 'Solana');
    
    // Update Ethereum nodes
    const ethereumNodes = validatorNodes.filter(n => n.blockchain === 'ethereum');
    updateBlockchainTab('ethereumNodesContent', ethereumNodes, 'Ethereum');
}

function updateBlockchainTab(containerId, nodes, blockchain) {
    const container = document.getElementById(containerId);
    
    if (nodes.length === 0) {
        container.innerHTML = `
            <div class="text-center py-4">
                <i class="fas fa-server fa-3x text-muted mb-3"></i>
                <h5>No ${blockchain} Validators</h5>
                <p class="text-muted">Create your first ${blockchain} validator node to get started.</p>
            </div>
        `;
        return;
    }
    
    let html = '<div class="row">';
    nodes.forEach(node => {
        const statusClass = getStatusClass(node.node_status);
        html += `
            <div class="col-md-6 mb-3">
                <div class="card">
                    <div class="card-body">
                        <div class="d-flex justify-content-between align-items-start">
                            <div>
                                <h6 class="card-title">${node.name}</h6>
                                <p class="text-muted mb-1">Strategy: ${node.strategy_name}</p>
                                <p class="text-muted mb-2">Staked: $${parseFloat(node.total_stake).toFixed(2)}</p>
                            </div>
                            <span class="badge ${statusClass}">${node.node_status}</span>
                        </div>
                        <div class="row text-center mt-3">
                            <div class="col-4">
                                <small class="text-muted">APY</small>
                                <div class="text-success"><strong>${node.current_apy.toFixed(2)}%</strong></div>
                            </div>
                            <div class="col-4">
                                <small class="text-muted">Uptime</small>
                                <div class="${node.uptime_percentage >= 95 ? 'text-success' : 'text-warning'}">
                                    <strong>${node.uptime_percentage.toFixed(1)}%</strong>
                                </div>
                            </div>
                            <div class="col-4">
                                <small class="text-muted">Rewards</small>
                                <div class="text-info"><strong>$${node.total_rewards_earned.toFixed(2)}</strong></div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        `;
    });
    html += '</div>';
    
    container.innerHTML = html;
}

function getStatusClass(status) {
    switch (status.toLowerCase()) {
        case 'active': return 'bg-success';
        case 'inactive': return 'bg-secondary';
        case 'jailed': return 'bg-danger';
        case 'slashed': return 'bg-danger';
        default: return 'bg-warning';
    }
}

async function createValidatorNode() {
    const form = document.getElementById('createValidatorForm');
    const formData = new FormData(form);
    const data = Object.fromEntries(formData.entries());
    
    try {
        const response = await fetch('/api/validators/nodes', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify(data)
        });
        
        if (response.ok) {
            const result = await response.json();
            alert('Validator node created successfully!');
            bootstrap.Modal.getInstance(document.getElementById('createValidatorModal')).hide();
            form.reset();
            loadValidatorData();
            loadOverview();
        } else {
            const error = await response.json();
            alert(`Error: ${error.detail}`);
        }
    } catch (error) {
        console.error('Error creating validator node:', error);
        alert('Error creating validator node');
    }
}

async function deleteNode(nodeId) {
    if (!confirm('Are you sure you want to delete this validator node?')) {
        return;
    }
    
    try {
        const response = await fetch(`/api/validators/nodes/${nodeId}`, {
            method: 'DELETE'
        });
        
        if (response.ok) {
            loadValidatorData();
            loadOverview();
        } else {
            const error = await response.json();
            alert(`Error: ${error.detail}`);
        }
    } catch (error) {
        console.error('Error deleting validator node:', error);
        alert('Error deleting validator node');
    }
}

function viewNodeDetails(nodeId) {
    // TODO: Implement node detail view
    alert('Node detail view coming soon!');
}

function viewRewards(nodeId) {
    // TODO: Implement rewards view
    alert('Rewards view coming soon!');
}
</script>
{% endblock %}
