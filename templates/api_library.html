{% extends "base.html" %}

{% block title %}API Library - TGL MEDUSA{% endblock %}

{% block content %}
<style>
.form-control {
    background-color: var(--secondary-black);
    border: 1px solid var(--medium-gray);
    color: var(--white);
}

.form-control:focus {
    background-color: var(--secondary-black);
    color: var(--white);
    border-color: var(--accent-blue);
    box-shadow: 0 0 0 0.2rem rgba(0, 123, 255, 0.25);
}

.modal-content {
    background-color: var(--secondary-black);
    border: 1px solid var(--medium-gray);
    color: var(--white);
}

.modal-header {
    border-bottom: 1px solid var(--medium-gray);
}

.modal-footer {
    border-top: 1px solid var(--medium-gray);
}

.btn-secondary {
    background-color: var(--medium-gray);
    border-color: var(--medium-gray);
    color: var(--white);
}

.btn-secondary:hover {
    background-color: var(--light-gray);
    border-color: var(--light-gray);
    color: var(--white);
}

.badge-in-use {
    background-color: #dc3545;
}

.badge-available {
    background-color: #28a745;
}

.badge-inactive {
    background-color: #6c757d;
}

/* Custom Modal Styling */
.custom-modal-overlay {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background-color: rgba(0, 0, 0, 0.5);
    z-index: 9999;
    display: none;
    align-items: center;
    justify-content: center;
}

.custom-modal-overlay.show {
    display: flex;
}

.custom-modal {
    background-color: var(--secondary-black);
    border: 1px solid var(--medium-gray);
    border-radius: 8px;
    color: var(--white);
    max-width: 90%;
    width: 800px;
    max-height: 90%;
    overflow-y: auto;
    position: relative;
}

.custom-modal-header {
    padding: 1rem 1.5rem;
    border-bottom: 1px solid var(--medium-gray);
    display: flex;
    justify-content: space-between;
    align-items: center;
}

.custom-modal-body {
    padding: 1.5rem;
}

.custom-modal-footer {
    padding: 1rem 1.5rem;
    border-top: 1px solid var(--medium-gray);
    display: flex;
    justify-content: flex-end;
    gap: 0.5rem;
}

.custom-modal .form-control, .custom-modal .form-select {
    background-color: var(--secondary-black);
    border: 1px solid var(--medium-gray);
    color: var(--white);
}

.custom-modal .form-control:focus, .custom-modal .form-select:focus {
    background-color: var(--secondary-black);
    color: var(--white);
    border-color: var(--accent-blue);
    box-shadow: 0 0 0 0.2rem rgba(0, 123, 255, 0.25);
}

.close-btn {
    background: none;
    border: none;
    color: var(--white);
    font-size: 1.5rem;
    cursor: pointer;
    padding: 0;
    width: 32px;
    height: 32px;
    display: flex;
    align-items: center;
    justify-content: center;
}

.close-btn:hover {
    background-color: var(--medium-gray);
    border-radius: 4px;
}
</style>

<div class="container">
    <div class="row">
        <div class="col-md-12">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <div>
                    <h2><i class="fas fa-key"></i> API Library</h2>
                    <p class="text-muted">Manage reusable API credentials for your bot instances</p>
                </div>
                <button class="btn btn-primary" onclick="showCustomModal()">
                    <i class="fas fa-plus"></i> Add API Credential
                </button>
            </div>
            
            <!-- API Credentials Table -->
            <div class="card">
                <div class="card-header">
                    <h5>Saved API Credentials</h5>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-striped">
                            <thead>
                                <tr>
                                    <th>Name</th>
                                    <th>Exchange</th>
                                    <th>API Key</th>
                                    <th>Status</th>
                                    <th>Currently Used By</th>
                                    <th>Tags</th>
                                    <th>Created</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody id="credentials-table-body">
                                {% if api_credentials %}
                                {% for credential in api_credentials %}
                                <tr id="credential-{{ credential.id }}">
                                    <td>
                                        <strong>{{ credential.name }}</strong>
                                        {% if credential.description %}
                                        <br><small class="text-muted">{{ credential.description }}</small>
                                        {% endif %}
                                    </td>
                                    <td>
                                        <span class="badge badge-info">{{ credential.exchange.upper() }}</span>
                                    </td>
                                    <td>
                                        <code>{{ credential.api_key[:8] }}...{{ credential.api_key[-4:] if credential.api_key|length > 12 else credential.api_key }}</code>
                                        {% if credential.api_passphrase %}
                                        <br><small class="text-info"><i class="fas fa-shield-alt"></i> Has Passphrase</small>
                                        {% endif %}
                                    </td>
                                    <td>
                                        {% if not credential.is_active %}
                                        <span class="badge badge-inactive">Inactive</span>
                                        {% elif credential.is_in_use %}
                                        <span class="badge badge-in-use">In Use</span>
                                        {% else %}
                                        <span class="badge badge-available">Available</span>
                                        {% endif %}
                                    </td>
                                    <td>
                                        {% if credential.current_instance_name %}
                                        <strong>{{ credential.current_instance_name }}</strong>
                                        {% else %}
                                        <span class="text-muted">None</span>
                                        {% endif %}
                                    </td>
                                    <td>
                                        {% if credential.tags %}
                                        {% for tag in credential.tags.split(',') %}
                                        <span class="badge badge-secondary">{{ tag.strip() }}</span>
                                        {% endfor %}
                                        {% else %}
                                        <span class="text-muted">None</span>
                                        {% endif %}
                                    </td>
                                    <td>
                                        <small class="text-muted">{{ credential.created_at.strftime('%Y-%m-%d') }}</small>
                                    </td>
                                    <td>
                                        <div class="btn-group" role="group">
                                            <button class="btn btn-sm btn-outline-warning" onclick="editCredential({{ credential.id }})">
                                                <i class="fas fa-edit"></i>
                                            </button>
                                            {% if credential.is_in_use %}
                                            <button class="btn btn-sm btn-outline-info" onclick="unassignCredential({{ credential.id }}, '{{ credential.name }}')">
                                                <i class="fas fa-unlink"></i> Unassign
                                            </button>
                                            {% endif %}
                                            <button class="btn btn-sm btn-outline-danger" onclick="deleteCredential({{ credential.id }}, '{{ credential.name }}', {{ credential.is_in_use|lower }})">
                                                <i class="fas fa-trash"></i>
                                            </button>
                                        </div>
                                    </td>
                                </tr>
                                {% endfor %}
                                {% else %}
                                <tr>
                                    <td colspan="8" class="text-center text-muted">
                                        <i class="fas fa-info-circle"></i>
                                        No API credentials found. <a href="#" onclick="showCustomModal()">Create one now</a>.
                                    </td>
                                </tr>
                                {% endif %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Custom Create API Credential Modal -->
<div class="custom-modal-overlay" id="createCredentialModal">
    <div class="custom-modal">
        <div class="custom-modal-header">
            <h5>Add API Credential</h5>
            <button type="button" class="close-btn" onclick="hideCustomModal()">
                <i class="fas fa-times"></i>
            </button>
        </div>
        <form id="createCredentialForm">
            <div class="custom-modal-body">
                    <div class="row">
                        <div class="col-md-6">
                            <div class="form-group">
                                <label for="name">Name *</label>
                                <input type="text" class="form-control" id="name" name="name" required 
                                       placeholder="e.g., Main Bybit Account">
                                <small class="form-text text-muted">Descriptive name for this API credential</small>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="form-group">
                                <label for="exchange">Exchange *</label>
                                <select class="form-select" id="exchange" name="exchange" required>
                                    <option value="">Select Exchange</option>
                                    <option value="binance">Binance</option>
                                    <option value="bitget">Bitget</option>
                                    <option value="bybit">Bybit</option>
                                    <option value="okx">OKX</option>
                                    <option value="kucoin">KuCoin</option>
                                    <option value="mexc">MEXC</option>
                                    <option value="gateio">Gate.io</option>
                                    <option value="coinbasepro">Coinbase Pro</option>
                                    <option value="bitfinex">Bitfinex</option>
                                </select>
                            </div>
                        </div>
                    </div>
                    
                    <div class="row">
                        <div class="col-md-6">
                            <div class="form-group">
                                <label for="api_key">API Key *</label>
                                <input type="text" class="form-control" id="api_key" name="api_key" required 
                                       placeholder="Your exchange API key">
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="form-group">
                                <label for="api_secret">API Secret *</label>
                                <input type="password" class="form-control" id="api_secret" name="api_secret" required 
                                       placeholder="Your exchange API secret">
                            </div>
                        </div>
                    </div>
                    
                    <div class="row">
                        <div class="col-md-6">
                            <div class="form-group">
                                <label for="api_passphrase">API Passphrase</label>
                                <input type="password" class="form-control" id="api_passphrase" name="api_passphrase" 
                                       placeholder="Required for OKX and KuCoin">
                                <small class="form-text text-muted">Only required for OKX and KuCoin</small>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="form-group">
                                <label for="tags">Tags</label>
                                <input type="text" class="form-control" id="tags" name="tags" 
                                       placeholder="e.g., production, test, low-risk">
                                <small class="form-text text-muted">Comma-separated tags for organization</small>
                            </div>
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label for="description">Description</label>
                        <textarea class="form-control" id="description" name="description" rows="2" 
                                  placeholder="Optional description for this API credential"></textarea>
                    </div>
                </div>
                <div class="custom-modal-footer">
                    <button type="button" class="btn btn-secondary" onclick="hideCustomModal()">Cancel</button>
                    <button type="submit" class="btn btn-primary">Create API Credential</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Edit API Credential Modal -->
<div class="custom-modal-overlay" id="editCredentialModal">
    <div class="custom-modal">
        <div class="custom-modal-header">
            <h5>Edit API Credential</h5>
            <button type="button" class="close-btn" onclick="hideEditModal()">
                <i class="fas fa-times"></i>
            </button>
        </div>
            <form id="editCredentialForm">
                <div class="custom-modal-body">
                    <input type="hidden" id="edit_credential_id">
                    
                    <div class="form-group">
                        <label for="edit_name">Name</label>
                        <input type="text" class="form-control" id="edit_name" name="name">
                    </div>
                    
                    <div class="form-group">
                        <label for="edit_description">Description</label>
                        <textarea class="form-control" id="edit_description" name="description" rows="2"></textarea>
                    </div>
                    
                    <div class="form-group">
                        <label for="edit_tags">Tags</label>
                        <input type="text" class="form-control" id="edit_tags" name="tags" 
                               placeholder="Comma-separated tags">
                    </div>
                    
                    <div class="form-check">
                        <input class="form-check-input" type="checkbox" id="edit_is_active" name="is_active">
                        <label class="form-check-label" for="edit_is_active">
                            Active
                        </label>
                        <small class="form-text text-muted">Inactive credentials cannot be assigned to instances</small>
                    </div>
                </div>
                <div class="custom-modal-footer">
                    <button type="button" class="btn btn-secondary" onclick="hideEditModal()">Cancel</button>
                    <button type="submit" class="btn btn-primary">Save Changes</button>
                </div>
            </form>
        </div>
    </div>
</div>

<script>
document.getElementById('createCredentialForm').addEventListener('submit', function(e) {
    e.preventDefault();
    
    const submitBtn = this.querySelector('button[type="submit"]');
    const originalText = submitBtn.textContent;
    submitBtn.disabled = true;
    submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Creating...';
    
    const formData = new FormData(this);
    
    fetch('/api/api-credentials', {
        method: 'POST',
        credentials: 'include',
        body: formData
    })
    .then(response => {
        if (response.status === 401 || response.status === 302) {
            alert('Session expired. Please log in again.');
            window.location.href = '/login';
            return;
        }
        return response.json();
    })
         .then(data => {
         if (!data) return;
         if (data.message) {
             hideCustomModal();
             alert(data.message);
             location.reload();
         } else if (data.detail) {
             alert('Error: ' + data.detail);
         }
     })
    .catch(error => {
        console.error('Error:', error);
        alert('Failed to create API credential');
    })
    .finally(() => {
        // Reset button state
        submitBtn.disabled = false;
        submitBtn.textContent = originalText;
    });
});

function editCredential(credentialId) {
    // Fetch credential details
    fetch('/api/api-credentials', {
        credentials: 'include'
    })
    .then(response => response.json())
    .then(credentials => {
        const credential = credentials.find(c => c.id === credentialId);
        if (credential) {
            document.getElementById('edit_credential_id').value = credential.id;
            document.getElementById('edit_name').value = credential.name;
            document.getElementById('edit_description').value = credential.description || '';
            document.getElementById('edit_tags').value = credential.tags ? credential.tags.join(', ') : '';
            document.getElementById('edit_is_active').checked = credential.is_active;
            
            document.getElementById('editCredentialModal').classList.add('show');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('Failed to load credential details');
    });
}

document.getElementById('editCredentialForm').addEventListener('submit', function(e) {
    e.preventDefault();
    
    const credentialId = document.getElementById('edit_credential_id').value;
    const formData = new FormData(this);
    
    fetch(`/api/api-credentials/${credentialId}`, {
        method: 'PUT',
        credentials: 'include',
        body: formData
    })
    .then(response => response.json())
    .then(data => {
        if (data.message) {
            hideEditModal();
            alert(data.message);
            location.reload();
        } else if (data.detail) {
            alert('Error: ' + data.detail);
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('Failed to update API credential');
    });
});

function unassignCredential(credentialId, credentialName) {
    if (!confirm(`Unassign API credential "${credentialName}"? The instance using it will be stopped.`)) return;
    
    fetch(`/api/api-credentials/${credentialId}/unassign`, {
        method: 'POST',
        credentials: 'include',
        headers: {
            'Content-Type': 'application/json'
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.message) {
            alert(data.message);
            location.reload();
        } else if (data.detail) {
            alert('Error: ' + data.detail);
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('Failed to unassign API credential');
    });
}

function deleteCredential(credentialId, credentialName, isInUse) {
    if (isInUse) {
        alert('Cannot delete API credential that is currently in use. Unassign it first.');
        return;
    }
    
    if (!confirm(`Delete API credential "${credentialName}"? This action cannot be undone.`)) return;
    
    fetch(`/api/api-credentials/${credentialId}`, {
        method: 'DELETE',
        credentials: 'include',
        headers: {
            'Content-Type': 'application/json'
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.message) {
            alert(data.message);
            location.reload();
        } else if (data.detail) {
            alert('Error: ' + data.detail);
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('Failed to delete API credential');
    });
}

// Load credentials on page load
function loadCredentials() {
    fetch('/api/api-credentials', {
        method: 'GET',
        credentials: 'include'
    })
    .then(response => {
        if (response.status === 401 || response.status === 302) {
            window.location.href = '/login';
            return;
        }
        return response.json();
    })
    .then(credentials => {
        if (!credentials) return;
        const tbody = document.getElementById('credentials-table-body');
        if (!tbody) return;
        
        if (credentials.length === 0) {
            tbody.innerHTML = `
                <tr>
                    <td colspan="8" class="text-center text-muted">
                                                 <i class="fas fa-key"></i>
                         No API credentials found. <a href="#" onclick="showCustomModal()">Create one now</a>.
                    </td>
                </tr>
            `;
            return;
        }
        
        tbody.innerHTML = credentials.map(credential => `
            <tr id="credential-${credential.id}">
                <td>
                    <strong>${credential.name}</strong>
                    ${credential.description ? `<br><small class="text-muted">${credential.description}</small>` : ''}
                </td>
                <td>
                    <span class="badge badge-info">${credential.exchange.toUpperCase()}</span>
                </td>
                <td>
                    <code>${credential.api_key.substring(0, 8)}...${credential.api_key.slice(-4)}</code>
                    ${credential.api_passphrase ? '<br><small class="text-info"><i class="fas fa-shield-alt"></i> Has Passphrase</small>' : ''}
                </td>
                <td>
                    ${!credential.is_active ? '<span class="badge badge-inactive">Inactive</span>' : 
                      credential.is_in_use ? '<span class="badge badge-in-use">In Use</span>' : 
                      '<span class="badge badge-available">Available</span>'}
                </td>
                <td>
                    ${credential.current_instance_name ? 
                      `<a href="/instances/${credential.current_instance_id}" class="text-info">${credential.current_instance_name}</a>` : 
                      '<span class="text-muted">-</span>'}
                </td>
                <td>
                    ${credential.tags && typeof credential.tags === 'string' ? 
                      credential.tags.split(',').map(tag => `<span class="badge badge-secondary">${tag.trim()}</span>`).join(' ') : 
                      '<span class="text-muted">-</span>'}
                </td>
                <td>
                    <small class="text-muted">${credential.created_at ? new Date(credential.created_at).toLocaleDateString() : '-'}</small>
                </td>
                <td>
                    <div class="btn-group" role="group">
                        <button type="button" class="btn btn-sm btn-outline-primary" 
                                onclick="editCredential(${credential.id})"
                                title="Edit">
                            <i class="fas fa-edit"></i>
                        </button>
                        ${credential.is_in_use ? `
                        <button type="button" class="btn btn-sm btn-outline-warning" 
                                onclick="unassignCredential(${credential.id}, '${credential.name.replace(/'/g, "\\'")}')"
                                title="Unassign from bot">
                            <i class="fas fa-unlink"></i>
                        </button>
                        ` : ''}
                        <button type="button" class="btn btn-sm btn-outline-danger" 
                                onclick="deleteCredential(${credential.id}, '${credential.name.replace(/'/g, "\\'")}', ${credential.is_in_use})"
                                title="Delete">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                </td>
            </tr>
        `).join('');
    })
    .catch(error => {
        console.error('Error loading credentials:', error);
        const tbody = document.getElementById('credentials-table-body');
        if (tbody) {
            tbody.innerHTML = `
                <tr>
                    <td colspan="8" class="text-center text-danger">
                        <i class="fas fa-exclamation-triangle"></i>
                        Failed to load API credentials. Please refresh the page.
                    </td>
                </tr>
            `;
        }
    });
}

// Custom modal functions
function showCustomModal() {
    document.getElementById('createCredentialForm').reset();
    document.getElementById('createCredentialModal').classList.add('show');
}

function hideCustomModal() {
    document.getElementById('createCredentialModal').classList.remove('show');
}

function hideEditModal() {
    document.getElementById('editCredentialModal').classList.remove('show');
}

// Close modal when clicking overlay
document.addEventListener('click', function(e) {
    if (e.target.classList.contains('custom-modal-overlay')) {
        if (e.target.id === 'createCredentialModal') {
            hideCustomModal();
        } else if (e.target.id === 'editCredentialModal') {
            hideEditModal();
        }
    }
});

// Close modal with Escape key
document.addEventListener('keydown', function(e) {
    if (e.key === 'Escape') {
        const createModal = document.getElementById('createCredentialModal');
        const editModal = document.getElementById('editCredentialModal');
        if (createModal.classList.contains('show')) {
            hideCustomModal();
        } else if (editModal.classList.contains('show')) {
            hideEditModal();
        }
    }
});

// Load credentials on page load
document.addEventListener('DOMContentLoaded', function() {
    loadCredentials();
});
</script>
{% endblock %}
