{% extends "base.html" %}

{% block title %}Strategy Monitors{% endblock %}

{% block content %}
<style>
/* Fix modal styling for dark theme */
.modal-content {
    background-color: var(--secondary-black);
    border: 1px solid var(--medium-gray);
    color: var(--white);
}

.modal-header {
    background-color: var(--light-gray);
    border-bottom: 1px solid var(--medium-gray);
    color: var(--white);
}

.modal-title {
    color: var(--white);
}

.close {
    color: var(--white);
    opacity: 0.8;
}

.close:hover {
    color: var(--white);
    opacity: 1;
}

.modal-body {
    background-color: var(--secondary-black);
    color: var(--white);
}

.modal-footer {
    background-color: var(--light-gray);
    border-top: 1px solid var(--medium-gray);
}

.form-group label {
    color: var(--white);
}

.form-check-label {
    color: var(--white);
}

.btn-secondary {
    background-color: var(--medium-gray);
    border-color: var(--medium-gray);
    color: var(--white);
}

.btn-secondary:hover {
    background-color: var(--light-gray);
    border-color: var(--light-gray);
    color: var(--white);
}
</style>

<div class="container">
    <div class="row">
        <div class="col-md-12">
            <h2>Strategy Monitor System</h2>
            <p class="text-muted">Aggregate and monitor strategy performance across multiple instances</p>
            
            <!-- Success/Error Messages -->
            <script>
                document.addEventListener('DOMContentLoaded', function() {
                    const urlParams = new URLSearchParams(window.location.search);
                    if (urlParams.get('success') === 'created') {
                        const alert = document.createElement('div');
                        alert.className = 'alert alert-success alert-dismissible fade show';
                        alert.innerHTML = `
                            <i class="fas fa-check-circle"></i>
                            Strategy monitor created successfully!
                            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                        `;
                        document.querySelector('.container .col-md-12').insertBefore(alert, document.querySelector('.card'));
                        
                        // Clear URL parameter
                        window.history.replaceState({}, document.title, window.location.pathname);
                    }
                    
                    const errorParam = urlParams.get('error');
                    if (errorParam) {
                        const alert = document.createElement('div');
                        alert.className = 'alert alert-danger alert-dismissible fade show';
                        alert.innerHTML = `
                            <i class="fas fa-exclamation-triangle"></i>
                            ${errorParam}
                            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                        `;
                        document.querySelector('.container .col-md-12').insertBefore(alert, document.querySelector('.card'));
                        
                        // Clear URL parameter
                        window.history.replaceState({}, document.title, window.location.pathname);
                    }
                });
            </script>
            
            {% if error %}
            <div class="alert alert-danger alert-dismissible fade show">
                <i class="fas fa-exclamation-triangle"></i>
                {{ error }}
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            </div>
            {% endif %}
            
            <!-- Create New Monitor -->
            <div class="card mb-4">
                <div class="card-header">
                    <h5>Create Strategy Monitor</h5>
                </div>
                <div class="card-body">
                    <form method="post" action="/strategy-monitors">
                        <div class="row">
                            <div class="col-md-4">
                                <div class="form-group">
                                    <label for="strategy_name">Strategy Name</label>
                                    <select class="form-control" id="strategy_name" name="strategy_name" required>
                                        <option value="">Select Strategy</option>
                                        {% for strategy in available_strategies %}
                                        <option value="{{ strategy }}">{{ strategy }}</option>
                                        {% endfor %}
                                    </select>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="form-group">
                                    <label for="telegram_bot_token">Telegram Bot Token</label>
                                    <input type="text" class="form-control" id="telegram_bot_token" name="telegram_bot_token" required>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="form-group">
                                    <label for="telegram_chat_id">Telegram Chat ID</label>
                                    <input type="text" class="form-control" id="telegram_chat_id" name="telegram_chat_id" required>
                                </div>
                            </div>
                        </div>
                        
                        <div class="row">
                            <div class="col-md-3">
                                <div class="form-group">
                                    <label for="telegram_topic_id">Topic ID (Optional)</label>
                                    <input type="text" class="form-control" id="telegram_topic_id" name="telegram_topic_id">
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="form-group">
                                    <label for="report_interval">Report Interval (seconds)</label>
                                    <select class="form-control" id="report_interval" name="report_interval">
                                        <option value="300">5 minutes</option>
                                        <option value="900">15 minutes</option>
                                        <option value="1800">30 minutes</option>
                                        <option value="3600" selected>1 hour</option>
                                        <option value="7200">2 hours</option>
                                        <option value="14400">4 hours</option>
                                        <option value="28800">8 hours</option>
                                        <option value="43200">12 hours</option>
                                        <option value="86400">24 hours</option>
                                    </select>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="form-group">
                                    <label for="max_recent_positions">Max Recent Positions</label>
                                    <input type="number" class="form-control" id="max_recent_positions" name="max_recent_positions" value="20" min="5" max="50">
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="form-group">
                                    <label>Include in Reports</label>
                                    <div class="form-check">
                                        <input class="form-check-input" type="checkbox" id="include_positions" name="include_positions" checked>
                                        <label class="form-check-label" for="include_positions">Positions</label>
                                    </div>
                                    <div class="form-check">
                                        <input class="form-check-input" type="checkbox" id="include_orders" name="include_orders" checked>
                                        <label class="form-check-label" for="include_orders">Orders</label>
                                    </div>
                                    <div class="form-check">
                                        <input class="form-check-input" type="checkbox" id="include_trades" name="include_trades" checked>
                                        <label class="form-check-label" for="include_trades">Trades</label>
                                    </div>
                                    <div class="form-check">
                                        <input class="form-check-input" type="checkbox" id="include_pnl" name="include_pnl" checked>
                                        <label class="form-check-label" for="include_pnl">PnL</label>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <button type="submit" class="btn btn-primary">Create Monitor</button>
                    </form>
                </div>
            </div>
            
            <!-- Existing Monitors -->
            <div class="card">
                <div class="card-header">
                    <h5>Active Strategy Monitors</h5>
                </div>
                <div class="card-body">
                    {% if monitors %}
                    <div class="table-responsive">
                        <table class="table table-striped" id="strategy-monitors-table">
                            <thead>
                                <tr>
                                    <th>Strategy</th>
                                    <th>Status</th>
                                    <th>Report Interval</th>
                                    <th>Last Report</th>
                                    <th>Features</th>
                                    <th>Last Error</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for monitor in monitors %}
                                <tr id="monitor-{{ monitor.id }}">
                                    <td>
                                        <strong>{{ monitor.strategy_name }}</strong>
                                    </td>
                                    <td>
                                        {% if monitor.is_active %}
                                        <span class="badge badge-success">Active</span>
                                        {% else %}
                                        <span class="badge badge-secondary">Inactive</span>
                                        {% endif %}
                                    </td>
                                    <td>
                                        {% set hours = monitor.report_interval // 3600 %}
                                        {% set minutes = (monitor.report_interval % 3600) // 60 %}
                                        {% if hours > 0 %}
                                            {{ hours }}h
                                            {% if minutes > 0 %}{{ minutes }}m{% endif %}
                                        {% else %}
                                            {{ minutes }}m
                                        {% endif %}
                                    </td>
                                    <td>
                                        {% if monitor.last_report %}
                                        <span class="text-muted">{{ monitor.last_report.strftime('%Y-%m-%d %H:%M:%S') }}</span>
                                        {% else %}
                                        <span class="text-muted">Never</span>
                                        {% endif %}
                                    </td>
                                    <td>
                                        <small>
                                            {% if monitor.include_positions %}📊{% endif %}
                                            {% if monitor.include_orders %}📋{% endif %}
                                            {% if monitor.include_trades %}🔄{% endif %}
                                            {% if monitor.include_pnl %}💰{% endif %}
                                        </small>
                                    </td>
                                    <td>
                                        {% if monitor.last_error %}
                                        <span class="text-danger" title="{{ monitor.last_error }}">❌ Error</span>
                                        {% else %}
                                        <span class="text-success">✅ OK</span>
                                        {% endif %}
                                    </td>
                                    <td>
                                        <div class="btn-group" role="group" aria-label="Monitor actions">
                                            <button class="btn btn-sm btn-outline-primary" onclick="toggleMonitor({{ monitor.id }})">
                                                {% if monitor.is_active %}Pause{% else %}Resume{% endif %}
                                            </button>
                                            <button class="btn btn-sm btn-outline-info" onclick="testReport({{ monitor.id }})">
                                                Test Report
                                            </button>
                                            <button class="btn btn-sm btn-outline-warning" onclick="editMonitor({{ monitor.id }})">
                                                Edit
                                            </button>
                                            <button class="btn btn-sm btn-outline-danger" onclick="deleteMonitor({{ monitor.id }}, '{{ monitor.strategy_name }}')">
                                                Delete
                                            </button>
                                        </div>
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                    {% else %}
                    <div class="alert alert-info">
                        <h5>No Strategy Monitors</h5>
                        <p>Create your first strategy monitor to start aggregating data across multiple instances.</p>
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Edit Monitor Modal -->
<div class="modal fade" id="editMonitorModal" tabindex="-1" aria-labelledby="editMonitorModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="editMonitorModalLabel">Edit Strategy Monitor</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <form id="editMonitorForm">
                <div class="modal-body">
                    <input type="hidden" id="edit_monitor_id">
                    
                    <div class="row">
                        <div class="col-md-6">
                            <div class="form-group">
                                <label for="edit_telegram_bot_token">Telegram Bot Token</label>
                                <input type="text" class="form-control" id="edit_telegram_bot_token" name="telegram_bot_token">
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="form-group">
                                <label for="edit_telegram_chat_id">Telegram Chat ID</label>
                                <input type="text" class="form-control" id="edit_telegram_chat_id" name="telegram_chat_id">
                            </div>
                        </div>
                    </div>
                    
                    <div class="row">
                        <div class="col-md-4">
                            <div class="form-group">
                                <label for="edit_telegram_topic_id">Topic ID (Optional)</label>
                                <input type="text" class="form-control" id="edit_telegram_topic_id" name="telegram_topic_id">
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="form-group">
                                <label for="edit_report_interval">Report Interval</label>
                                <select class="form-control" id="edit_report_interval" name="report_interval">
                                    <option value="300">5 minutes</option>
                                    <option value="900">15 minutes</option>
                                    <option value="1800">30 minutes</option>
                                    <option value="3600">1 hour</option>
                                    <option value="7200">2 hours</option>
                                    <option value="14400">4 hours</option>
                                    <option value="28800">8 hours</option>
                                    <option value="43200">12 hours</option>
                                    <option value="86400">24 hours</option>
                                </select>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="form-group">
                                <label for="edit_max_recent_positions">Max Recent Positions</label>
                                <input type="number" class="form-control" id="edit_max_recent_positions" name="max_recent_positions" min="5" max="50">
                            </div>
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label>Include in Reports</label>
                        <div class="row">
                            <div class="col-md-3">
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" id="edit_include_positions" name="include_positions">
                                    <label class="form-check-label" for="edit_include_positions">Positions</label>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" id="edit_include_orders" name="include_orders">
                                    <label class="form-check-label" for="edit_include_orders">Orders</label>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" id="edit_include_trades" name="include_trades">
                                    <label class="form-check-label" for="edit_include_trades">Trades</label>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" id="edit_include_pnl" name="include_pnl">
                                    <label class="form-check-label" for="edit_include_pnl">PnL</label>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-primary">Save Changes</button>
                </div>
            </form>
        </div>
    </div>
</div>

<script>
function toggleMonitor(monitorId) {
    fetch(`/strategy-monitors/${monitorId}/toggle`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.message) {
            alert(data.message);
            location.reload();
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('Failed to toggle monitor');
    });
}

function testReport(monitorId) {
    if (!confirm('Send a test report for this strategy monitor?')) return;
    
    fetch(`/strategy-monitors/${monitorId}/test-report`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.message) {
            alert(data.message);
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('Failed to send test report');
    });
}

function editMonitor(monitorId) {
    // Fetch monitor details and populate edit form
    fetch(`/api/strategy-monitors`)
    .then(response => response.json())
    .then(monitors => {
        const monitor = monitors.find(m => m.id === monitorId);
        if (monitor) {
            document.getElementById('edit_monitor_id').value = monitor.id;
            document.getElementById('edit_telegram_bot_token').value = monitor.telegram_bot_token || '';
            document.getElementById('edit_telegram_chat_id').value = monitor.telegram_chat_id || '';
            document.getElementById('edit_telegram_topic_id').value = monitor.telegram_topic_id || '';
            document.getElementById('edit_report_interval').value = monitor.report_interval;
            document.getElementById('edit_max_recent_positions').value = monitor.max_recent_positions;
            document.getElementById('edit_include_positions').checked = monitor.include_positions;
            document.getElementById('edit_include_orders').checked = monitor.include_orders;
            document.getElementById('edit_include_trades').checked = monitor.include_trades;
            document.getElementById('edit_include_pnl').checked = monitor.include_pnl;
            
            // Use Bootstrap 5 modal API
            const modal = new bootstrap.Modal(document.getElementById('editMonitorModal'));
            modal.show();
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('Failed to load monitor details');
    });
}

function closeModal() {
    const modal = bootstrap.Modal.getInstance(document.getElementById('editMonitorModal'));
    if (modal) {
        modal.hide();
    }
}

function deleteMonitor(monitorId, strategyName) {
    if (!confirm(`Delete strategy monitor for '${strategyName}'?`)) return;
    
    fetch(`/strategy-monitors/${monitorId}`, {
        method: 'DELETE',
        headers: {
            'Content-Type': 'application/json',
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.message) {
            alert(data.message);
            location.reload();
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('Failed to delete monitor');
    });
}

// Handle edit form submission
document.getElementById('editMonitorForm').addEventListener('submit', function(e) {
    e.preventDefault();
    
    const monitorId = document.getElementById('edit_monitor_id').value;
    const formData = new FormData(this);
    
    fetch(`/strategy-monitors/${monitorId}`, {
        method: 'PUT',
        body: formData
    })
    .then(response => response.json())
    .then(data => {
        if (data.message) {
            alert(data.message);
            closeModal(); // Use closeModal to hide the modal
            location.reload();
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('Failed to update monitor');
    });
});

// Load strategy monitors on page load
document.addEventListener('DOMContentLoaded', function() {
    loadStrategyMonitors();
    
    // Remove form submission handler for create monitor form - let it use normal form submission
    // The form will use the normal POST action to /strategy-monitors
});

function loadStrategyMonitors() {
    const token = localStorage.getItem('access_token');
    if (!token) {
        window.location.href = '/login';
        return;
    }
    
    fetch('/api/strategy-monitors', {
        headers: {
            'Authorization': `Bearer ${token}`
        }
    })
    .then(response => {
        if (response.status === 401) {
            localStorage.removeItem('access_token');
            window.location.href = '/login';
            return;
        }
        return response.json();
    })
    .then(monitors => {
        if (monitors) {
            updateStrategyMonitorsTable(monitors);
        }
    })
    .catch(error => {
        console.error('Error loading strategy monitors:', error);
        showErrorMessage('Failed to load strategy monitors');
    });
}

function updateStrategyMonitorsTable(monitors) {
    const tbody = document.querySelector('#strategy-monitors-table tbody');
    if (!tbody) return;
    
    if (!monitors || monitors.length === 0) {
        tbody.innerHTML = `
            <tr>
                <td colspan="8" class="text-center">
                    <div class="text-center py-4">
                        <i class="fas fa-chart-line fa-3x text-muted mb-3"></i>
                        <h4 class="text-muted">No Strategy Monitors Found</h4>
                        <p class="text-muted">Create your first strategy monitor to get started</p>
                        <a href="#" class="btn btn-primary" data-toggle="modal" data-target="#createMonitorModal">
                            <i class="fas fa-plus"></i> Create Strategy Monitor
                        </a>
                    </div>
                </td>
            </tr>
        `;
        return;
    }
    
    tbody.innerHTML = monitors.map(monitor => {
        const lastReport = monitor.last_report ? new Date(monitor.last_report).toLocaleString() : 'Never';
        const statusBadge = monitor.is_active ? 
            '<span class="badge badge-success">Active</span>' : 
            '<span class="badge badge-secondary">Inactive</span>';
        const intervalHours = Math.floor(monitor.report_interval / 3600);
        const intervalMinutes = Math.floor((monitor.report_interval % 3600) / 60);
        const intervalText = intervalHours > 0 ? 
            `${intervalHours}h ${intervalMinutes}m` : 
            `${intervalMinutes}m`;
        
        return `
            <tr>
                <td><strong>${monitor.strategy_name}</strong></td>
                <td>${statusBadge}</td>
                <td>${intervalText}</td>
                <td>
                    <div class="d-flex flex-wrap">
                        ${monitor.include_positions ? '<span class="badge badge-info badge-sm mr-1">Positions</span>' : ''}
                        ${monitor.include_orders ? '<span class="badge badge-info badge-sm mr-1">Orders</span>' : ''}
                        ${monitor.include_trades ? '<span class="badge badge-info badge-sm mr-1">Trades</span>' : ''}
                        ${monitor.include_pnl ? '<span class="badge badge-info badge-sm mr-1">P&L</span>' : ''}
                    </div>
                </td>
                <td>${monitor.max_recent_positions}</td>
                <td>${lastReport}</td>
                <td>
                    ${monitor.last_error ? 
                        `<span class="text-danger small" title="${monitor.last_error}">
                            <i class="fas fa-exclamation-triangle"></i> Error
                        </span>` : 
                        '<span class="text-success"><i class="fas fa-check-circle"></i> OK</span>'
                    }
                </td>
                <td>
                    <div class="btn-group btn-group-sm">
                        <button class="btn btn-outline-primary btn-sm" onclick="editMonitor(${monitor.id})" title="Edit">
                            <i class="fas fa-edit"></i>
                        </button>
                        <button class="btn btn-outline-info btn-sm" onclick="testReport(${monitor.id})" title="Test Report">
                            <i class="fas fa-paper-plane"></i>
                        </button>
                        <button class="btn btn-outline-${monitor.is_active ? 'warning' : 'success'} btn-sm" onclick="toggleMonitor(${monitor.id})" title="${monitor.is_active ? 'Deactivate' : 'Activate'}">
                            <i class="fas fa-${monitor.is_active ? 'pause' : 'play'}"></i>
                        </button>
                        <button class="btn btn-outline-danger btn-sm" onclick="deleteMonitor(${monitor.id}, '${monitor.strategy_name}')" title="Delete">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                </td>
            </tr>
        `;
    }).join('');
}

function showErrorMessage(message, type = 'error') {
    // Create a notification toast
    const alertClass = type === 'success' ? 'alert-success' : 'alert-danger';
    const errorDiv = document.createElement('div');
    errorDiv.className = `alert ${alertClass} alert-dismissible fade show position-fixed`;
    errorDiv.style.cssText = 'top: 20px; right: 20px; z-index: 9999; max-width: 400px;';
    errorDiv.innerHTML = `
        ${message}
        <button type="button" class="close" data-dismiss="alert">
            <span>&times;</span>
        </button>
    `;
    document.body.appendChild(errorDiv);
    
    // Auto-dismiss after 5 seconds
    setTimeout(() => {
        errorDiv.remove();
    }, 5000);
}
</script>
{% endblock %}
