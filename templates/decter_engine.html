{% extends "base.html" %}

{% block title %}Decter Engine{% endblock %}

{% block head %}
<style>
    .decter-header {
        background: var(--secondary-black);
        border: 1px solid var(--border-gray);
        border-radius: 12px;
        padding: 32px;
        margin-bottom: 32px;
        box-shadow: 0 4px 16px var(--shadow-light);
    }
    
    .status-badge {
        font-size: 12px;
        font-weight: 600;
        padding: 8px 16px;
        border-radius: 20px;
        text-transform: uppercase;
        letter-spacing: 0.5px;
        border: 1px solid;
    }
    
    .status-online { 
        background: var(--accent-success);
        color: var(--primary-black);
        border-color: var(--accent-success);
    }
    .status-trading { 
        background: var(--accent-info);
        color: var(--primary-black);
        border-color: var(--accent-info);
    }
    .status-offline { 
        background: var(--medium-gray);
        color: var(--text-primary);
        border-color: var(--border-gray);
    }
    .status-error { 
        background: var(--accent-danger);
        color: var(--white);
        border-color: var(--accent-danger);
    }
    
    .metric-card {
        background: var(--secondary-black);
        border: 1px solid var(--border-gray);
        border-radius: 12px;
        padding: 24px;
        margin-bottom: 24px;
        transition: all 0.2s ease;
    }
    
    .metric-card:hover {
        border-color: var(--border-primary);
        transform: translateY(-2px);
    }
    
    .metric-value {
        font-size: 32px;
        font-weight: 700;
        color: var(--text-primary);
        margin-bottom: 8px;
    }
    
    .metric-label {
        font-size: 14px;
        color: var(--text-secondary);
        text-transform: uppercase;
        letter-spacing: 0.5px;
        font-weight: 500;
    }
    
    .control-panel {
        background: var(--secondary-black);
        border: 1px solid var(--border-gray);
        border-radius: 12px;
        padding: 32px;
        margin-bottom: 32px;
        text-align: center;
    }
    
    .control-btn {
        border-radius: 8px;
        padding: 12px 32px;
        font-weight: 600;
        font-size: 14px;
        letter-spacing: 0.5px;
        transition: all 0.2s ease;
        border: 1px solid;
        margin: 0 8px;
        min-width: 140px;
    }
    
    .btn-start { 
        background: var(--accent-success);
        color: var(--primary-black);
        border-color: var(--accent-success);
    }
    
    .btn-stop { 
        background: var(--accent-danger);
        color: var(--white);
        border-color: var(--accent-danger);
    }
    
    .btn-restart { 
        background: var(--accent-warning);
        color: var(--primary-black);
        border-color: var(--accent-warning);
    }
    
    .control-btn:hover:not(:disabled) {
        transform: translateY(-2px);
        box-shadow: 0 4px 16px var(--shadow-light);
        opacity: 0.9;
    }
    
    .control-btn:disabled {
        opacity: 0.5;
        cursor: not-allowed;
    }
    
    .config-section {
        margin-bottom: 32px;
    }
    
    .section-header {
        display: flex;
        align-items: center;
        justify-content: space-between;
        margin-bottom: 20px;
        padding-bottom: 12px;
        border-bottom: 1px solid var(--border-gray);
    }
    
    .section-title {
        font-size: 18px;
        font-weight: 600;
        color: var(--text-primary);
        margin: 0;
    }
    
    .form-group {
        margin-bottom: 20px;
    }
    
    .form-group label {
        font-size: 14px;
        font-weight: 500;
        color: var(--text-secondary);
        margin-bottom: 8px;
        display: block;
    }
    
    .quick-commands {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 16px;
        margin-top: 24px;
    }
    
    .quick-cmd-btn {
        background: var(--hover-bg);
        border: 1px solid var(--border-gray);
        border-radius: 8px;
        padding: 16px;
        color: var(--text-primary);
        text-decoration: none;
        transition: all 0.2s ease;
        display: flex;
        align-items: center;
        gap: 12px;
        font-weight: 500;
    }
    
    .quick-cmd-btn:hover {
        background: var(--active-bg);
        border-color: var(--border-primary);
        color: var(--text-primary);
        transform: translateY(-2px);
    }
    
    .quick-cmd-btn.enhanced {
        background: var(--secondary-black);
        border: 1px solid var(--border-gray);
        border-radius: 8px;
        padding: 20px;
        color: var(--text-primary);
        transition: all 0.3s ease;
        display: flex;
        flex-direction: column;
        align-items: center;
        gap: 8px;
        font-weight: 500;
        min-height: 100px;
        text-decoration: none;
    }
    
    .quick-cmd-btn.enhanced:hover {
        background: var(--active-bg);
        border-color: var(--accent-info);
        transform: translateY(-3px);
        box-shadow: 0 8px 25px var(--shadow-light);
    }
    
    .quick-cmd-btn.enhanced i {
        font-size: 1.5rem;
        margin-bottom: 4px;
    }
    
    .command-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
        gap: 16px;
        margin-bottom: 20px;
    }
    
    @keyframes pulse {
        0%, 100% { opacity: 1; transform: scale(1); }
        50% { opacity: 0.5; transform: scale(0.8); }
    }
    
    .performance-card {
        background: var(--secondary-black);
        border: 1px solid var(--border-gray);
        border-radius: 12px;
        padding: 24px;
        transition: all 0.3s ease;
        position: relative;
        overflow: hidden;
    }
    
    .performance-card:hover {
        border-color: var(--accent-info);
        transform: translateY(-2px);
        box-shadow: 0 8px 25px var(--shadow-light);
    }
    
    .performance-card::before {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        height: 3px;
        background: linear-gradient(90deg, var(--accent-success), var(--accent-info), var(--accent-warning));
        opacity: 0;
        transition: opacity 0.3s ease;
    }
    
    .performance-card:hover::before {
        opacity: 1;
    }
    
    .enhanced-log-container {
        background: var(--primary-black);
        border: 1px solid var(--border-gray);
        border-radius: 8px;
        padding: 20px;
        max-height: 400px;
        overflow-y: auto;
        font-family: 'JetBrains Mono', 'Courier New', monospace;
        font-size: 12px;
        line-height: 1.6;
        position: relative;
    }
    
    .log-filters {
        display: flex;
        gap: 8px;
        margin-bottom: 16px;
    }
    
    .log-filter-btn {
        padding: 4px 12px;
        background: var(--hover-bg);
        border: 1px solid var(--border-gray);
        border-radius: 16px;
        color: var(--text-secondary);
        font-size: 11px;
        cursor: pointer;
        transition: all 0.2s ease;
    }
    
    .log-filter-btn.active {
        background: var(--accent-info);
        color: var(--primary-black);
        border-color: var(--accent-info);
    }
    
    .trade-row {
        background: var(--secondary-black);
        border: 1px solid var(--border-gray);
        border-radius: 8px;
        margin-bottom: 12px;
        padding: 16px;
        border-left: 4px solid transparent;
        transition: all 0.2s ease;
    }
    
    .trade-row:hover {
        border-color: var(--border-primary);
    }
    
    .trade-win { 
        border-left-color: var(--accent-success);
        background: var(--secondary-black);
    }
    .trade-loss { 
        border-left-color: var(--accent-danger);
        background: var(--secondary-black);
    }
    
    .log-container {
        background: var(--primary-black);
        border: 1px solid var(--border-gray);
        border-radius: 8px;
        padding: 20px;
        max-height: 400px;
        overflow-y: auto;
        font-family: 'JetBrains Mono', 'Courier New', monospace;
        font-size: 13px;
        color: var(--accent-success);
        line-height: 1.6;
    }
    
    .empty-state {
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        padding: 40px 20px;
        color: var(--text-muted);
        text-align: center;
    }
    
    .empty-state i {
        font-size: 48px;
        margin-bottom: 16px;
        opacity: 0.3;
    }
    
    .empty-state h6 {
        margin-bottom: 8px;
        color: var(--text-secondary);
    }
    
    .empty-state p {
        font-size: 14px;
        margin: 0;
    }
    
    .refresh-btn {
        position: fixed;
        bottom: 20px;
        right: 20px;
        background: linear-gradient(45deg, #007bff, #17a2b8);
        border: none;
        border-radius: 50%;
        width: 60px;
        height: 60px;
        color: white;
        font-size: 1.5rem;
        box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
        transition: all 0.3s ease;
        z-index: 1000;
    }
    
    .refresh-btn:hover {
        transform: scale(1.1);
        background: linear-gradient(45deg, #0056b3, #138496);
    }
    
    
    /* Simple Credentials Modal */
    .credentials-modal {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0, 0, 0, 0.6);
        z-index: 10000;
        display: flex;
        align-items: center;
        justify-content: center;
    }

    .credentials-modal-content {
        background-color: var(--secondary-black);
        border: 1px solid var(--border-gray);
        border-radius: 12px;
        color: var(--white);
        width: 90%;
        max-width: 800px;
        max-height: 90%;
        overflow-y: auto;
        box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
    }

    .credentials-modal-header {
        padding: 1.5rem 2rem;
        border-bottom: 1px solid var(--border-gray);
        display: flex;
        justify-content: space-between;
        align-items: center;
        background: var(--dark-gray);
        border-radius: 12px 12px 0 0;
    }

    .credentials-modal-header h4 {
        margin: 0;
        color: var(--white);
        font-weight: 600;
    }

    .credentials-modal-body {
        padding: 2rem;
    }

    .credentials-section {
        background: var(--dark-gray);
        border: 1px solid var(--border-gray);
        border-radius: 8px;
        padding: 1.5rem;
        margin-bottom: 1rem;
    }

    .credentials-section h6 {
        color: var(--accent-info);
        margin-bottom: 1rem;
        font-weight: 600;
    }

    .credentials-modal-footer {
        padding: 1.5rem 2rem 0;
        display: flex;
        justify-content: flex-end;
        gap: 1rem;
    }

    .credentials-modal .form-control {
        background-color: var(--medium-gray);
        border: 1px solid var(--border-gray);
        color: var(--white);
        border-radius: 6px;
    }

    .credentials-modal .form-control:focus {
        background-color: var(--medium-gray);
        color: var(--white);
        border-color: var(--accent-info);
        box-shadow: 0 0 0 0.2rem rgba(23, 162, 184, 0.25);
    }

    .credentials-modal .form-label {
        color: var(--text-secondary);
        font-weight: 500;
        margin-bottom: 0.5rem;
    }

    .close-btn {
        background: none;
        border: none;
        font-size: 2rem;
        cursor: pointer;
        color: var(--white);
        opacity: 0.7;
        line-height: 1;
        width: 32px;
        height: 32px;
        display: flex;
        align-items: center;
        justify-content: center;
        border-radius: 4px;
        transition: all 0.2s ease;
    }

    .close-btn:hover {
        opacity: 1;
        background-color: var(--hover-bg);
    }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid">
    <!-- Enhanced Header -->
    <div class="decter-header">
        <div class="row align-items-center">
            <div class="col-lg-6">
                <div class="d-flex align-items-center gap-3 mb-3">
                    <div class="engine-icon">
                        <i class="fas fa-robot" style="font-size: 2.5rem; color: var(--accent-info);"></i>
                    </div>
                    <div>
                        <h1 class="mb-1" style="font-family: 'Orbitron', monospace; font-weight: 700; font-size: 2rem;">DECTER ENGINE</h1>
                        <p class="mb-0 text-secondary" style="font-size: 14px;">First entity of the Decter class by DR.Decatalyst</p>
                    </div>
                </div>
            </div>
            <div class="col-lg-6">
                <div class="d-flex justify-content-lg-end justify-content-start align-items-center gap-3">
                    <div class="engine-status-card" style="background: var(--secondary-black); border: 1px solid var(--border-gray); border-radius: 8px; padding: 16px; min-width: 200px;">
                        <div class="d-flex justify-content-between align-items-center mb-2">
                            <span class="text-secondary" style="font-size: 12px; text-transform: uppercase; letter-spacing: 0.5px;">Status</span>
                            <div class="status-indicator" id="statusIndicator" style="width: 8px; height: 8px; border-radius: 50%; background: var(--accent-danger);"></div>
                        </div>
                        <div class="mb-2">
                            <span id="statusBadge" class="status-badge status-offline">Decter 001</span>
                        </div>
                        <div class="d-flex justify-content-between text-secondary" style="font-size: 11px;">
                            <span id="uptimeDisplay">Uptime: --</span>
                            <span id="lastSyncDisplay">Last Sync: --</span>
                        </div>
                    </div>
                    <button class="btn btn-outline-primary" onclick="openCredentialsModal()" style="min-width: 120px;">
                        <i class="fas fa-shield-alt me-2"></i>Credentials
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Quick Commands Control Panel -->
    <div class="control-panel">
        <div class="section-header">
            <h2 class="section-title">Quick Commands</h2>
        </div>
        <div class="row">
            <div class="col-lg-8">
                <div class="command-grid">
                    <button id="startBtn" class="quick-cmd-btn enhanced" onclick="requireAuth('controlDecter', 'start')">
                        <i class="fas fa-play"></i>
                        <span>Start Engine</span>
                    </button>
                    <button id="stopBtn" class="quick-cmd-btn enhanced" onclick="requireAuth('controlDecter', 'stop')">
                        <i class="fas fa-stop"></i>
                        <span>Stop Engine</span>
                    </button>
                    <button id="restartBtn" class="quick-cmd-btn enhanced" onclick="requireAuth('controlDecter', 'restart')">
                        <i class="fas fa-redo"></i>
                        <span>Restart Engine</span>
                    </button>
                    <button class="quick-cmd-btn enhanced" onclick="showTradeHistory()">
                        <i class="fas fa-history"></i>
                        <span>Trade History</span>
                    </button>
                    <button class="quick-cmd-btn enhanced" onclick="exportData()">
                        <i class="fas fa-download"></i>
                        <span>Export Data</span>
                    </button>
                    <button class="quick-cmd-btn enhanced" onclick="showSystemStatus()">
                        <i class="fas fa-chart-bar"></i>
                        <span>System Status</span>
                    </button>
                </div>
            </div>
            <div class="col-lg-4">
                <div class="sync-indicator" style="background: var(--secondary-black); border: 1px solid var(--border-gray); border-radius: 8px; padding: 16px; height: 100%;">
                    <div class="d-flex align-items-center gap-2 mb-2">
                        <div class="sync-pulse" id="syncPulse" style="width: 8px; height: 8px; border-radius: 50%; background: var(--accent-success); animation: pulse 2s infinite;"></div>
                        <span class="text-secondary" style="font-size: 12px;">DATA SYNC</span>
                    </div>
                    <div class="text-primary" style="font-size: 14px; font-weight: 500;" id="syncStatus">Connected</div>
                    <div class="text-secondary" style="font-size: 11px;" id="dataSync">Real-time data feed active</div>
                </div>
            </div>
        </div>
    </div>

    <!-- Enhanced Performance Overview -->
    <div class="config-section">
        <div class="section-header">
            <h2 class="section-title">Performance Overview</h2>
            <div class="d-flex gap-2">
                <button class="btn btn-sm btn-outline-primary" onclick="refreshMetrics()">
                    <i class="fas fa-sync-alt"></i>
                </button>
                <select class="form-select form-select-sm" style="width: auto;" onchange="changeMetricsPeriod(this.value)">
                    <option value="24h">24H</option>
                    <option value="7d">7D</option>
                    <option value="30d">30D</option>
                </select>
            </div>
        </div>
        <div class="row">
            <div class="col-md-3">
                <div class="performance-card text-center">
                    <div class="metric-value" id="totalTrades">--</div>
                    <div class="metric-label">Total Trades</div>
                    <div class="metric-change" id="tradesChange" style="font-size: 11px; margin-top: 4px;">--</div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="performance-card text-center">
                    <div class="metric-value" id="winRate">--%</div>
                    <div class="metric-label">Win Rate</div>
                    <div class="metric-change" id="winRateChange" style="font-size: 11px; margin-top: 4px;">--</div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="performance-card text-center">
                    <div class="metric-value" id="netPnL">--</div>
                    <div class="metric-label">Net P&L (XRP)</div>
                    <div class="metric-change" id="pnlChange" style="font-size: 11px; margin-top: 4px;">--</div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="performance-card text-center">
                    <div class="metric-value" id="growthRate">--%</div>
                    <div class="metric-label">Growth Rate</div>
                    <div class="metric-change" id="growthChange" style="font-size: 11px; margin-top: 4px;">--</div>
                </div>
            </div>
        </div>
    </div>

    <div class="row">
        <!-- Configuration Panel -->
        <div class="col-md-6">
            <div class="card mb-4">
                <div class="card-header">
                    <div class="section-header">
                        <h2 class="section-title">Trading Parameters</h2>
                    </div>
                </div>
                <div class="card-body p-4">
                    <form id="configForm">
                        <div class="row">
                            <div class="col-md-6">
                                <div class="form-group">
                                    <label class="form-label">Stake Amount (XRP)</label>
                                    <input type="number" class="form-control" name="stake" step="0.1" min="0.4" placeholder="0.4" required>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="form-group">
                                    <label class="form-label">Growth Rate (%)</label>
                                    <select class="form-control" name="growth_rate" required>
                                        <option value="1">1%</option>
                                        <option value="2">2%</option>
                                        <option value="3">3%</option>
                                        <option value="4">4%</option>
                                        <option value="5">5%</option>
                                    </select>
                                </div>
                            </div>
                        </div>
                        
                        <div class="row">
                            <div class="col-md-6">
                                <div class="form-group">
                                    <label class="form-label">Take Profit (%)</label>
                                    <input type="number" class="form-control" name="take_profit" step="0.1" min="1" placeholder="15" required>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="form-group">
                                    <label class="form-label">Index</label>
                                    <select class="form-control" name="index" required>
                                        <option value="R_10">R_10</option>
                                        <option value="R_25">R_25</option>
                                        <option value="R_50">R_50</option>
                                        <option value="R_75">R_75</option>
                                        <option value="R_100">R_100</option>
                                        <option value="1HZ10V">1HZ10V</option>
                                        <option value="1HZ25V">1HZ25V</option>
                                        <option value="1HZ50V">1HZ50V</option>
                                        <option value="1HZ75V">1HZ75V</option>
                                        <option value="1HZ100V">1HZ100V</option>
                                    </select>
                                </div>
                            </div>
                        </div>
                        
                        <div class="row">
                            <div class="col-md-6">
                                <div class="form-group">
                                    <label class="form-label">Currency</label>
                                    <select id="currencySelect" class="form-control" name="currency" required onchange="handleCurrencyChange(this.value)">
                                        <option value="XRP">XRP</option>
                                        <option value="BTC">BTC</option>
                                        <option value="ETH">ETH</option>
                                        <option value="LTC">LTC</option>
                                        <option value="USDT">USDT</option>
                                        <option value="USD">USD</option>
                                    </select>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="form-group">
                                    <label class="form-label">Max Loss Amount</label>
                                    <input type="number" class="form-control" name="max_loss_amount" step="0.1" min="1" placeholder="100" required>
                                </div>
                            </div>
                        </div>
                        
                        <div class="form-group">
                            <label class="form-label">Max Win Amount</label>
                            <input type="number" class="form-control" name="max_win_amount" step="0.1" min="1" placeholder="200" required>
                        </div>
                        
                        <button type="submit" class="btn btn-primary w-100">
                            <i class="fas fa-save me-2"></i>Save Configuration
                        </button>
                    </form>
                </div>
            </div>

            <!-- Advanced Configuration -->
            <div class="card">
                <div class="card-header">
                    <div class="section-header">
                        <h2 class="section-title">Advanced Settings</h2>
                    </div>
                </div>
                <div class="card-body p-4">
                    <div class="row">
                        <div class="col-md-6">
                            <div class="form-group">
                                <label class="form-label">Risk Management Mode</label>
                                <select class="form-control" name="risk_mode">
                                    <option value="conservative">Conservative</option>
                                    <option value="moderate">Moderate</option>
                                    <option value="aggressive">Aggressive</option>
                                </select>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="form-group">
                                <label class="form-label">Auto-Stop Loss (%)</label>
                                <input type="number" class="form-control" name="auto_stop_loss" min="1" max="50" placeholder="20">
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Status and Data Panel -->
        <div class="col-md-6">
            <!-- Enhanced Trade History -->
            <div class="card mb-4">
                <div class="card-header">
                    <div class="section-header">
                        <h2 class="section-title">Recent Trades</h2>
                        <div class="d-flex gap-2">
                            <button class="btn btn-sm btn-outline-primary" onclick="refreshTrades()">
                                <i class="fas fa-sync-alt"></i>
                            </button>
                            <button class="btn btn-sm btn-outline-primary" onclick="loadMoreTrades()">
                                <i class="fas fa-chevron-down"></i> Load More
                            </button>
                            <button class="btn btn-sm btn-outline-primary" onclick="exportTrades()">
                                <i class="fas fa-download"></i>
                            </button>
                        </div>
                    </div>
                </div>
                <div class="card-body p-4">
                    <div class="trade-filters mb-3">
                        <div class="d-flex gap-2 flex-wrap">
                            <button class="log-filter-btn active" data-filter="all">All</button>
                            <button class="log-filter-btn" data-filter="wins">Wins</button>
                            <button class="log-filter-btn" data-filter="losses">Losses</button>
                            <button class="log-filter-btn" data-filter="pending">Pending</button>
                        </div>
                    </div>
                    <div id="tradesContainer" style="max-height: 400px; overflow-y: auto;">
                        <div class="table-responsive">
                            <table class="table table-dark table-hover" style="font-size: 13px;">
                                <thead>
                                    <tr style="background: var(--medium-gray);">
                                        <th>Symbol</th>
                                        <th>Entry</th>
                                        <th>Exit</th>
                                        <th>P&L</th>
                                        <th>Time</th>
                                        <th>Status</th>
                                    </tr>
                                </thead>
                                <tbody id="tradesTableBody">
                                    <tr>
                                        <td colspan="6" class="text-center text-muted py-4">
                                            <i class="fas fa-chart-line" style="font-size: 2rem; opacity: 0.3;"></i>
                                            <div class="mt-2">No trades available</div>
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Enhanced System Logs -->
            <div class="card">
                <div class="card-header">
                    <div class="section-header">
                        <h2 class="section-title">System Logs</h2>
                        <div class="d-flex gap-2">
                            <button class="btn btn-sm btn-outline-primary" onclick="refreshLogs()">
                                <i class="fas fa-sync-alt"></i>
                            </button>
                            <button class="btn btn-sm btn-outline-primary" onclick="exportLogs()">
                                <i class="fas fa-download"></i>
                            </button>
                            <button class="btn btn-sm btn-outline-danger" onclick="clearLogs()">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    </div>
                </div>
                <div class="card-body p-4">
                    <div class="log-filters">
                        <button class="log-filter-btn active" data-level="all">All</button>
                        <button class="log-filter-btn" data-level="error">Error</button>
                        <button class="log-filter-btn" data-level="warning">Warning</button>
                        <button class="log-filter-btn" data-level="info">Info</button>
                    </div>
                    <div id="logsContainer" class="enhanced-log-container">
                        <div class="text-center text-muted py-4">
                            <i class="fas fa-terminal" style="font-size: 2rem; opacity: 0.3;"></i>
                            <div class="mt-2">No system logs available</div>
                            <small>Logs will appear here once the engine starts</small>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Simple Credentials Modal -->
<div id="credentialsModal" class="credentials-modal" style="display: none;">
    <div class="credentials-modal-content">
        <div class="credentials-modal-header">
            <h4><i class="fas fa-shield-alt me-2"></i>Decter Engine Credentials</h4>
            <button type="button" class="close-btn" onclick="closeCredentialsModal()">×</button>
        </div>
        <div class="credentials-modal-body">
            <div id="twofaWarning" class="alert alert-warning d-none">
                <i class="fas fa-exclamation-triangle me-2"></i>
                You must enable Two-Factor Authentication to access credentials management.
                <a href="/setup-2fa" class="btn btn-sm btn-warning ms-2">Setup 2FA</a>
            </div>
            
            <form id="credentialsForm" onsubmit="saveCredentials(event)">
                <div class="row">
                    <div class="col-md-6">
                        <div class="credentials-section">
                            <h6><i class="fab fa-telegram me-2"></i>Telegram Configuration</h6>
                            <div class="mb-3">
                                <label class="form-label">Bot Token</label>
                                <input type="password" name="telegram_bot_token" class="form-control" placeholder="Enter bot token" required>
                            </div>
                            <div class="mb-3">
                                <label class="form-label">Group ID</label>
                                <input type="text" name="telegram_group_id" class="form-control" placeholder="Enter group ID" required>
                            </div>
                            <div class="mb-3">
                                <label class="form-label">Topic ID (Optional)</label>
                                <input type="text" name="telegram_topic_id" class="form-control" placeholder="Enter topic ID for forum groups">
                            </div>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="credentials-section">
                            <h6><i class="fas fa-chart-line me-2"></i>Deriv API Configuration</h6>
                            <div class="mb-3">
                                <label class="form-label">API Key</label>
                                <input type="password" name="deriv_api_key" class="form-control" placeholder="Enter API key" required>
                            </div>
                            <div class="mb-3">
                                <label class="form-label">App ID</label>
                                <input type="text" name="deriv_app_id" class="form-control" placeholder="Enter app ID" required>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="credentials-modal-footer">
                    <button type="button" class="btn btn-secondary" onclick="closeCredentialsModal()">Cancel</button>
                    <button type="submit" class="btn btn-primary">
                        <i class="fas fa-save me-2"></i>Save Credentials
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Enhanced Footer -->
<footer class="mt-5 pt-4" style="border-top: 1px solid var(--border-gray); background: var(--secondary-black);">
    <div class="container-fluid">
        <div class="row align-items-center">
            <div class="col-md-4">
                <div class="d-flex align-items-center gap-2">
                    <span class="text-secondary" style="font-size: 12px;">System Version:</span>
                    <span class="badge bg-primary" style="font-size: 10px;">v2.1.8</span>
                </div>
            </div>
            <div class="col-md-4 text-center">
                <div class="sync-status d-flex align-items-center justify-content-center gap-2">
                    <div class="sync-pulse" style="width: 6px; height: 6px; border-radius: 50%; background: var(--accent-success); animation: pulse 2s infinite;"></div>
                    <span class="text-secondary" style="font-size: 11px;" id="footerSyncStatus">Data sync active</span>
                </div>
            </div>
            <div class="col-md-4 text-end">
                <a href="#" class="text-secondary" style="font-size: 11px; text-decoration: none;">Documentation</a>
            </div>
        </div>
    </div>
</footer>

<!-- Floating Action Button -->
<div class="position-fixed" style="bottom: 32px; right: 32px; z-index: 1000;">
    <button class="btn btn-primary rounded-circle" onclick="refreshAllData()" title="Refresh All Data" style="width: 56px; height: 56px; box-shadow: 0 4px 20px var(--shadow-light);">
        <i class="fas fa-sync-alt"></i>
    </button>
</div>

<!-- Scripts -->
<script>
let refreshInterval;
let dataUpdateInterval;


// Get authentication token from localStorage for API calls
function getAuthToken() {
    // Try localStorage first (most common)
    const token = localStorage.getItem('access_token');
    if (token) {
        return token;
    }
    
    // Fallback to sessionStorage
    const sessionToken = sessionStorage.getItem('access_token');
    if (sessionToken) {
        return sessionToken;
    }
    
    // Also try to get from cookies as fallback
    const cookies = document.cookie.split(';');
    for (let cookie of cookies) {
        const [name, value] = cookie.trim().split('=');
        if (name === 'access_token') {
            return value;
        }
    }
    
    return null;
}

// Helper function to make authenticated API calls
async function authenticatedFetch(url, options = {}) {
    const token = getAuthToken();
    
    // If no token found, show a more informative message but don't break the page
    if (!token) {
        console.warn('No authentication token found. User may need to login.');
        showAlert('Please login to access Decter Engine features.', 'info');
        // Return a mock response to prevent errors
        return {
            ok: false,
            status: 401,
            json: async () => ({ error: 'No authentication token' })
        };
    }
    
    const defaultOptions = {
        headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${token}`
        },
        ...options
    };
    
    // Merge headers properly
    if (options.headers) {
        defaultOptions.headers = { ...defaultOptions.headers, ...options.headers };
    }
    
    try {
        const response = await fetch(url, defaultOptions);
        
        // Handle authentication errors gracefully
        if (response.status === 401 || response.status === 403) {
            console.warn('Authentication failed for:', url);
            showAlert('Session expired. Please refresh the page or login again.', 'warning');
        }
        
        return response;
    } catch (error) {
        console.error('Network error:', error);
        showAlert('Network error. Please check your connection.', 'danger');
        return {
            ok: false,
            status: 0,
            json: async () => ({ error: 'Network error' })
        };
    }
}

// Initialize page
document.addEventListener('DOMContentLoaded', function() {
    console.log('[DEBUG] Enhanced Decter Engine interface initializing...');
    
    // Attach enhanced global functions
    window.controlDecter = controlDecter;
    window.sendCommand = sendCommand;
    window.exportData = exportData;
    window.refreshAllData = refreshAllData;
    window.handleCurrencyChange = handleCurrencyChange;
    window.requireAuth = requireAuth;
    window.openCredentialsModal = openCredentialsModalDecter;
    window.closeCredentialsModal = closeCredentialsModal;
    window.saveCredentials = saveCredentials;
    window.refreshMetrics = refreshMetrics;
    window.changeMetricsPeriod = changeMetricsPeriod;
    window.loadMoreTrades = loadMoreTrades;
    window.exportLogs = exportLogs;
    
    
    // Initialize enhanced features
    initializeDataSync();
    setupLogFilters();
    setupTradeFilters();
    
    refreshAllData();
    startAutoRefresh();
    loadCurrentConfig();
    
    // Setup form submission if forms exist
    const configForm = document.getElementById('configForm');
    if (configForm) {
        configForm.addEventListener('submit', saveConfiguration);
    }
    
    
    // Close modal with Escape key
    document.addEventListener('keydown', function(e) {
        if (e.key === 'Escape') {
            const credentialsModal = document.getElementById('credentialsModal');
            if (credentialsModal && credentialsModal.style.display === 'flex') {
                closeCredentialsModal();
            }
        }
    });
    
    // Close modal when clicking outside
    document.addEventListener('click', function(e) {
        const modal = document.getElementById('credentialsModal');
        if (e.target === modal) {
            closeCredentialsModal();
        }
    });
    
    console.log('[DEBUG] Enhanced Decter Engine interface initialized successfully');
    
    // Function definitions ready
    console.log('Credentials modal functions initialized');
});


function startAutoRefresh() {
    // Refresh data every 5 seconds
    refreshInterval = setInterval(refreshAllData, 5000);
}

function stopAutoRefresh() {
    if (refreshInterval) {
        clearInterval(refreshInterval);
    }
}

async function refreshAllData() {
    try {
        await Promise.all([
            updateStatus(),
            updatePerformance(),
            updateTrades(),
            updateLogs()
        ]);
    } catch (error) {
        console.error('Error refreshing data:', error);
    }
}

async function updateStatus() {
    try {
        const response = await authenticatedFetch('/api/decter/status');
        
        // Handle failed responses gracefully
        if (!response.ok) {
            console.warn('Failed to fetch status:', response.status);
            return;
        }
        
        const data = await response.json();
        
        // Update status badge
        const statusBadge = document.getElementById('statusBadge');
        const status = data.status ? data.status.toLowerCase() : 'offline';
        
        statusBadge.className = `status-badge status-${status}`;
        statusBadge.textContent = data.status ? data.status.toUpperCase() : 'OFFLINE';
        
        // Update uptime
        const uptimeDisplay = document.getElementById('uptimeDisplay');
        if (data.uptime_seconds) {
            const hours = Math.floor(data.uptime_seconds / 3600);
            const minutes = Math.floor((data.uptime_seconds % 3600) / 60);
            uptimeDisplay.textContent = `Uptime: ${hours}h ${minutes}m`;
        } else {
            uptimeDisplay.textContent = 'Uptime: --';
        }
        
        // Update button states
        updateControlButtons(data.is_running || false);
        
    } catch (error) {
        console.error('Error updating status:', error);
        // Set default values on error
        document.getElementById('statusBadge').textContent = 'ERROR';
        document.getElementById('statusBadge').className = 'status-badge status-error';
        document.getElementById('uptimeDisplay').textContent = 'Uptime: --';
    }
}

async function updatePerformance() {
    try {
        const response = await authenticatedFetch('/api/decter/performance');
        
        if (!response.ok) {
            console.warn('Failed to fetch performance:', response.status);
            return;
        }
        
        const data = await response.json();
        
        document.getElementById('totalTrades').textContent = data.total_trades || '--';
        document.getElementById('winRate').textContent = data.win_rate ? `${data.win_rate.toFixed(1)}%` : '--%';
        document.getElementById('netPnL').textContent = data.net_pnl ? `${data.net_pnl.toFixed(2)}` : '--';
        document.getElementById('growthRate').textContent = data.growth_rate ? `${data.growth_rate.toFixed(2)}%` : '--%';
        
    } catch (error) {
        console.error('Error updating performance:', error);
        // Set default values on error
        document.getElementById('totalTrades').textContent = '--';
        document.getElementById('winRate').textContent = '--%';
        document.getElementById('netPnL').textContent = '--';
        document.getElementById('growthRate').textContent = '--%';
    }
}

async function updateTrades() {
    try {
        const response = await authenticatedFetch('/api/decter/trades?limit=10');
        const data = await response.json();
        
        const container = document.getElementById('tradesContainer');
        
        if (data.trades && data.trades.length > 0) {
            container.innerHTML = data.trades.map(trade => `
                <div class="trade-row ${trade.win ? 'trade-win' : 'trade-loss'}">
                    <div class="d-flex justify-content-between">
                        <span>${trade.symbol}</span>
                        <span class="${trade.win ? 'text-success' : 'text-danger'}">
                            ${trade.win ? '+' : ''}${trade.profit_loss?.toFixed(2) || '0.00'} XRP
                        </span>
                    </div>
                    <small class="text-muted">${trade.timestamp}</small>
                </div>
            `).join('');
        } else {
            container.innerHTML = '<div class="text-center text-muted"><p>No trades available</p></div>';
        }
        
    } catch (error) {
        console.error('Error updating trades:', error);
    }
}

async function updateLogs() {
    try {
        const response = await authenticatedFetch('/api/decter/logs?lines=20');
        const data = await response.json();
        
        const container = document.getElementById('logsContainer');
        
        if (data.logs && data.logs.length > 0) {
            container.innerHTML = data.logs.map(log => {
                // Handle both string and object logs
                const logText = typeof log === 'object' ? JSON.stringify(log) : log;
                return `<div>${logText}</div>`;
            }).join('');
            container.scrollTop = container.scrollHeight;
        } else {
            container.innerHTML = '<div class="text-center">No logs available</div>';
        }
        
    } catch (error) {
        console.error('Error updating logs:', error);
    }
}

function updateControlButtons(isRunning) {
    const startBtn = document.getElementById('startBtn');
    const stopBtn = document.getElementById('stopBtn');
    const restartBtn = document.getElementById('restartBtn');
    
    startBtn.disabled = isRunning;
    stopBtn.disabled = !isRunning;
    restartBtn.disabled = false;
}

async function controlDecter(action) {
    console.log(`[DEBUG] controlDecter called with action: ${action}`);
    
    try {
        // Check if we have authentication
        const token = getAuthToken();
        if (!token) {
            showAlert('Please login to use Decter Engine controls.', 'warning');
            return;
        }
        
        showLoading(`${action.charAt(0).toUpperCase() + action.slice(1)}ing Decter 001...`);
        
        const response = await authenticatedFetch(`/api/decter/${action}`, {
            method: 'POST'
        });
        
        console.log(`[DEBUG] Response status: ${response.status}`);
        
        if (!response.ok) {
            const errorText = await response.text();
            console.error(`[DEBUG] Error response: ${errorText}`);
            showAlert(`HTTP Error ${response.status}: ${errorText}`, 'danger');
            return;
        }
        
        const result = await response.json();
        console.log(`[DEBUG] Response result:`, result);
        
        if (result.success) {
            showAlert(`Decter 001 ${action} successful!`, 'success');
            setTimeout(refreshAllData, 1000);
        } else {
            showAlert(`Failed to ${action} Decter 001: ${result.message || 'Unknown error'}`, 'danger');
        }
        
    } catch (error) {
        console.error(`[DEBUG] Error ${action}ing Decter:`, error);
        showAlert(`Error ${action}ing Decter 001: ${error.message}`, 'danger');
    } finally {
        hideLoading();
    }
}

async function loadCurrentConfig() {
    try {
        const response = await authenticatedFetch('/api/decter/config');
        const config = await response.json();
        
        if (config && Object.keys(config).length > 0) {
            const form = document.getElementById('configForm');
            Object.keys(config).forEach(key => {
                const input = form.querySelector(`[name="${key}"]`);
                if (input) {
                    input.value = config[key];
                }
            });
        }
        
    } catch (error) {
        console.error('Error loading config:', error);
    }
}

async function saveConfiguration(event) {
    event.preventDefault();
    
    try {
        showLoading('Saving configuration...');
        
        const formData = new FormData(event.target);
        const config = {};
        
        formData.forEach((value, key) => {
            // Try to parse as float for numeric fields, otherwise keep as string
            const numValue = parseFloat(value);
            config[key] = !isNaN(numValue) && key !== 'index' && key !== 'currency' ? numValue : value;
        });
        
        console.log('Sending config:', config);
        
        const response = await authenticatedFetch('/api/decter/config', {
            method: 'POST',
            body: JSON.stringify(config)
        });
        
        console.log('Config save response status:', response.status);
        
        let result;
        try {
            result = await response.json();
            console.log('Config save response:', result);
        } catch (e) {
            console.error('Failed to parse response as JSON:', e);
            result = { message: 'Invalid response from server' };
        }
        
        if (response.ok && result.success) {
            showAlert('Configuration saved successfully!', 'success');
        } else {
            // Handle both 'message' and 'detail' fields from the response
            const errorMessage = result.message || result.detail || 'Unknown error';
            showAlert(`Failed to save configuration: ${errorMessage}`, 'danger');
        }
        
    } catch (error) {
        console.error('Error saving config:', error);
        showAlert('Error saving configuration', 'danger');
    } finally {
        hideLoading();
    }
}

async function sendCommand(command) {
    console.log(`[DEBUG] sendCommand called with command: ${command}`);
    
    try {
        // Check if we have authentication
        const token = getAuthToken();
        if (!token) {
            showAlert('Please login to use Decter Engine commands.', 'warning');
            return;
        }
        
        showLoading(`Sending command: ${command}`);
        
        const response = await authenticatedFetch('/api/decter/command', {
            method: 'POST',
            body: JSON.stringify({ command: command })
        });
        
        console.log(`[DEBUG] Command response status: ${response.status}`);
        
        if (!response.ok) {
            const errorText = await response.text();
            console.error(`[DEBUG] Command error response: ${errorText}`);
            showAlert(`HTTP Error ${response.status}: ${errorText}`, 'danger');
            return;
        }
        
        const result = await response.json();
        console.log(`[DEBUG] Command response result:`, result);
        
        if (result.success) {
            showAlert(`Command "${command}" sent successfully!`, 'success');
        } else {
            showAlert(`Failed to send command: ${result.message || 'Unknown error'}`, 'danger');
        }
        
    } catch (error) {
        console.error('[DEBUG] Error sending command:', error);
        showAlert(`Error sending command: ${error.message}`, 'danger');
    } finally {
        hideLoading();
    }
}

function showAlert(message, type) {
    console.log(`[DEBUG] Showing alert: ${message} (type: ${type})`);
    
    // Remove any existing alerts first
    const existingAlerts = document.querySelectorAll('.custom-alert');
    existingAlerts.forEach(alert => alert.remove());
    
    // Create and show custom alert with better styling
    const alertDiv = document.createElement('div');
    alertDiv.className = `alert alert-${type} alert-dismissible fade show position-fixed custom-alert`;
    alertDiv.style.cssText = `
        top: 20px; 
        right: 20px; 
        z-index: 99999; 
        min-width: 350px; 
        max-width: 500px;
        box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        border-radius: 8px;
        font-weight: 500;
    `;
    
    // Set background color based on type
    const colors = {
        'success': '#d1edff',
        'danger': '#f8d7da',
        'warning': '#fff3cd',
        'info': '#d1ecf1'
    };
    
    const textColors = {
        'success': '#0c5460',
        'danger': '#721c24', 
        'warning': '#856404',
        'info': '#0c5460'
    };
    
    alertDiv.style.backgroundColor = colors[type] || colors.info;
    alertDiv.style.color = textColors[type] || textColors.info;
    alertDiv.style.border = `1px solid ${colors[type] || colors.info}`;
    
    alertDiv.innerHTML = `
        <div style="display: flex; align-items: center; justify-content: space-between;">
            <div style="flex: 1; padding-right: 10px;">
                <strong>${type.charAt(0).toUpperCase() + type.slice(1)}:</strong> ${message}
            </div>
            <button type="button" class="btn-close" onclick="this.parentElement.parentElement.remove()" style="background: none; border: none; font-size: 20px; cursor: pointer; opacity: 0.7;">×</button>
        </div>
    `;
    
    document.body.appendChild(alertDiv);
    
    // Add animation
    setTimeout(() => alertDiv.style.opacity = '1', 10);
    
    // Auto dismiss after 5 seconds
    setTimeout(() => {
        if (alertDiv.parentNode) {
            alertDiv.style.opacity = '0';
            setTimeout(() => alertDiv.remove(), 300);
        }
    }, 5000);
    
    console.log(`[DEBUG] Alert created and added to DOM`);
}

async function exportData() {
    console.log('[DEBUG] exportData function called');
    
    try {
        // Check if we have authentication
        const token = getAuthToken();
        if (!token) {
            showAlert('Please login to export data.', 'warning');
            return;
        }
        
        showLoading('Preparing data export...');
        
        // Call the export API endpoint
        const response = await authenticatedFetch('/api/decter/trades/export', {
            method: 'POST',
            body: JSON.stringify({
                format: 'csv',
                start_date: null,
                end_date: null,
                currency: null,
                engine: null
            })
        });
        
        console.log(`[DEBUG] Export response status: ${response.status}`);
        
        if (!response.ok) {
            const errorText = await response.text();
            console.error(`[DEBUG] Export error response: ${errorText}`);
            showAlert(`Export failed: HTTP ${response.status}`, 'danger');
            return;
        }
        
        const result = await response.json();
        console.log(`[DEBUG] Export response result:`, result);
        
        if (result.success && result.file_path) {
            // If the API returns a file path, try to download it
            const downloadLink = document.createElement('a');
            downloadLink.href = result.file_path;
            downloadLink.download = result.filename || 'decter_trades_export.csv';
            document.body.appendChild(downloadLink);
            downloadLink.click();
            document.body.removeChild(downloadLink);
            
            showAlert('Data exported successfully! Download should start automatically.', 'success');
        } else if (result.success && result.data) {
            // If the API returns data directly, create and download the file
            const csvContent = result.data;
            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            const url = URL.createObjectURL(blob);
            link.setAttribute('href', url);
            link.setAttribute('download', 'decter_trades_export.csv');
            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            URL.revokeObjectURL(url);
            
            showAlert('Data exported successfully! Download started.', 'success');
        } else {
            // Fallback: show the message and let user know data is ready
            showAlert(result.message || 'Export completed, but no download data received.', 'info');
        }
        
    } catch (error) {
        console.error('[DEBUG] Error exporting data:', error);
        showAlert(`Export error: ${error.message}`, 'danger');
    } finally {
        hideLoading();
    }
}

function showLoading(message) {
    // Simple loading indicator
    const loadingDiv = document.createElement('div');
    loadingDiv.id = 'loadingIndicator';
    loadingDiv.className = 'position-fixed d-flex align-items-center justify-content-center';
    loadingDiv.style.cssText = 'top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 9999;';
    loadingDiv.innerHTML = `
        <div class="text-center text-white">
            <div class="spinner-border mb-3" role="status"></div>
            <div>${message}</div>
        </div>
    `;
    
    document.body.appendChild(loadingDiv);
}

function hideLoading() {
    const loadingDiv = document.getElementById('loadingIndicator');
    if (loadingDiv) {
        loadingDiv.remove();
    }
}

async function handleCurrencyChange(newCurrency) {
    try {
        showLoading(`Switching currency to ${newCurrency}...`);
        
        const response = await authenticatedFetch('/api/decter/currency/switch', {
            method: 'POST',
            body: JSON.stringify({ currency: newCurrency })
        });
        
        const result = await response.json();
        
        if (response.ok && result.success) {
            showAlert(`Currency switched to ${newCurrency} successfully!`, 'success');
            // Update UI to reflect new currency
            document.getElementById('netPnL').parentElement.querySelector('.metric-label').textContent = `Net P&L (${newCurrency})`;
            document.querySelector('input[name="stake"]').parentElement.querySelector('.form-label').textContent = `Stake Amount (${newCurrency})`;
            
            // Update API key placeholder for new currency
            await updateApiKeyPlaceholder(newCurrency);
            
            setTimeout(refreshAllData, 1000);
        } else {
            showAlert(`Failed to switch currency: ${result.message}`, 'danger');
            // Revert the selection
            loadCurrentConfig();
        }
        
    } catch (error) {
        console.error('Error switching currency:', error);
        showAlert('Error switching currency', 'danger');
        // Revert the selection
        loadCurrentConfig();
    } finally {
        hideLoading();
    }
}

async function updateApiKeyPlaceholder(currency) {
    try {
        // Get current Deriv config to check if this currency has an API key
        const derivResponse = await authenticatedFetch('/api/decter/deriv/config');
        if (derivResponse.ok) {
            const derivConfig = await derivResponse.json();
            const currencyTokenKey = `${currency.toLowerCase()}_api_token`;
            const apiKeyField = document.querySelector('input[name="deriv_api_key"]');
            
            if (apiKeyField) {
                if (derivConfig[currencyTokenKey] && derivConfig[currencyTokenKey] !== 'undefined') {
                    apiKeyField.placeholder = `${currency} API Key configured (hidden for security)`;
                    apiKeyField.setAttribute('data-has-value', 'true');
                } else {
                    apiKeyField.placeholder = `Enter ${currency} API Key`;
                    apiKeyField.removeAttribute('data-has-value');
                }
                
                // Clear the field value when currency changes
                apiKeyField.value = '';
            }
        }
    } catch (error) {
        console.error('Error updating API key placeholder:', error);
    }
}

async function saveCredentials(event) {
    event.preventDefault();
    
    try {
        showLoading('Saving credentials...');
        
        const formData = new FormData(event.target);
        
        // Save Telegram configuration
        const telegramConfig = {
            bot_token: formData.get('telegram_bot_token'),
            group_id: formData.get('telegram_group_id'),
            topic_id: formData.get('telegram_topic_id') || null
        };
        
        // Save Deriv configuration
        // Get the currently selected currency to save the API key for that currency
        const currentCurrency = document.querySelector('#currencySelect')?.value || 'XRP';
        const apiKey = formData.get('deriv_api_key');
        
        const derivConfig = {
            deriv_app_id: formData.get('deriv_app_id')
        };
        
        // Add the API key for the current currency
        if (apiKey) {
            derivConfig[`${currentCurrency.toLowerCase()}_api_token`] = apiKey;
        }
        
        // Save both configurations
        const telegramResponse = await authenticatedFetch('/api/decter/telegram/config', {
            method: 'POST',
            body: JSON.stringify(telegramConfig)
        });
        
        const derivResponse = await authenticatedFetch('/api/decter/deriv/config', {
            method: 'POST',
            body: JSON.stringify(derivConfig)
        });
        
        const telegramResult = await telegramResponse.json();
        const derivResult = await derivResponse.json();
        
        if (telegramResponse.ok && derivResponse.ok && telegramResult.success && derivResult.success) {
            showAlert('Credentials saved successfully!', 'success');
            closeCredentialsModal();
            // Clear password fields for security
            event.target.querySelectorAll('input[type="password"]').forEach(input => input.value = '');
        } else {
            const errorMsg = !telegramResult.success ? telegramResult.message : derivResult.message;
            showAlert(`Failed to save credentials: ${errorMsg}`, 'danger');
        }
        
    } catch (error) {
        console.error('Error saving credentials:', error);
        showAlert('Error saving credentials: ' + error.message, 'danger');
    } finally {
        hideLoading();
    }
}

async function loadCredentials() {
    try {
        // Load Telegram config
        const telegramResponse = await authenticatedFetch('/api/decter/telegram/config');
        if (telegramResponse.ok) {
            const telegramConfig = await telegramResponse.json();
            
            // Populate non-sensitive fields
            if (telegramConfig.group_id) {
                const groupIdField = document.querySelector('input[name="telegram_group_id"]');
                if (groupIdField) groupIdField.value = telegramConfig.group_id;
            }
            if (telegramConfig.topic_id) {
                const topicIdField = document.querySelector('input[name="telegram_topic_id"]');
                if (topicIdField) topicIdField.value = telegramConfig.topic_id;
            }
            
            // Show placeholder for token if it exists (for user feedback)
            if (telegramConfig.telegram_bot_token) {
                const tokenField = document.querySelector('input[name="telegram_bot_token"]');
                if (tokenField) {
                    tokenField.placeholder = "Token configured (hidden for security)";
                    tokenField.setAttribute('data-has-value', 'true');
                }
            }
        }
        
        // Load Deriv config
        const derivResponse = await authenticatedFetch('/api/decter/deriv/config');
        if (derivResponse.ok) {
            const derivConfig = await derivResponse.json();
            
            // Populate App ID
            if (derivConfig.deriv_app_id) {
                const appIdField = document.querySelector('input[name="deriv_app_id"]');
                if (appIdField) appIdField.value = derivConfig.deriv_app_id;
            }
            
            // Show placeholders for configured API tokens based on current currency
            const currentCurrency = document.querySelector('#currencySelect')?.value || 'XRP';
            const currencyTokenKey = `${currentCurrency.toLowerCase()}_api_token`;
            
            if (derivConfig[currencyTokenKey] && derivConfig[currencyTokenKey] !== 'undefined') {
                const apiKeyField = document.querySelector('input[name="deriv_api_key"]');
                if (apiKeyField) {
                    apiKeyField.placeholder = `${currentCurrency} API Key configured (hidden for security)`;
                    apiKeyField.setAttribute('data-has-value', 'true');
                }
            }
        }
        
        console.log('✅ Credentials loaded successfully');
        
    } catch (error) {
        console.error('Error loading credentials:', error);
    }
}

// Enhanced cleanup on page unload
window.addEventListener('beforeunload', function() {
    stopAutoRefresh();
    if (dataUpdateInterval) {
        clearInterval(dataUpdateInterval);
    }
});


// Fallback function definitions (in case of loading issues)
window.controlDecter = window.controlDecter || function(action) {
    console.error('[FALLBACK] controlDecter function not properly loaded');
    showAlert('Decter control functions not loaded. Please refresh the page.', 'danger');
};

window.sendCommand = window.sendCommand || function(command) {
    console.error('[FALLBACK] sendCommand function not properly loaded');
    showAlert('Command functions not loaded. Please refresh the page.', 'danger');
};

window.exportData = window.exportData || function() {
    console.error('[FALLBACK] exportData function not properly loaded');
    showAlert('Export functions not loaded. Please refresh the page.', 'danger');
};

// Additional UI helper functions
function refreshTrades() {
    updateTrades();
    showAlert('Trades refreshed', 'success');
}

function refreshLogs() {
    updateLogs();
    showAlert('Logs refreshed', 'success');
}

async function clearLogs() {
    if (confirm('Are you sure you want to clear all logs?')) {
        try {
            showLoading('Clearing logs...');
            const response = await authenticatedFetch('/api/decter/logs/clear', { method: 'POST' });
            const data = await response.json();
            
            if (data.success) {
                document.getElementById('logsContainer').innerHTML = `
                    <div class="text-center text-muted py-4">
                        <i class="fas fa-terminal" style="font-size: 2rem; opacity: 0.3;"></i>
                        <div class="mt-2">Logs cleared</div>
                        <small>New logs will appear here as Decter 001 operates</small>
                    </div>
                `;
                showAlert('Logs cleared successfully', 'success');
            } else {
                showAlert('Failed to clear logs: ' + data.message, 'danger');
            }
        } catch (error) {
            console.error('Error clearing logs:', error);
            showAlert('Error clearing logs', 'danger');
        } finally {
            hideLoading();
        }
    }
}

function exportTrades() {
    exportData();
}

// Enhanced Functions for New Features  
function requireAuth(functionName, ...args) {
    // Simplified auth check - just execute the function directly
    // The credentials modal will handle auth internally
    if (typeof window[functionName] === 'function') {
        window[functionName](...args);
    } else {
        console.warn(`Function ${functionName} not found`);
    }
}

async function openCredentialsModalDecter() {
    try {
        // Check 2FA status before opening modal
        const token = localStorage.getItem('access_token');
        if (!token) {
            window.location.href = '/login';
            return;
        }

        const response = await fetch('/api/user/2fa/status', {
            headers: {
                'Authorization': `Bearer ${token}`
            }
        });

        const modal = document.getElementById('credentialsModal');
        const twofaWarning = document.getElementById('twofaWarning');
        const credentialsForm = document.getElementById('credentialsForm');

        if (!modal) {
            console.error('Credentials modal not found');
            return;
        }

        // Show the modal first
        modal.style.display = 'flex';

        if (response.ok) {
            const data = await response.json();
            console.log('2FA Status Response:', data); // Debug log
            
            if (data.totp_enabled) {
                // 2FA is enabled, show credentials form and hide warning
                console.log('2FA is enabled, showing form');
                if (twofaWarning) twofaWarning.classList.add('d-none');
                if (credentialsForm) credentialsForm.style.display = 'block';
                
                // Load existing credentials
                await loadCredentials();
                
                // Update API key placeholder for current currency
                const currentCurrency = document.querySelector('#currencySelect')?.value || 'XRP';
                await updateApiKeyPlaceholder(currentCurrency);
                
                // Focus on first input
                setTimeout(() => {
                    const firstInput = modal.querySelector('input[type="password"]');
                    if (firstInput) firstInput.focus();
                }, 100);
            } else {
                // 2FA is not enabled, show warning and hide form
                console.log('2FA is not enabled, showing warning');
                if (twofaWarning) twofaWarning.classList.remove('d-none');
                if (credentialsForm) credentialsForm.style.display = 'none';
            }
        } else {
            console.error('Failed to check 2FA status, response not ok');
            // If we can't verify 2FA status, show the form anyway
            if (twofaWarning) twofaWarning.classList.add('d-none');
            if (credentialsForm) credentialsForm.style.display = 'block';
            
            // Load existing credentials
            await loadCredentials();
            
            // Update API key placeholder for current currency
            const currentCurrency = document.querySelector('#currencySelect')?.value || 'XRP';
            await updateApiKeyPlaceholder(currentCurrency);
            
            setTimeout(() => {
                const firstInput = modal.querySelector('input[type="password"]');
                if (firstInput) firstInput.focus();
            }, 100);
        }
    } catch (error) {
        console.error('Error checking 2FA status:', error);
        // On error, show the form anyway
        const modal = document.getElementById('credentialsModal');
        const twofaWarning = document.getElementById('twofaWarning');
        const credentialsForm = document.getElementById('credentialsForm');
        
        if (modal) {
            modal.style.display = 'flex';
            if (twofaWarning) twofaWarning.classList.add('d-none');
            if (credentialsForm) credentialsForm.style.display = 'block';
            
            // Load existing credentials
            await loadCredentials();
            
            // Update API key placeholder for current currency
            const currentCurrency = document.querySelector('#currencySelect')?.value || 'XRP';
            await updateApiKeyPlaceholder(currentCurrency);
            
            setTimeout(() => {
                const firstInput = modal.querySelector('input[type="password"]');
                if (firstInput) firstInput.focus();
            }, 100);
        }
    }
}

// Override the global function
window.openCredentialsModal = openCredentialsModalDecter;

function closeCredentialsModal() {
    const modal = document.getElementById('credentialsModal');
    if (modal) {
        modal.style.display = 'none';
    }
}




function initializeDataSync() {
    // Real-time data sync from actual JSON files
    dataUpdateInterval = setInterval(() => {
        updateSyncStatus();
        loadRealDataFromJSON();
    }, 3000);
}

function updateSyncStatus() {
    const syncStatus = document.getElementById('syncStatus');
    const footerSync = document.getElementById('footerSyncStatus');
    const lastSync = new Date().toLocaleTimeString();
    
    if (syncStatus) syncStatus.textContent = 'Connected';
    if (footerSync) footerSync.textContent = `Last sync: ${lastSync}`;
}

async function loadRealDataFromJSON() {
    try {
        // Load real data from Decter JSON files via API
        const [statsResponse, tradesResponse, logsResponse] = await Promise.all([
            authenticatedFetch('/api/decter/performance'),
            authenticatedFetch('/api/decter/trades?limit=10'),
            authenticatedFetch('/api/decter/logs?lines=20')
        ]);
        
        if (statsResponse.ok) {
            const statsData = await statsResponse.json();
            updateMetricsFromRealData(statsData);
        }
        
        if (tradesResponse.ok) {
            const tradesData = await tradesResponse.json();
            updateTradesFromRealData(tradesData.trades || []);
        }
        
        if (logsResponse.ok) {
            const logsData = await logsResponse.json();
            updateLogsFromRealData(logsData.logs || []);
        }
    } catch (error) {
        console.error('Error loading real data:', error);
        // Fallback to empty state
        showEmptyDataState();
    }
}

function updateLogsFromRealData(logs) {
    const container = document.getElementById('logsContainer');
    if (container) {
        if (logs && logs.length > 0) {
            container.innerHTML = logs.map(log => {
                // Handle both string and object logs
                const logText = typeof log === 'object' ? JSON.stringify(log) : log;
                return `<div class="log-entry">${logText}</div>`;
            }).join('');
            container.scrollTop = container.scrollHeight;
        } else {
            container.innerHTML = `
                <div class="text-center text-muted py-4">
                    <i class="fas fa-terminal" style="font-size: 2rem; opacity: 0.3;"></i>
                    <div class="mt-2">No system logs available</div>
                    <small>Logs will appear here once Decter 001 starts</small>
                </div>
            `;
        }
    }
}

function updateTradesFromRealData(trades) {
    const tbody = document.getElementById('tradesTableBody');
    if (tbody) {
        if (trades && trades.length > 0) {
            tbody.innerHTML = trades.map(trade => `
                <tr class="${trade.win ? 'table-success' : 'table-danger'}" style="opacity: 0.8;">
                    <td>${trade.symbol}</td>
                    <td>${trade.entry_price || 'N/A'}</td>
                    <td>${trade.exit_price || 'N/A'}</td>
                    <td class="${trade.profit_loss > 0 ? 'text-success' : 'text-danger'}">
                        ${trade.profit_loss > 0 ? '+' : ''}${(trade.profit_loss || 0).toFixed(4)}
                    </td>
                    <td>${new Date(trade.timestamp).toLocaleTimeString()}</td>
                    <td><span class="badge ${trade.win ? 'bg-success' : 'bg-danger'}">${trade.win ? 'Win' : 'Loss'}</span></td>
                </tr>
            `).join('');
        } else {
            tbody.innerHTML = `
                <tr>
                    <td colspan="6" class="text-center text-muted py-4">
                        <i class="fas fa-chart-line" style="font-size: 2rem; opacity: 0.3;"></i>
                        <div class="mt-2">No trades available</div>
                        <small>Trade history will appear here once Decter 001 executes trades</small>
                    </td>
                </tr>
            `;
        }
    }
}

function updateMetricsFromRealData(metricsData) {
    // Update performance metrics with real data from Decter JSON files
    const totalTrades = metricsData.total_trades || 0;
    const winRate = metricsData.win_rate || 0;
    const netPnL = metricsData.net_pnl || 0;
    const growthRate = metricsData.growth_rate || 0;
    
    document.getElementById('totalTrades').textContent = totalTrades;
    document.getElementById('winRate').textContent = `${winRate.toFixed(1)}%`;
    document.getElementById('netPnL').textContent = netPnL.toFixed(4);
    document.getElementById('growthRate').textContent = `${growthRate.toFixed(2)}%`;
}

function showEmptyDataState() {
    // Show empty state when no data is available
    const logsContainer = document.getElementById('logsContainer');
    const tradesTableBody = document.getElementById('tradesTableBody');
    
    if (logsContainer) {
        logsContainer.innerHTML = `
            <div class="text-center text-muted py-4">
                <i class="fas fa-database" style="font-size: 2rem; opacity: 0.3;"></i>
                <div class="mt-2">No data connection</div>
                <small>Unable to load Decter 001 data. Please check connection.</small>
            </div>
        `;
    }
    
    if (tradesTableBody) {
        tradesTableBody.innerHTML = `
            <tr>
                <td colspan="6" class="text-center text-muted py-4">
                    <i class="fas fa-exclamation-triangle" style="font-size: 2rem; opacity: 0.3;"></i>
                    <div class="mt-2">Data unavailable</div>
                </td>
            </tr>
        `;
    }
    
    // Set default metric values
    document.getElementById('totalTrades').textContent = '0';
    document.getElementById('winRate').textContent = '0.0%';
    document.getElementById('netPnL').textContent = '0.0000';
    document.getElementById('growthRate').textContent = '0.00%';
}



function setupLogFilters() {
    document.querySelectorAll('.log-filter-btn[data-level]').forEach(btn => {
        btn.addEventListener('click', function() {
            document.querySelectorAll('.log-filter-btn[data-level]').forEach(b => b.classList.remove('active'));
            this.classList.add('active');
            filterLogs(this.dataset.level);
        });
    });
}

function setupTradeFilters() {
    document.querySelectorAll('.log-filter-btn[data-filter]').forEach(btn => {
        btn.addEventListener('click', function() {
            document.querySelectorAll('.log-filter-btn[data-filter]').forEach(b => b.classList.remove('active'));
            this.classList.add('active');
            filterTrades(this.dataset.filter);
        });
    });
}

function filterLogs(level) {
    // Implementation for filtering logs by level
    console.log('Filtering logs by level:', level);
}

function filterTrades(filter) {
    // Implementation for filtering trades
    console.log('Filtering trades by:', filter);
}

function refreshMetrics() {
    updatePerformance();
    showAlert('Metrics refreshed', 'success');
}

function changeMetricsPeriod(period) {
    console.log('Changing metrics period to:', period);
    refreshMetrics();
}

function loadMoreTrades() {
    showLoading('Loading more trades...');
    setTimeout(() => {
        hideLoading();
        showAlert('More trades loaded', 'success');
    }, 1000);
}

function exportLogs() {
    showAlert('Logs export started', 'success');
}

function showTradeHistory() {
    showAlert('Opening detailed trade history...', 'info');
}

function showSystemStatus() {
    showAlert('System status: All systems operational', 'success');
}
</script>
{% endblock %}