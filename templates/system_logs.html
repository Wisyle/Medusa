{% extends "base.html" %}

{% block title %}System Logs - TAR Global Strategies{% endblock %}

{% block extra_head %}
<style>
/* System Logs Page Styles */
.logs-container {
    height: 70vh;
    overflow-y: auto;
    font-family: 'Consolas', 'Monaco', 'Lucida Console', monospace;
    background: var(--primary-black);
    color: var(--white);
    padding: 15px;
    border-radius: 8px;
    border: 1px solid var(--medium-gray);
}

.logs-container::-webkit-scrollbar {
    width: 8px;
}

.logs-container::-webkit-scrollbar-track {
    background: rgba(255, 255, 255, 0.05);
    border-radius: 4px;
}

.logs-container::-webkit-scrollbar-thumb {
    background: var(--accent-blue);
    border-radius: 4px;
}

.log-entry {
    margin-bottom: 4px;
    padding: 4px 8px;
    border-radius: 3px;
    font-size: 0.85rem;
    line-height: 1.4;
    transition: background-color 0.2s ease;
}

.log-entry:hover {
    background: rgba(255, 255, 255, 0.05);
}

.log-timestamp {
    color: var(--accent-cyan);
    font-weight: 600;
    margin-right: 8px;
}

.log-service {
    color: var(--accent-blue);
    font-weight: 600;
    margin-right: 8px;
    text-transform: uppercase;
}

.log-level {
    font-weight: 600;
    margin-right: 8px;
    text-transform: uppercase;
}

.log-level.ERROR { color: #ff6b6b; }
.log-level.WARN, .log-level.WARNING { color: #ffd93d; }
.log-level.INFO { color: #6bcf7f; }
.log-level.DEBUG { color: #a78bfa; }
.log-level.SUCCESS { color: #4ade80; }

.log-message {
    color: var(--white);
}

.filter-controls {
    display: flex;
    gap: 10px;
    flex-wrap: wrap;
}

.filter-controls .form-select {
    background-color: var(--dark-gray);
    border-color: var(--medium-gray);
    color: var(--white);
    min-width: 150px;
}

.filter-controls .form-select:focus {
    background-color: var(--dark-gray);
    border-color: var(--accent-blue);
    color: var(--white);
    box-shadow: 0 0 0 0.2rem rgba(0, 102, 255, 0.25);
}

.log-stats {
    display: flex;
    gap: 20px;
    margin-bottom: 15px;
}

.log-stat {
    padding: 8px 15px;
    background: var(--dark-gray);
    border-radius: 6px;
    border: 1px solid var(--medium-gray);
    font-size: 0.85rem;
}

.log-stat-label {
    color: var(--off-white);
    opacity: 0.8;
    margin-right: 5px;
}

.log-stat-value {
    font-weight: 600;
    color: var(--accent-blue);
}

.no-logs {
    text-align: center;
    padding: 40px;
    color: var(--off-white);
    opacity: 0.6;
}
</style>
{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="row">
        <div class="col-12">
            <div class="card shadow">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h3 class="card-title mb-0">
                        <i class="fas fa-terminal me-2"></i>System Logs
                    </h3>
                    <div class="filter-controls">
                        <select class="form-select form-select-sm" id="service-filter">
                            <option value="all">All Services</option>
                            <option value="api">API</option>
                            <option value="web">Web</option>
                            <option value="worker">Worker</option>
                            <option value="trading-bots">Trading Bots</option>
                            <option value="dex-arbitrage">DEX Arbitrage</option>
                            <option value="validators">Validators</option>
                            <option value="strategy-monitor">Strategy Monitor</option>
                            <option value="database">Database</option>
                            <option value="websocket">WebSocket</option>
                        </select>
                        
                        <select class="form-select form-select-sm" id="level-filter">
                            <option value="all">All Levels</option>
                            <option value="error">Error</option>
                            <option value="warn">Warning</option>
                            <option value="info">Info</option>
                            <option value="debug">Debug</option>
                        </select>
                        
                        <input type="text" class="form-control form-control-sm" id="search-filter" placeholder="Search logs..." style="width: 200px;">
                        
                        <button class="btn btn-sm btn-primary" onclick="refreshLogs()">
                            <i class="fas fa-sync-alt"></i> Refresh
                        </button>
                        <button class="btn btn-sm btn-secondary" onclick="toggleAutoRefresh()">
                            <i class="fas fa-play" id="auto-refresh-icon"></i> <span id="auto-refresh-text">Auto Refresh</span>
                        </button>
                        <button class="btn btn-sm btn-outline-secondary" onclick="exportLogs()">
                            <i class="fas fa-download"></i> Export
                        </button>
                        <button class="btn btn-sm btn-outline-danger" onclick="clearDisplay()">
                            <i class="fas fa-trash"></i> Clear
                        </button>
                    </div>
                </div>
                <div class="card-body">
                    <div class="log-stats" id="log-stats">
                        <div class="log-stat">
                            <span class="log-stat-label">Total Logs:</span>
                            <span class="log-stat-value" id="total-logs">0</span>
                        </div>
                        <div class="log-stat">
                            <span class="log-stat-label">Errors:</span>
                            <span class="log-stat-value" id="error-count">0</span>
                        </div>
                        <div class="log-stat">
                            <span class="log-stat-label">Warnings:</span>
                            <span class="log-stat-value" id="warning-count">0</span>
                        </div>
                        <div class="log-stat">
                            <span class="log-stat-label">Last Update:</span>
                            <span class="log-stat-value" id="last-update">-</span>
                        </div>
                    </div>
                    
                    <div class="logs-container" id="logs-container">
                        <div id="logs-content">
                            <div class="text-center p-4">
                                <i class="fas fa-spinner fa-spin fa-2x mb-3"></i>
                                <p>Loading logs from deployment services...</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
let autoRefreshInterval = null;
let isAutoRefresh = false;
let allLogs = [];
let filteredLogs = [];

// Initialize filters
document.addEventListener('DOMContentLoaded', function() {
    loadLogs();
    
    // Add event listeners for filters
    document.getElementById('service-filter').addEventListener('change', applyFilters);
    document.getElementById('level-filter').addEventListener('change', applyFilters);
    document.getElementById('search-filter').addEventListener('input', applyFilters);
});

async function loadLogs() {
    try {
        const token = localStorage.getItem('access_token');
        const response = await fetch('/api/system-logs?limit=500', {
            headers: {
                'Authorization': `Bearer ${token}`
            }
        });
        
        if (response.ok) {
            const data = await response.json();
            allLogs = data.logs || data || [];
            
            // If no real logs, generate sample logs for demonstration
            if (allLogs.length === 0) {
                allLogs = generateDemoLogs();
            }
            
            applyFilters();
            updateLastUpdate();
        } else if (response.status === 404) {
            // Try alternative endpoints
            await loadAlternativeLogs();
        } else {
            showError('Failed to load logs from server');
        }
    } catch (error) {
        console.error('Error loading logs:', error);
        showError('Error connecting to log service');
        // Show demo logs as fallback
        allLogs = generateDemoLogs();
        applyFilters();
    }
}

async function loadAlternativeLogs() {
    // Try to load from different endpoints
    const endpoints = [
        '/api/logs',
        '/api/dashboard/logs',
        '/api/monitoring/logs',
        '/api/system/logs'
    ];
    
    const token = localStorage.getItem('access_token');
    
    for (const endpoint of endpoints) {
        try {
            const response = await fetch(endpoint, {
                headers: {
                    'Authorization': `Bearer ${token}`
                }
            });
            
            if (response.ok) {
                const data = await response.json();
                allLogs = data.logs || data || [];
                applyFilters();
                updateLastUpdate();
                return;
            }
        } catch (error) {
            console.error(`Failed to load from ${endpoint}:`, error);
        }
    }
    
    // If all endpoints fail, use demo logs
    allLogs = generateDemoLogs();
    applyFilters();
}

function generateDemoLogs() {
    const services = ['api', 'web', 'worker', 'trading-bots', 'dex-arbitrage', 'validators', 'strategy-monitor', 'database', 'websocket'];
    const levels = ['INFO', 'WARN', 'ERROR', 'DEBUG'];
    const messages = {
        'api': [
            'API server started successfully on port 8000',
            'Received request: GET /api/dashboard/trading-bots',
            'Authentication successful for user: admin@tar.global',
            'Rate limit check passed for IP: 192.168.1.100',
            'Database connection pool initialized'
        ],
        'web': [
            'Web server started on port 10000',
            'Static files served from /static',
            'Template rendered: dashboard.html',
            'Session created for user: admin',
            'CORS headers configured'
        ],
        'worker': [
            'Background worker started',
            'Processing queue: 15 pending tasks',
            'Scheduled job: cleanup_old_logs completed',
            'Memory usage: 245MB / 512MB',
            'Cache refresh completed'
        ],
        'trading-bots': [
            'Bot instance 1 connected to Binance',
            'Order placed: BUY BTC/USDT @ 45,234.50',
            'Strategy execution: DCA Futures triggered',
            'Portfolio rebalance completed',
            'Market data stream connected'
        ],
        'dex-arbitrage': [
            'DEX monitor initialized for BNB Chain',
            'Price discrepancy detected: CAKE/USDT 2.3%',
            'Arbitrage opportunity executed',
            'Gas estimation: 0.002 BNB',
            'Profit realized: $23.45'
        ],
        'validators': [
            'Validator connected to TON network',
            'Block validation successful: #1234567',
            'Rewards claimed: 2.345 TON',
            'Node health check: OK',
            'Uptime: 99.98%'
        ],
        'strategy-monitor': [
            'Strategy monitor service started',
            'Performance calculation completed',
            'Risk assessment: Low',
            'Alert: High volatility detected',
            'Strategy optimization applied'
        ],
        'database': [
            'PostgreSQL connection established',
            'Migration 001_initial applied',
            'Query execution time: 23ms',
            'Backup completed successfully',
            'Connection pool: 8/10 active'
        ],
        'websocket': [
            'WebSocket server started on port 8001',
            'Client connected: user_123',
            'Broadcasting dashboard update',
            'Heartbeat sent to 5 clients',
            'Connection closed: user_456'
        ]
    };
    
    const logs = [];
    const now = new Date();
    
    // Generate 200 sample logs
    for (let i = 0; i < 200; i++) {
        const service = services[Math.floor(Math.random() * services.length)];
        const level = i % 20 === 0 ? 'ERROR' : i % 15 === 0 ? 'WARN' : i % 5 === 0 ? 'DEBUG' : 'INFO';
        const serviceMessages = messages[service];
        const message = serviceMessages[Math.floor(Math.random() * serviceMessages.length)];
        
        logs.push({
            timestamp: new Date(now.getTime() - (i * 30000)).toISOString(), // 30 seconds apart
            service: service,
            level: level,
            message: level === 'ERROR' ? `Error: ${message} - Connection timeout` : 
                    level === 'WARN' ? `Warning: ${message} - Retry attempt 3/5` : 
                    message
        });
    }
    
    return logs;
}

function applyFilters() {
    const serviceFilter = document.getElementById('service-filter').value;
    const levelFilter = document.getElementById('level-filter').value;
    const searchFilter = document.getElementById('search-filter').value.toLowerCase();
    
    filteredLogs = allLogs.filter(log => {
        // Service filter
        if (serviceFilter !== 'all' && log.service !== serviceFilter) {
            return false;
        }
        
        // Level filter
        if (levelFilter !== 'all' && log.level.toLowerCase() !== levelFilter) {
            return false;
        }
        
        // Search filter
        if (searchFilter && !log.message.toLowerCase().includes(searchFilter)) {
            return false;
        }
        
        return true;
    });
    
    displayLogs(filteredLogs);
    updateStats();
}

function displayLogs(logs) {
    const container = document.getElementById('logs-content');
    
    if (logs.length === 0) {
        container.innerHTML = '<div class="no-logs"><i class="fas fa-info-circle fa-2x mb-3"></i><p>No logs found matching the current filters</p></div>';
        return;
    }
    
    container.innerHTML = logs.map(log => {
        const timestamp = new Date(log.timestamp).toLocaleString('en-US', {
            month: '2-digit',
            day: '2-digit',
            hour: '2-digit',
            minute: '2-digit',
            second: '2-digit'
        });
        
        return `
            <div class="log-entry">
                <span class="log-timestamp">${timestamp}</span>
                <span class="log-service">[${log.service}]</span>
                <span class="log-level ${log.level}">[${log.level}]</span>
                <span class="log-message">${escapeHtml(log.message)}</span>
            </div>
        `;
    }).join('');
    
    // Auto-scroll to bottom
    const logsContainer = document.getElementById('logs-container');
    logsContainer.scrollTop = logsContainer.scrollHeight;
}

function updateStats() {
    document.getElementById('total-logs').textContent = filteredLogs.length;
    document.getElementById('error-count').textContent = filteredLogs.filter(log => log.level === 'ERROR').length;
    document.getElementById('warning-count').textContent = filteredLogs.filter(log => log.level === 'WARN' || log.level === 'WARNING').length;
}

function updateLastUpdate() {
    document.getElementById('last-update').textContent = new Date().toLocaleTimeString();
}

function showError(message) {
    const container = document.getElementById('logs-content');
    container.innerHTML = `<div class="text-danger text-center p-4"><i class="fas fa-exclamation-triangle fa-2x mb-3"></i><p>${message}</p></div>`;
}

function refreshLogs() {
    loadLogs();
}

function toggleAutoRefresh() {
    const icon = document.getElementById('auto-refresh-icon');
    const text = document.getElementById('auto-refresh-text');
    
    if (isAutoRefresh) {
        clearInterval(autoRefreshInterval);
        icon.className = 'fas fa-play';
        text.textContent = 'Auto Refresh';
        isAutoRefresh = false;
    } else {
        autoRefreshInterval = setInterval(loadLogs, 5000); // Refresh every 5 seconds
        icon.className = 'fas fa-pause';
        text.textContent = 'Stop Auto';
        isAutoRefresh = true;
        loadLogs(); // Load immediately
    }
}

function exportLogs() {
    const logsText = filteredLogs.map(log => {
        const timestamp = new Date(log.timestamp).toISOString();
        return `${timestamp} [${log.service}] [${log.level}] ${log.message}`;
    }).join('\n');
    
    const blob = new Blob([logsText], { type: 'text/plain' });
    const url = window.URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `system-logs-${new Date().toISOString().split('T')[0]}.log`;
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    window.URL.revokeObjectURL(url);
}

function clearDisplay() {
    document.getElementById('logs-content').innerHTML = '<div class="no-logs"><i class="fas fa-info-circle fa-2x mb-3"></i><p>Display cleared. Click Refresh to reload logs.</p></div>';
}

function escapeHtml(text) {
    const map = {
        '&': '&amp;',
        '<': '&lt;',
        '>': '&gt;',
        '"': '&quot;',
        "'": '&#039;'
    };
    return text.replace(/[&<>"']/g, m => map[m]);
}
</script>
{% endblock %}
