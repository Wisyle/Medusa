{% extends "base.html" %}

{% block title %}DEX Arbitrage - Tar Global Strategies{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="row">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <h2><i class="fas fa-exchange-alt text-primary"></i> DEX Arbitrage Monitor</h2>
                <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#createArbitrageModal">
                    <i class="fas fa-plus"></i> New Arbitrage Instance
                </button>
            </div>
        </div>
    </div>

    <!-- Stats Cards -->
    <div class="row mb-4">
        <div class="col-md-3">
            <div class="card bg-primary text-white">
                <div class="card-body">
                    <div class="d-flex justify-content-between">
                        <div>
                            <h6 class="card-title">Total Instances</h6>
                            <h3 id="totalInstances">0</h3>
                        </div>
                        <div class="align-self-center">
                            <i class="fas fa-robot fa-2x"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card bg-success text-white">
                <div class="card-body">
                    <div class="d-flex justify-content-between">
                        <div>
                            <h6 class="card-title">Active Monitors</h6>
                            <h3 id="activeInstances">0</h3>
                        </div>
                        <div class="align-self-center">
                            <i class="fas fa-play-circle fa-2x"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card bg-warning text-white">
                <div class="card-body">
                    <div class="d-flex justify-content-between">
                        <div>
                            <h6 class="card-title">Opportunities (24h)</h6>
                            <h3 id="totalOpportunities">0</h3>
                        </div>
                        <div class="align-self-center">
                            <i class="fas fa-chart-line fa-2x"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card bg-info text-white">
                <div class="card-body">
                    <div class="d-flex justify-content-between">
                        <div>
                            <h6 class="card-title">Potential Profit</h6>
                            <h3 id="totalProfit">$0.00</h3>
                        </div>
                        <div class="align-self-center">
                            <i class="fas fa-dollar-sign fa-2x"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Arbitrage Instances Table -->
    <div class="row">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <h5><i class="fas fa-list"></i> Arbitrage Instances</h5>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-striped" id="arbitrageTable">
                            <thead>
                                <tr>
                                    <th>Name</th>
                                    <th>Chain</th>
                                    <th>Pair</th>
                                    <th>Primary DEX</th>
                                    <th>Secondary DEX</th>
                                    <th>Min Profit %</th>
                                    <th>Status</th>
                                    <th>Last Check</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody id="arbitrageTableBody">
                                <!-- Dynamic content -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Recent Opportunities -->
    <div class="row mt-4">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <h5><i class="fas fa-bolt"></i> Recent Arbitrage Opportunities</h5>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-sm" id="opportunitiesTable">
                            <thead>
                                <tr>
                                    <th>Time</th>
                                    <th>Pair</th>
                                    <th>Chain</th>
                                    <th>Primary Price</th>
                                    <th>Secondary Price</th>
                                    <th>Profit %</th>
                                    <th>Potential Profit</th>
                                    <th>Status</th>
                                </tr>
                            </thead>
                            <tbody id="opportunitiesTableBody">
                                <!-- Dynamic content -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Create Arbitrage Instance Modal -->
<div class="modal fade" id="createArbitrageModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Create DEX Arbitrage Instance</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="createArbitrageForm">
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label class="form-label">Instance Name</label>
                                <input type="text" class="form-control" name="name" required>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label class="form-label">Blockchain</label>
                                <select class="form-select" name="chain" required>
                                    <option value="">Select Chain</option>
                                    <option value="bnb">BNB Chain</option>
                                    <option value="solana">Solana</option>
                                    <option value="ethereum">Ethereum</option>
                                </select>
                            </div>
                        </div>
                    </div>
                    
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label class="form-label">Trading Pair</label>
                                <input type="text" class="form-control" name="dex_pair" placeholder="BNB/USDT" required>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label class="form-label">Min Profit Threshold (%)</label>
                                <input type="number" class="form-control" name="min_profit_threshold" value="0.5" step="0.1" min="0.1">
                            </div>
                        </div>
                    </div>
                    
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label class="form-label">Primary DEX</label>
                                <select class="form-select" name="primary_dex" required>
                                    <option value="">Select Primary DEX</option>
                                    <option value="pancakeswap">PancakeSwap</option>
                                    <option value="uniswap">Uniswap</option>
                                    <option value="raydium">Raydium</option>
                                    <option value="jupiter">Jupiter</option>
                                    <option value="orca">Orca</option>
                                    <option value="sushiswap">SushiSwap</option>
                                </select>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label class="form-label">Secondary DEX</label>
                                <select class="form-select" name="secondary_dex" required>
                                    <option value="">Select Secondary DEX</option>
                                    <option value="pancakeswap">PancakeSwap</option>
                                    <option value="uniswap">Uniswap</option>
                                    <option value="raydium">Raydium</option>
                                    <option value="jupiter">Jupiter</option>
                                    <option value="orca">Orca</option>
                                    <option value="sushiswap">SushiSwap</option>
                                </select>
                            </div>
                        </div>
                    </div>
                    
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label class="form-label">Max Trade Amount ($)</label>
                                <input type="number" class="form-control" name="max_trade_amount" value="1000" min="100">
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label class="form-label">Gas Limit</label>
                                <input type="number" class="form-control" name="gas_limit" value="300000" min="100000">
                            </div>
                        </div>
                    </div>
                    
                    <div class="mb-3">
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" name="auto_execute" id="autoExecute">
                            <label class="form-check-label" for="autoExecute">
                                Auto-execute profitable trades (⚠️ Use with caution)
                            </label>
                        </div>
                    </div>
                    
                    <div class="mb-3">
                        <label class="form-label">Description</label>
                        <textarea class="form-control" name="description" rows="2"></textarea>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" onclick="createArbitrageInstance()">Create Instance</button>
            </div>
        </div>
    </div>
</div>

<script>
let arbitrageInstances = [];
let opportunities = [];

// Load data on page load
document.addEventListener('DOMContentLoaded', function() {
    loadArbitrageData();
    loadOpportunities();
    
    // Auto-refresh every 30 seconds
    setInterval(() => {
        loadArbitrageData();
        loadOpportunities();
    }, 30000);
});

async function loadArbitrageData() {
    try {
        const response = await fetch('/api/dex-arbitrage/instances');
        if (response.ok) {
            arbitrageInstances = await response.json();
            updateArbitrageTable();
            updateStats();
        }
    } catch (error) {
        console.error('Error loading arbitrage data:', error);
    }
}

async function loadOpportunities() {
    try {
        const response = await fetch('/api/dex-arbitrage/opportunities?hours=24');
        if (response.ok) {
            opportunities = await response.json();
            updateOpportunitiesTable();
        }
    } catch (error) {
        console.error('Error loading opportunities:', error);
    }
}

function updateStats() {
    const totalInstances = arbitrageInstances.length;
    const activeInstances = arbitrageInstances.filter(i => i.is_active).length;
    const totalOpportunities = opportunities.length;
    const totalProfit = opportunities.reduce((sum, opp) => sum + opp.potential_profit_usd, 0);
    
    document.getElementById('totalInstances').textContent = totalInstances;
    document.getElementById('activeInstances').textContent = activeInstances;
    document.getElementById('totalOpportunities').textContent = totalOpportunities;
    document.getElementById('totalProfit').textContent = `$${totalProfit.toFixed(2)}`;
}

function updateArbitrageTable() {
    const tbody = document.getElementById('arbitrageTableBody');
    tbody.innerHTML = '';
    
    arbitrageInstances.forEach(instance => {
        const row = document.createElement('tr');
        row.innerHTML = `
            <td><strong>${instance.name}</strong></td>
            <td><span class="badge bg-secondary">${instance.chain.toUpperCase()}</span></td>
            <td>${instance.dex_pair}</td>
            <td>${instance.primary_dex}</td>
            <td>${instance.secondary_dex}</td>
            <td>${instance.min_profit_threshold}%</td>
            <td>
                <span class="badge ${instance.is_active ? 'bg-success' : 'bg-danger'}">
                    ${instance.is_active ? 'Active' : 'Inactive'}
                </span>
            </td>
            <td>${instance.last_check ? new Date(instance.last_check).toLocaleString() : 'Never'}</td>
            <td>
                <div class="btn-group btn-group-sm">
                    <button class="btn btn-outline-primary" onclick="toggleInstance(${instance.id})">
                        <i class="fas ${instance.is_active ? 'fa-pause' : 'fa-play'}"></i>
                    </button>
                    <button class="btn btn-outline-info" onclick="viewInstance(${instance.id})">
                        <i class="fas fa-eye"></i>
                    </button>
                    <button class="btn btn-outline-danger" onclick="deleteInstance(${instance.id})">
                        <i class="fas fa-trash"></i>
                    </button>
                </div>
            </td>
        `;
        tbody.appendChild(row);
    });
}

function updateOpportunitiesTable() {
    const tbody = document.getElementById('opportunitiesTableBody');
    tbody.innerHTML = '';
    
    opportunities.slice(0, 20).forEach(opp => {
        const row = document.createElement('tr');
        const profitClass = opp.profit_percentage >= 1 ? 'text-success' : 'text-warning';
        
        row.innerHTML = `
            <td>${new Date(opp.detected_at).toLocaleString()}</td>
            <td>${opp.pair}</td>
            <td><span class="badge bg-secondary">${opp.chain.toUpperCase()}</span></td>
            <td>$${parseFloat(opp.primary_price).toFixed(6)}</td>
            <td>$${parseFloat(opp.secondary_price).toFixed(6)}</td>
            <td><span class="${profitClass}"><strong>${opp.profit_percentage.toFixed(2)}%</strong></span></td>
            <td>$${opp.potential_profit_usd.toFixed(2)}</td>
            <td>
                <span class="badge ${opp.was_executed ? 'bg-success' : 'bg-warning'}">
                    ${opp.was_executed ? 'Executed' : 'Detected'}
                </span>
            </td>
        `;
        tbody.appendChild(row);
    });
}

async function createArbitrageInstance() {
    const form = document.getElementById('createArbitrageForm');
    const formData = new FormData(form);
    const data = Object.fromEntries(formData.entries());
    
    // Convert checkbox to boolean
    data.auto_execute = formData.has('auto_execute');
    
    try {
        const response = await fetch('/api/dex-arbitrage/instances', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify(data)
        });
        
        if (response.ok) {
            const result = await response.json();
            alert('Arbitrage instance created successfully!');
            bootstrap.Modal.getInstance(document.getElementById('createArbitrageModal')).hide();
            form.reset();
            loadArbitrageData();
        } else {
            const error = await response.json();
            alert(`Error: ${error.detail}`);
        }
    } catch (error) {
        console.error('Error creating instance:', error);
        alert('Error creating arbitrage instance');
    }
}

async function toggleInstance(instanceId) {
    const instance = arbitrageInstances.find(i => i.id === instanceId);
    const action = instance.is_active ? 'stop' : 'start';
    
    try {
        const response = await fetch(`/api/dex-arbitrage/instances/${instanceId}/${action}`, {
            method: 'POST'
        });
        
        if (response.ok) {
            loadArbitrageData();
        } else {
            const error = await response.json();
            alert(`Error: ${error.detail}`);
        }
    } catch (error) {
        console.error('Error toggling instance:', error);
        alert('Error toggling instance');
    }
}

async function deleteInstance(instanceId) {
    if (!confirm('Are you sure you want to delete this arbitrage instance?')) {
        return;
    }
    
    try {
        const response = await fetch(`/api/dex-arbitrage/instances/${instanceId}`, {
            method: 'DELETE'
        });
        
        if (response.ok) {
            loadArbitrageData();
        } else {
            const error = await response.json();
            alert(`Error: ${error.detail}`);
        }
    } catch (error) {
        console.error('Error deleting instance:', error);
        alert('Error deleting instance');
    }
}

function viewInstance(instanceId) {
    // TODO: Implement instance detail view
    alert('Instance detail view coming soon!');
}
</script>
{% endblock %}
