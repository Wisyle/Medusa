{% extends "base.html" %}

{% block title %}Notification Management - Lighthouse{% endblock %}

{% block extra_head %}
<style>
.notification-header {
    background: linear-gradient(145deg, var(--secondary-black), var(--dark-gray));
    border: 1px solid var(--medium-gray);
    border-radius: 16px;
    padding: 25px;
    margin-bottom: 30px;
    box-shadow: 
        0 8px 32px rgba(0, 0, 0, 0.3),
        0 0 0 1px rgba(255, 255, 255, 0.05),
        inset 0 1px 0 rgba(255, 255, 255, 0.1);
}

.notification-section {
    background: linear-gradient(145deg, var(--secondary-black), var(--dark-gray));
    border: 1px solid var(--medium-gray);
    border-radius: 16px;
    margin-bottom: 25px;
    overflow: hidden;
    box-shadow: 
        0 8px 32px rgba(0, 0, 0, 0.3),
        0 0 0 1px rgba(255, 255, 255, 0.05),
        inset 0 1px 0 rgba(255, 255, 255, 0.1);
}

.section-header {
    background: linear-gradient(135deg, var(--light-gray), var(--medium-gray));
    padding: 20px 25px;
    border-bottom: 1px solid var(--medium-gray);
    display: flex;
    align-items: center;
    justify-content: space-between;
}

.section-title {
    color: var(--white);
    font-weight: 600;
    margin: 0;
    display: flex;
    align-items: center;
    gap: 10px;
}

.section-icon {
    color: var(--accent-blue);
    font-size: 1.3rem;
}

.status-indicator {
    padding: 4px 12px;
    border-radius: 20px;
    font-size: 0.85rem;
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 0.5px;
}

.status-active {
    background: linear-gradient(135deg, #11998e, #38ef7d);
    color: white;
}

.status-inactive {
    background: linear-gradient(135deg, #fc466b, #3f5efb);
    color: white;
}

.status-warning {
    background: linear-gradient(135deg, #fdbb2d, #22c1c3);
    color: white;
}

.config-form {
    padding: 25px;
}

.form-group {
    margin-bottom: 20px;
}

.form-label {
    color: var(--off-white);
    font-weight: 600;
    margin-bottom: 8px;
    display: block;
    font-size: 0.9rem;
}

.form-control {
    background: rgba(255, 255, 255, 0.05);
    border: 2px solid var(--medium-gray);
    border-radius: 12px;
    padding: 12px 16px;
    color: var(--white);
    font-size: 1rem;
    transition: all 0.3s ease;
    width: 100%;
}

.form-control:focus {
    outline: none;
    border-color: var(--accent-blue);
    background: rgba(255, 255, 255, 0.08);
    box-shadow: 0 0 0 3px rgba(0, 102, 255, 0.1);
}

.form-control::placeholder {
    color: rgba(255, 255, 255, 0.4);
}

.test-section {
    background: linear-gradient(135deg, rgba(0, 102, 255, 0.1), rgba(0, 212, 255, 0.05));
    border: 1px solid rgba(0, 102, 255, 0.3);
    border-radius: 12px;
    padding: 20px;
    margin-top: 20px;
}

.webhook-list {
    background: rgba(255, 255, 255, 0.02);
    border-radius: 12px;
    padding: 20px;
    margin-top: 15px;
}

.webhook-item {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 12px;
    background: rgba(255, 255, 255, 0.05);
    border-radius: 8px;
    margin-bottom: 10px;
    border: 1px solid var(--medium-gray);
}

.webhook-url {
    color: var(--accent-blue);
    font-family: 'Courier New', monospace;
    font-size: 0.9rem;
    word-break: break-all;
}

.logs-section {
    max-height: 400px;
    overflow-y: auto;
    background: rgba(0, 0, 0, 0.3);
    border-radius: 12px;
    padding: 15px;
    margin-top: 15px;
}

.log-entry {
    padding: 8px 12px;
    margin-bottom: 8px;
    border-radius: 8px;
    font-family: 'Courier New', monospace;
    font-size: 0.85rem;
    border-left: 3px solid;
}

.log-success {
    background: rgba(56, 239, 125, 0.1);
    border-left-color: #38ef7d;
    color: #38ef7d;
}

.log-error {
    background: rgba(252, 70, 107, 0.1);
    border-left-color: #fc466b;
    color: #fc466b;
}

.log-info {
    background: rgba(0, 102, 255, 0.1);
    border-left-color: var(--accent-blue);
    color: var(--accent-blue);
}

.metric-card {
    background: linear-gradient(135deg, var(--secondary-black), var(--dark-gray));
    border: 1px solid var(--medium-gray);
    border-radius: 12px;
    padding: 20px;
    text-align: center;
    transition: all 0.3s ease;
}

.metric-card:hover {
    transform: translateY(-2px);
    box-shadow: 0 8px 25px rgba(0, 102, 255, 0.2);
}

.metric-value {
    font-size: 2rem;
    font-weight: bold;
    color: var(--accent-blue);
    margin-bottom: 5px;
}

.metric-label {
    color: var(--off-white);
    font-size: 0.9rem;
    opacity: 0.8;
}

.notification-preview {
    background: linear-gradient(135deg, rgba(255, 215, 0, 0.1), rgba(255, 215, 0, 0.05));
    border: 1px solid rgba(255, 215, 0, 0.3);
    border-radius: 12px;
    padding: 20px;
    margin-top: 15px;
}
</style>
{% endblock %}

{% block content %}
<div class="notification-header">
    <div class="d-flex align-items-center justify-content-between">
        <div>
            <h1 class="h2 mb-2">
                <i class="fas fa-bell-concierge text-primary"></i>
                Notification Management
            </h1>
            <p class="text-muted mb-0">Configure and monitor your notification channels</p>
        </div>
        <div class="d-flex gap-3">
            <button class="btn btn-outline-primary" onclick="refreshStatus()">
                <i class="fas fa-sync-alt"></i> Refresh Status
            </button>
            <button class="btn btn-primary" onclick="sendTestNotification()">
                <i class="fas fa-paper-plane"></i> Send Test
            </button>
        </div>
    </div>
</div>

<!-- Notification Overview -->
<div class="row mb-4">
    <div class="col-md-3">
        <div class="metric-card">
            <div class="metric-value" id="total-sent">-</div>
            <div class="metric-label">Total Sent</div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="metric-card">
            <div class="metric-value" id="success-rate">-</div>
            <div class="metric-label">Success Rate</div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="metric-card">
            <div class="metric-value" id="active-channels">-</div>
            <div class="metric-label">Active Channels</div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="metric-card">
            <div class="metric-value" id="last-sent">-</div>
            <div class="metric-label">Last Sent</div>
        </div>
    </div>
</div>

<!-- Telegram Configuration -->
<div class="notification-section">
    <div class="section-header">
        <h3 class="section-title">
            <i class="fab fa-telegram section-icon"></i>
            Telegram Configuration
        </h3>
        <span class="status-indicator" id="telegram-status">Loading...</span>
    </div>
    <div class="config-form">
        <div class="row">
            <div class="col-md-6">
                <div class="form-group">
                    <label for="telegram-token" class="form-label">Bot Token</label>
                    <input type="password" class="form-control" id="telegram-token" 
                           placeholder="Enter your bot token">
                    <small class="text-muted">Get this from @BotFather on Telegram</small>
                </div>
            </div>
            <div class="col-md-6">
                <div class="form-group">
                    <label for="telegram-chat-id" class="form-label">Chat ID</label>
                    <input type="text" class="form-control" id="telegram-chat-id" 
                           placeholder="Enter chat ID">
                    <small class="text-muted">Chat ID where notifications will be sent</small>
                </div>
            </div>
        </div>
        <div class="row">
            <div class="col-md-6">
                <div class="form-group">
                    <label for="telegram-topic-id" class="form-label">Topic ID (Optional)</label>
                    <input type="text" class="form-control" id="telegram-topic-id" 
                           placeholder="Enter topic ID">
                    <small class="text-muted">For forum groups only</small>
                </div>
            </div>
            <div class="col-md-6">
                <div class="form-group">
                    <label class="form-label">Notifications Enabled</label>
                    <div class="form-check form-switch">
                        <input class="form-check-input" type="checkbox" id="telegram-enabled">
                        <label class="form-check-label" for="telegram-enabled">
                            Enable Telegram notifications
                        </label>
                    </div>
                </div>
            </div>
        </div>
        <button class="btn btn-primary" onclick="updateTelegramConfig()">
            <i class="fas fa-save"></i> Save Configuration
        </button>
        
        <div class="test-section">
            <h5><i class="fas fa-paper-plane"></i> Test Telegram</h5>
            <p class="text-muted mb-3">Send a test message to verify your configuration</p>
            <button class="btn btn-outline-primary" onclick="testTelegram()">
                <i class="fas fa-paper-plane"></i> Send Test Message
            </button>
        </div>
    </div>
</div>

<!-- Webhook Configuration -->
<div class="notification-section">
    <div class="section-header">
        <h3 class="section-title">
            <i class="fas fa-link section-icon"></i>
            Webhook Configuration
        </h3>
        <span class="status-indicator" id="webhook-status">Loading...</span>
    </div>
    <div class="config-form">
        <div class="form-group">
            <label for="webhook-urls" class="form-label">Webhook URLs</label>
            <textarea class="form-control" id="webhook-urls" rows="4" 
                      placeholder="Enter webhook URLs (one per line)"></textarea>
            <small class="text-muted">Each URL should be on a separate line</small>
        </div>
        <button class="btn btn-primary" onclick="updateWebhookConfig()">
            <i class="fas fa-save"></i> Save Webhooks
        </button>
        
        <div class="webhook-list" id="webhook-list">
            <h6>Current Webhooks:</h6>
            <div id="webhook-items">
                <p class="text-muted">No webhooks configured</p>
            </div>
        </div>
        
        <div class="test-section">
            <h5><i class="fas fa-globe"></i> Test Webhooks</h5>
            <p class="text-muted mb-3">Send a test payload to all configured webhooks</p>
            <button class="btn btn-outline-primary" onclick="testWebhooks()">
                <i class="fas fa-globe"></i> Test All Webhooks
            </button>
        </div>
    </div>
</div>

<!-- Rate Limiting -->
<div class="notification-section">
    <div class="section-header">
        <h3 class="section-title">
            <i class="fas fa-tachometer-alt section-icon"></i>
            Rate Limiting
        </h3>
        <span class="status-indicator status-active">Active</span>
    </div>
    <div class="config-form">
        <div class="row">
            <div class="col-md-6">
                <div class="form-group">
                    <label class="form-label">Rate Limit (seconds)</label>
                    <input type="number" class="form-control" id="rate-limit" 
                           placeholder="60" min="1" max="3600">
                    <small class="text-muted">Minimum time between notifications of the same type</small>
                </div>
            </div>
            <div class="col-md-6">
                <div class="form-group">
                    <label class="form-label">Batch Size</label>
                    <input type="number" class="form-control" id="batch-size" 
                           placeholder="10" min="1" max="100">
                    <small class="text-muted">Maximum notifications per batch</small>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Custom Test Notification -->
<div class="notification-section">
    <div class="section-header">
        <h3 class="section-title">
            <i class="fas fa-paper-plane section-icon"></i>
            Send Custom Notification
        </h3>
    </div>
    <div class="config-form">
        <div class="row">
            <div class="col-md-6">
                <div class="form-group">
                    <label for="custom-title" class="form-label">Title</label>
                    <input type="text" class="form-control" id="custom-title" 
                           placeholder="Test Notification">
                </div>
            </div>
            <div class="col-md-6">
                <div class="form-group">
                    <label for="custom-priority" class="form-label">Priority</label>
                    <select class="form-control" id="custom-priority">
                        <option value="low">Low</option>
                        <option value="normal" selected>Normal</option>
                        <option value="high">High</option>
                        <option value="critical">Critical</option>
                    </select>
                </div>
            </div>
        </div>
        <div class="form-group">
            <label for="custom-message" class="form-label">Message</label>
            <textarea class="form-control" id="custom-message" rows="3" 
                      placeholder="Enter your notification message"></textarea>
        </div>
        <button class="btn btn-primary" onclick="sendCustomNotification()">
            <i class="fas fa-paper-plane"></i> Send Notification
        </button>
        
        <div class="notification-preview" id="notification-preview" style="display: none;">
            <h6><i class="fas fa-eye"></i> Preview</h6>
            <div id="preview-content"></div>
        </div>
    </div>
</div>

<!-- Recent Notifications Log -->
<div class="notification-section">
    <div class="section-header">
        <h3 class="section-title">
            <i class="fas fa-history section-icon"></i>
            Recent Notifications
        </h3>
        <button class="btn btn-outline-secondary btn-sm" onclick="clearLogs()">
            <i class="fas fa-trash"></i> Clear Logs
        </button>
    </div>
    <div class="config-form">
        <div class="logs-section" id="notification-logs">
            <div class="log-entry log-info">
                <strong>[INFO]</strong> Notification system initialized
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
let notificationStatus = {};

// Initialize page
document.addEventListener('DOMContentLoaded', function() {
    loadNotificationStatus();
    loadMetrics();
    
    // Auto-refresh every 30 seconds
    setInterval(() => {
        loadNotificationStatus();
        loadMetrics();
    }, 30000);
});

// Load notification status
async function loadNotificationStatus() {
    try {
        const response = await fetch('/api/webhooks/status', {
            headers: {
                'Authorization': `Bearer ${localStorage.getItem('access_token')}`
            }
        });
        
        if (response.ok) {
            notificationStatus = await response.json();
            updateStatusDisplay();
        }
    } catch (error) {
        console.error('Error loading notification status:', error);
        addLog('error', 'Failed to load notification status');
    }
}

// Update status display
function updateStatusDisplay() {
    // Telegram status
    const telegramStatus = document.getElementById('telegram-status');
    if (notificationStatus.telegram?.configured) {
        telegramStatus.textContent = 'Active';
        telegramStatus.className = 'status-indicator status-active';
    } else {
        telegramStatus.textContent = 'Inactive';
        telegramStatus.className = 'status-indicator status-inactive';
    }
    
    // Webhook status
    const webhookStatus = document.getElementById('webhook-status');
    const webhookCount = notificationStatus.webhooks?.count || 0;
    if (webhookCount > 0) {
        webhookStatus.textContent = `${webhookCount} Active`;
        webhookStatus.className = 'status-indicator status-active';
    } else {
        webhookStatus.textContent = 'None';
        webhookStatus.className = 'status-indicator status-inactive';
    }
    
    // Update webhook list
    updateWebhookList();
    
    // Update rate limiting info
    if (notificationStatus.rate_limiting) {
        document.getElementById('rate-limit').value = notificationStatus.rate_limiting.rate_limit_seconds;
        document.getElementById('batch-size').value = notificationStatus.rate_limiting.batch_size;
    }
}

// Update webhook list display
function updateWebhookList() {
    const webhookItems = document.getElementById('webhook-items');
    const webhooks = notificationStatus.webhooks?.urls || [];
    
    if (webhooks.length === 0) {
        webhookItems.innerHTML = '<p class="text-muted">No webhooks configured</p>';
        return;
    }
    
    webhookItems.innerHTML = webhooks.map((url, index) => `
        <div class="webhook-item">
            <span class="webhook-url">${url}</span>
            <button class="btn btn-outline-danger btn-sm" onclick="removeWebhook(${index})">
                <i class="fas fa-trash"></i>
            </button>
        </div>
    `).join('');
}

// Load metrics
async function loadMetrics() {
    // Simulate metrics loading - in real implementation, these would come from the backend
    document.getElementById('total-sent').textContent = '1,247';
    document.getElementById('success-rate').textContent = '98.5%';
    document.getElementById('active-channels').textContent = (notificationStatus.webhooks?.count || 0) + (notificationStatus.telegram?.configured ? 1 : 0);
    document.getElementById('last-sent').textContent = '2 min ago';
}

// Test Telegram
async function testTelegram() {
    try {
        addLog('info', 'Sending Telegram test message...');
        
        const response = await fetch('/api/notifications/test', {
            method: 'GET',
            headers: {
                'Authorization': `Bearer ${localStorage.getItem('access_token')}`
            }
        });
        
        if (response.ok) {
            addLog('success', 'Telegram test message sent successfully');
            showAlert('success', 'Test message sent to Telegram');
        } else {
            const error = await response.json();
            addLog('error', `Telegram test failed: ${error.detail}`);
            showAlert('danger', 'Failed to send test message');
        }
    } catch (error) {
        console.error('Error testing Telegram:', error);
        addLog('error', 'Network error during Telegram test');
        showAlert('danger', 'Network error occurred');
    }
}

// Test webhooks
async function testWebhooks() {
    try {
        addLog('info', 'Testing all webhooks...');
        
        const response = await fetch('/api/notifications/send', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'Authorization': `Bearer ${localStorage.getItem('access_token')}`
            },
            body: JSON.stringify({
                title: 'Webhook Test',
                message: 'This is a test notification from Lighthouse',
                event_type: 'test',
                priority: 'normal'
            })
        });
        
        if (response.ok) {
            addLog('success', 'Webhook test completed successfully');
            showAlert('success', 'Test notifications sent to all webhooks');
        } else {
            const error = await response.json();
            addLog('error', `Webhook test failed: ${error.detail}`);
            showAlert('danger', 'Failed to send webhook test');
        }
    } catch (error) {
        console.error('Error testing webhooks:', error);
        addLog('error', 'Network error during webhook test');
        showAlert('danger', 'Network error occurred');
    }
}

// Send custom notification
async function sendCustomNotification() {
    const title = document.getElementById('custom-title').value;
    const message = document.getElementById('custom-message').value;
    const priority = document.getElementById('custom-priority').value;
    
    if (!title || !message) {
        showAlert('warning', 'Please fill in both title and message');
        return;
    }
    
    try {
        addLog('info', `Sending custom notification: ${title}`);
        
        const response = await fetch('/api/notifications/send', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'Authorization': `Bearer ${localStorage.getItem('access_token')}`
            },
            body: JSON.stringify({
                title: title,
                message: message,
                event_type: 'custom',
                priority: priority
            })
        });
        
        if (response.ok) {
            addLog('success', `Custom notification sent: ${title}`);
            showAlert('success', 'Custom notification sent successfully');
            
            // Clear form
            document.getElementById('custom-title').value = '';
            document.getElementById('custom-message').value = '';
        } else {
            const error = await response.json();
            addLog('error', `Custom notification failed: ${error.detail}`);
            showAlert('danger', 'Failed to send custom notification');
        }
    } catch (error) {
        console.error('Error sending custom notification:', error);
        addLog('error', 'Network error during custom notification');
        showAlert('danger', 'Network error occurred');
    }
}

// Send test notification
async function sendTestNotification() {
    await fetch('/api/notifications/test', {
        method: 'GET',
        headers: {
            'Authorization': `Bearer ${localStorage.getItem('access_token')}`
        }
    }).then(() => {
        showAlert('success', 'Test notification sent');
        addLog('success', 'Test notification sent to all channels');
    }).catch(() => {
        showAlert('danger', 'Failed to send test notification');
        addLog('error', 'Failed to send test notification');
    });
}

// Refresh status
function refreshStatus() {
    addLog('info', 'Refreshing notification status...');
    loadNotificationStatus();
    loadMetrics();
}

// Add log entry
function addLog(type, message) {
    const logsContainer = document.getElementById('notification-logs');
    const timestamp = new Date().toLocaleTimeString();
    
    const logEntry = document.createElement('div');
    logEntry.className = `log-entry log-${type}`;
    logEntry.innerHTML = `<strong>[${timestamp}]</strong> ${message}`;
    
    logsContainer.insertBefore(logEntry, logsContainer.firstChild);
    
    // Keep only last 50 entries
    while (logsContainer.children.length > 50) {
        logsContainer.removeChild(logsContainer.lastChild);
    }
}

// Clear logs
function clearLogs() {
    document.getElementById('notification-logs').innerHTML = `
        <div class="log-entry log-info">
            <strong>[INFO]</strong> Notification logs cleared
        </div>
    `;
}

// Update webhook configuration
async function updateWebhookConfig() {
    const urls = document.getElementById('webhook-urls').value.split('\n').filter(url => url.trim());
    
    try {
        addLog('info', 'Updating webhook configuration...');
        
        const response = await fetch('/api/webhooks/configure', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'Authorization': `Bearer ${localStorage.getItem('access_token')}`
            },
            body: JSON.stringify({ webhook_urls: urls })
        });
        
        if (response.ok) {
            addLog('success', `Updated webhook configuration with ${urls.length} URLs`);
            showAlert('success', 'Webhook configuration updated');
            loadNotificationStatus(); // Refresh status
        } else {
            const error = await response.json();
            addLog('error', `Webhook configuration failed: ${error.detail}`);
            showAlert('danger', 'Failed to update webhook configuration');
        }
    } catch (error) {
        console.error('Error updating webhook config:', error);
        addLog('error', 'Network error during webhook configuration update');
        showAlert('danger', 'Network error occurred');
    }
}

// Remove webhook
function removeWebhook(index) {
    const webhooks = notificationStatus.webhooks?.urls || [];
    webhooks.splice(index, 1);
    document.getElementById('webhook-urls').value = webhooks.join('\n');
    updateWebhookConfig();
}

// Update Telegram configuration (placeholder - would need backend endpoint)
function updateTelegramConfig() {
    addLog('info', 'Telegram configuration update would be implemented here');
    showAlert('info', 'Telegram configuration update feature coming soon');
}

// Show alert function
function showAlert(type, message) {
    if (window.showAlert) {
        window.showAlert(type, message);
    } else {
        alert(message);
    }
}
</script>
{% endblock %} 